<section class="activity-page">
  <!-- Aurora Background -->
  <div class="aurora-bg" aria-hidden="true">
    <div class="aurora-wave aurora-wave-1"></div>
    <div class="aurora-wave aurora-wave-2"></div>
    <div class="aurora-wave aurora-wave-3"></div>
  </div>

  <!-- Compact Header - Solo móvil (< 768px) -->
  @if (isMovil()) {
    <header class="activity-header header-glass">
      <div class="header-content">
        <div class="header-left">
          <button
            type="button"
            class="back-btn"
            aria-label="Volver al inicio"
            (click)="volverInicio()"
          >
            <span class="material-symbols-outlined">arrow_back</span>
          </button>
          <div class="header-title-group">
            <h1 class="titulo-kengo header-title">Mi Actividad</h1>
            <p class="header-subtitle">{{ fechaHoy() }}</p>
          </div>
        </div>
        @if (hayActividadHoy() && !todoCompletado() && totalPendientes() > 0) {
          <button
            type="button"
            class="header-cta"
            (click)="iniciarSesionHoy()"
            aria-label="Comenzar actividad"
          >
            <span class="material-symbols-outlined icon-filled">play_arrow</span>
          </button>
        }
      </div>
    </header>
  }

  <!-- Main Content -->
  <main class="activity-main" [class.pt-desktop]="!isMovil()">
    <!-- Loading State -->
    @if (cargando()) {
      <div class="state-card loading-state">
        <div class="shimmer-effect"></div>
        <div class="state-icon pulse">
          <span class="material-symbols-outlined">fitness_center</span>
        </div>
        <p class="state-text">Cargando tu actividad...</p>
      </div>
    }

    <!-- Error State -->
    @if (error()) {
      <div class="state-card error-state animate-in">
        <div class="state-icon error">
          <span class="material-symbols-outlined">error</span>
        </div>
        <h2 class="state-title">Algo salió mal</h2>
        <p class="state-text">{{ error() }}</p>
        <button type="button" class="retry-btn" (click)="cargarDatos()">
          <span class="material-symbols-outlined">refresh</span>
          Reintentar
        </button>
      </div>
    }

    <!-- Sin planes activos -->
    @if (sinPlanesActivos()) {
      <div class="state-card empty-state animate-in">
        <div class="state-visual">
          <div class="empty-illustration">
            <span class="material-symbols-outlined main-icon">calendar_today</span>
            <span class="material-symbols-outlined accent-icon">add</span>
          </div>
        </div>
        <h2 class="state-title">Sin planes activos</h2>
        <p class="state-text">
          No tienes planes de ejercicios asignados actualmente.
        </p>
        <p class="state-hint">
          Contacta con tu fisioterapeuta para que te asigne un plan personalizado.
        </p>
      </div>
    }

    <!-- Contenido principal -->
    @if (!cargando() && !error() && !sinPlanesActivos()) {
      <!-- Layout Desktop: 2 columnas -->
      <div class="content-grid">
        <!-- Columna principal -->
        <div class="main-column">
          <!-- Hero Card: Estado del día -->
          @if (todoCompletado()) {
            <article class="hero-card completed animate-in">
              <div class="hero-visual">
                <div class="hero-gradient success"></div>
                <div class="celebration-particles" aria-hidden="true">
                  <span></span><span></span><span></span><span></span><span></span>
                </div>
              </div>
              <div class="hero-content">
                <div class="hero-icon success">
                  <span class="material-symbols-outlined icon-filled">celebration</span>
                </div>
                <div class="hero-info">
                  <h2 class="hero-title">¡Felicidades!</h2>
                  <p class="hero-subtitle">Has completado todos los ejercicios de hoy</p>
                </div>
              </div>
              <div class="hero-stats">
                <div class="stat-item">
                  <span class="stat-value">{{ progresoTotal().completados }}</span>
                  <span class="stat-label">Completados</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                  <span class="stat-value">100%</span>
                  <span class="stat-label">Progreso</span>
                </div>
              </div>
            </article>
          } @else if (!hayActividadHoy()) {
            <article class="hero-card rest animate-in">
              <div class="hero-visual">
                <div class="hero-gradient rest"></div>
              </div>
              <div class="hero-content">
                <div class="hero-icon rest">
                  <span class="material-symbols-outlined">self_improvement</span>
                </div>
                <div class="hero-info">
                  <h2 class="hero-title">Día de descanso</h2>
                  <p class="hero-subtitle">No tienes ejercicios programados para hoy</p>
                </div>
              </div>
            </article>
          } @else {
            <!-- Hero Card: Actividad pendiente -->
            <article class="hero-card active animate-in">
              <div class="hero-visual">
                <div class="hero-gradient active"></div>
                <div class="hero-pattern" aria-hidden="true"></div>
              </div>
              <div class="hero-content">
                <div class="hero-badge pending">
                  <span class="badge-count">{{ totalPendientes() }}</span>
                  <span class="badge-label">pendiente{{ totalPendientes() !== 1 ? 's' : '' }}</span>
                </div>
                <div class="hero-info">
                  <h2 class="hero-title">Tu actividad de hoy</h2>
                  @if (actividadHoy().length === 1) {
                    <p class="hero-subtitle">{{ actividadHoy()[0].plan.titulo }}</p>
                  } @else {
                    <p class="hero-subtitle">{{ actividadHoy().length }} planes con ejercicios</p>
                  }
                </div>
              </div>

              <!-- Progress Bar -->
              <div class="hero-progress">
                <div class="progress-track">
                  <div
                    class="progress-fill"
                    [style.width.%]="progresoTotal().total > 0
                      ? (progresoTotal().completados / progresoTotal().total) * 100
                      : 0"
                  ></div>
                </div>
                <span class="progress-text">
                  {{ progresoTotal().completados }}/{{ progresoTotal().total }} ejercicios
                </span>
              </div>

              <!-- CTA Button -->
              <button
                type="button"
                class="hero-cta"
                (click)="iniciarSesionHoy()"
              >
                <span class="material-symbols-outlined icon-filled">play_arrow</span>
                <span class="cta-text">
                  @if (progresoTotal().completados > 0) {
                    Continuar sesión
                  } @else {
                    Comenzar sesión
                  }
                </span>
                @if (actividadHoy().length > 1) {
                  <span class="cta-badge">{{ actividadHoy().length }} planes</span>
                }
              </button>
            </article>
          }

          <!-- Planes del día -->
          @if (actividadHoy().length > 0 && hayActividadHoy()) {
            <section class="plans-section animate-in" style="--delay: 0.1s">
              <header class="section-header">
                <h2 class="section-title">Ejercicios de hoy</h2>
                @if (actividadHoy().length > 1) {
                  <span class="section-badge">{{ actividadHoy().length }} planes</span>
                }
              </header>

              <div class="plans-list">
                @for (actividad of actividadHoy(); track actividad.plan.id_plan; let i = $index) {
                  @if (actividad.ejerciciosHoy.length > 0) {
                    <article
                      class="plan-card animate-in"
                      [style.--delay]="(0.15 + i * 0.05) + 's'"
                      [class.completed]="actividad.progreso === 100"
                    >
                      <!-- Plan Header -->
                      <header class="plan-header">
                        <div class="plan-info">
                          <h3 class="plan-title">{{ actividad.plan.titulo }}</h3>
                          <div class="plan-progress">
                            <div class="progress-bar">
                              <div
                                class="progress-value"
                                [class.complete]="actividad.progreso === 100"
                                [style.width.%]="actividad.progreso"
                              ></div>
                            </div>
                            <span class="progress-label">
                              {{ actividad.completados }}/{{ actividad.totalEjercicios }}
                            </span>
                          </div>
                        </div>
                        @if (actividad.progreso === 100) {
                          <div class="plan-badge complete">
                            <span class="material-symbols-outlined icon-filled">check_circle</span>
                          </div>
                        }
                      </header>

                      <!-- Exercises List -->
                      <ul class="exercises-list">
                        @for (ejercicio of actividad.ejerciciosHoy; track ejercicio.id) {
                          <li
                            class="exercise-item"
                            [class.completed]="ejercicio.completadoHoy"
                          >
                            <!-- Status Indicator -->
                            <div class="exercise-status">
                              @if (ejercicio.completadoHoy) {
                                <div class="status-check">
                                  <span class="material-symbols-outlined icon-filled">check</span>
                                </div>
                              } @else {
                                <div class="status-pending"></div>
                              }
                            </div>

                            <!-- Exercise Image -->
                            <div class="exercise-thumb">
                              @if (ejercicio.ejercicio.portada) {
                                <img
                                  [src]="getAssetUrl(ejercicio.ejercicio.portada)"
                                  [alt]="ejercicio.ejercicio.nombre_ejercicio"
                                  loading="lazy"
                                />
                              } @else {
                                <div class="thumb-placeholder">
                                  <span class="material-symbols-outlined">fitness_center</span>
                                </div>
                              }
                            </div>

                            <!-- Exercise Info -->
                            <div class="exercise-info">
                              <span class="exercise-name">
                                {{ ejercicio.ejercicio.nombre_ejercicio }}
                              </span>
                              <span class="exercise-details">
                                {{ ejercicio.series ?? 3 }} series ×
                                @if (ejercicio.duracion_seg) {
                                  {{ ejercicio.duracion_seg }}s
                                } @else {
                                  {{ ejercicio.repeticiones ?? 12 }} reps
                                }
                                @if ((ejercicio.veces_dia ?? 1) > 1) {
                                  <span class="detail-separator">·</span>
                                  {{ ejercicio.vecesCompletadasHoy ?? 0 }}/{{ ejercicio.veces_dia }}× día
                                }
                              </span>
                            </div>
                          </li>
                        }
                      </ul>

                      <!-- Plan Action -->
                      <footer class="plan-footer">
                        <button
                          type="button"
                          class="plan-action"
                          [class.secondary]="actividad.progreso === 100"
                          (click)="irAPlan(actividad.plan.id_plan)"
                        >
                          @if (actividad.progreso === 100) {
                            <span class="material-symbols-outlined">replay</span>
                            Repetir sesión
                          } @else if (actividad.completados > 0) {
                            <span class="material-symbols-outlined icon-filled">play_arrow</span>
                            Continuar
                          } @else {
                            <span class="material-symbols-outlined icon-filled">play_arrow</span>
                            Comenzar
                          }
                        </button>
                      </footer>
                    </article>
                  }
                }
              </div>
            </section>
          }
        </div>

        <!-- Columna lateral: Próximos días -->
        @if (proximosDias().length > 0) {
          <aside class="sidebar-column">
            <section class="upcoming-section animate-in" style="--delay: 0.2s">
              <header class="section-header sticky">
                <div class="section-icon">
                  <span class="material-symbols-outlined">calendar_month</span>
                </div>
                <div>
                  <h2 class="section-title">Próximos días</h2>
                  <p class="section-subtitle">Tu agenda de ejercicios</p>
                </div>
              </header>

              <div class="upcoming-list">
                @for (dia of proximosDias(); track dia.fecha.toISOString(); let i = $index) {
                  <article
                    class="day-card animate-in"
                    [style.--delay]="(0.25 + i * 0.03) + 's'"
                    [class.expanded]="esDiaExpandido(dia.fecha)"
                  >
                    <!-- Day Header (clickable) -->
                    <button
                      type="button"
                      class="day-header"
                      (click)="toggleDia(dia.fecha)"
                    >
                      <div class="day-date">
                        <span class="day-name">{{ dia.diaSemana }}</span>
                        <span class="day-number">{{ dia.fechaFormateada }}</span>
                      </div>
                      <div class="day-summary">
                        <span class="exercise-count">
                          {{ dia.totalEjercicios }}
                          <span class="count-label">ejercicio{{ dia.totalEjercicios !== 1 ? 's' : '' }}</span>
                        </span>
                        @if (dia.planes.length > 1) {
                          <span class="plans-count">{{ dia.planes.length }} planes</span>
                        }
                      </div>
                      <span
                        class="material-symbols-outlined expand-icon"
                        [class.rotated]="esDiaExpandido(dia.fecha)"
                      >expand_more</span>
                    </button>

                    <!-- Expanded Content -->
                    @if (esDiaExpandido(dia.fecha)) {
                      <div class="day-content">
                        <ul class="day-exercises">
                          @for (ejercicio of dia.ejercicios; track $index) {
                            <li class="day-exercise-item">
                              <div class="day-exercise-thumb">
                                @if (ejercicio.portada) {
                                  <img
                                    [src]="getAssetUrl(ejercicio.portada)"
                                    [alt]="ejercicio.nombre"
                                    loading="lazy"
                                  />
                                } @else {
                                  <div class="thumb-placeholder small">
                                    <span class="material-symbols-outlined">fitness_center</span>
                                  </div>
                                }
                              </div>
                              <div class="day-exercise-info">
                                <span class="day-exercise-name">{{ ejercicio.nombre }}</span>
                                <span class="day-exercise-details">
                                  {{ ejercicio.series }} series ×
                                  @if (ejercicio.duracion_seg) {
                                    {{ ejercicio.duracion_seg }}s
                                  } @else {
                                    {{ ejercicio.repeticiones ?? 12 }} reps
                                  }
                                  @if (dia.planes.length > 1) {
                                    <span class="plan-tag">{{ ejercicio.planTitulo }}</span>
                                  }
                                </span>
                              </div>
                            </li>
                          }
                        </ul>

                        <!-- Start Session Button -->
                        <button
                          type="button"
                          class="day-action"
                          (click)="iniciarSesionDia(dia)"
                        >
                          <span class="material-symbols-outlined icon-filled">play_arrow</span>
                          Comenzar sesión
                          @if (dia.planes.length > 1) {
                            <span class="action-badge">{{ dia.planes.length }} planes</span>
                          }
                        </button>
                      </div>
                    }
                  </article>
                }
              </div>
            </section>
          </aside>
        }
      </div>
    }
  </main>
</section>
