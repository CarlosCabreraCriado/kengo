<section
  class="absolute top-0 left-0 flex h-dvh w-screen items-center justify-center px-2"
>
  <div
    class="flex w-full max-w-lg flex-col justify-center rounded-2xl border-white/20 bg-white/60 px-6 py-5 shadow-xl backdrop-blur-md backdrop-filter"
  >
    <div class="baseline-end relative flex h-15 w-full items-end justify-center">
      <img src="../../assets/logo.svg" class="relative h-[175%]" alt="Kengo logo" />
    </div>

    <div class="fuente-kengo mb-4 w-full text-center text-3xl">Registro</div>

    <!-- Error global -->
    @if (error()) {
      <div class="mb-4 rounded-lg bg-red-50 border border-red-200 p-3 text-sm text-red-700">
        {{ error() }}
      </div>
    }

    <ui-stepper #stepper [selectedIndex]="currentStep()" [linear]="true" (selectionChange)="onStepChange($event)">
      <!-- Paso 1: Datos -->
      <ui-step label="Datos">
        <form [formGroup]="datosForm" class="flex flex-col gap-4 pt-4">
          <div class="flex flex-col gap-1.5">
            <label for="nombre" class="text-sm font-medium text-gray-700">
              Nombre <span class="text-red-500">*</span>
            </label>
            <input
              id="nombre"
              type="text"
              formControlName="nombre"
              class="w-full rounded-xl border bg-white px-3 py-2.5 text-base transition-all focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
              [class.border-red-500]="nombreInvalid"
              [class.border-gray-300]="!nombreInvalid"
            />
            @if (nombreInvalid) {
              <span class="text-xs text-red-600">El nombre es requerido</span>
            }
          </div>

          <div class="flex flex-col gap-1.5">
            <label for="apellidos" class="text-sm font-medium text-gray-700">
              Apellidos <span class="text-red-500">*</span>
            </label>
            <input
              id="apellidos"
              type="text"
              formControlName="apellidos"
              class="w-full rounded-xl border bg-white px-3 py-2.5 text-base transition-all focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
              [class.border-red-500]="apellidosInvalid"
              [class.border-gray-300]="!apellidosInvalid"
            />
            @if (apellidosInvalid) {
              <span class="text-xs text-red-600">Los apellidos son requeridos</span>
            }
          </div>

          <div class="flex flex-col gap-1.5">
            <label for="email" class="text-sm font-medium text-gray-700">
              Email <span class="text-red-500">*</span>
            </label>
            <input
              id="email"
              type="email"
              formControlName="email"
              class="w-full rounded-xl border bg-white px-3 py-2.5 text-base transition-all focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
              [class.border-red-500]="emailInvalid"
              [class.border-gray-300]="!emailInvalid"
            />
            @if (emailError) {
              <span class="text-xs text-red-600">{{ emailError }}</span>
            }
          </div>

          <div class="mt-2 flex justify-end">
            <button
              type="button"
              (click)="nextStep()"
              [disabled]="!datosForm.valid"
              class="flex h-10 items-center gap-1 rounded-xl bg-primary px-4 text-sm font-semibold text-white transition-colors hover:bg-primary/90 disabled:cursor-not-allowed disabled:opacity-50"
            >
              Siguiente
              <span class="material-symbols-outlined text-lg">arrow_forward</span>
            </button>
          </div>
        </form>
      </ui-step>

      <!-- Paso 2: Tipo de usuario -->
      <ui-step label="Tipo">
        <form [formGroup]="tipoUsuarioForm" class="flex flex-col gap-4 pt-4">
          <fieldset class="flex flex-col gap-3">
            <legend class="mb-2 text-sm font-medium text-gray-700">
              Selecciona tu rol <span class="text-red-500">*</span>
            </legend>

            <label class="flex cursor-pointer items-center gap-3 rounded-xl border border-gray-200 bg-white p-4 transition-all hover:border-primary/30"
                   [class.border-primary]="tipoUsuarioForm.value.tipo === 'fisioterapeuta'"
                   [class.bg-primary/5]="tipoUsuarioForm.value.tipo === 'fisioterapeuta'">
              <input
                type="radio"
                formControlName="tipo"
                value="fisioterapeuta"
                class="sr-only"
              />
              <div class="flex h-5 w-5 items-center justify-center rounded-full border-2 border-gray-300"
                   [class.border-primary]="tipoUsuarioForm.value.tipo === 'fisioterapeuta'">
                @if (tipoUsuarioForm.value.tipo === 'fisioterapeuta') {
                  <div class="h-2.5 w-2.5 rounded-full bg-primary"></div>
                }
              </div>
              <div class="flex flex-col">
                <span class="font-medium text-gray-900">Fisioterapeuta</span>
                <span class="text-sm text-gray-500">Gestiona pacientes y planes de tratamiento</span>
              </div>
            </label>

            <label class="flex cursor-pointer items-center gap-3 rounded-xl border border-gray-200 bg-white p-4 transition-all hover:border-primary/30"
                   [class.border-primary]="tipoUsuarioForm.value.tipo === 'paciente'"
                   [class.bg-primary/5]="tipoUsuarioForm.value.tipo === 'paciente'">
              <input
                type="radio"
                formControlName="tipo"
                value="paciente"
                class="sr-only"
              />
              <div class="flex h-5 w-5 items-center justify-center rounded-full border-2 border-gray-300"
                   [class.border-primary]="tipoUsuarioForm.value.tipo === 'paciente'">
                @if (tipoUsuarioForm.value.tipo === 'paciente') {
                  <div class="h-2.5 w-2.5 rounded-full bg-primary"></div>
                }
              </div>
              <div class="flex flex-col">
                <span class="font-medium text-gray-900">Paciente</span>
                <span class="text-sm text-gray-500">Realiza ejercicios y sigue tu progreso</span>
              </div>
            </label>
          </fieldset>

          <div class="mt-2 flex justify-between">
            <button
              type="button"
              (click)="previousStep()"
              class="flex h-10 items-center gap-1 rounded-xl border border-gray-300 bg-white px-4 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50"
            >
              <span class="material-symbols-outlined text-lg">arrow_back</span>
              Anterior
            </button>
            <button
              type="button"
              (click)="nextStep()"
              [disabled]="!tipoUsuarioForm.valid"
              class="flex h-10 items-center gap-1 rounded-xl bg-primary px-4 text-sm font-semibold text-white transition-colors hover:bg-primary/90 disabled:cursor-not-allowed disabled:opacity-50"
            >
              Siguiente
              <span class="material-symbols-outlined text-lg">arrow_forward</span>
            </button>
          </div>
        </form>
      </ui-step>

      <!-- Paso 3: Codigo clinica -->
      <ui-step label="Codigo" [optional]="true">
        <form [formGroup]="codigoClinicaForm" class="flex flex-col gap-4 pt-4">
          <div class="flex flex-col gap-1.5">
            <label for="codigo" class="text-sm font-medium text-gray-700">Codigo de clinica (opcional)</label>
            <input
              id="codigo"
              type="text"
              formControlName="codigo"
              placeholder="Ingresa el codigo si te lo proporcionaron"
              class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2.5 text-base transition-all focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
            />
            <p class="text-xs text-gray-500">Si tu fisioterapeuta te dio un codigo, ingresalo aqui</p>
          </div>

          <div class="mt-2 flex justify-between">
            <button
              type="button"
              (click)="previousStep()"
              class="flex h-10 items-center gap-1 rounded-xl border border-gray-300 bg-white px-4 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50"
            >
              <span class="material-symbols-outlined text-lg">arrow_back</span>
              Anterior
            </button>
            <button
              type="button"
              (click)="nextStep()"
              class="flex h-10 items-center gap-1 rounded-xl bg-primary px-4 text-sm font-semibold text-white transition-colors hover:bg-primary/90"
            >
              Siguiente
              <span class="material-symbols-outlined text-lg">arrow_forward</span>
            </button>
          </div>
        </form>
      </ui-step>

      <!-- Paso 4: Contrasena -->
      <ui-step label="Seguridad">
        <form [formGroup]="passwordForm" class="flex flex-col gap-4 pt-4">
          <div class="flex flex-col gap-1.5">
            <label for="password" class="text-sm font-medium text-gray-700">
              Contrasena <span class="text-red-500">*</span>
            </label>
            <input
              id="password"
              type="password"
              formControlName="password"
              class="w-full rounded-xl border bg-white px-3 py-2.5 text-base transition-all focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
              [class.border-red-500]="passwordInvalid"
              [class.border-gray-300]="!passwordInvalid"
            />
            @if (passwordError) {
              <span class="text-xs text-red-600">{{ passwordError }}</span>
            }
          </div>

          <div class="flex flex-col gap-1.5">
            <label for="repetir" class="text-sm font-medium text-gray-700">
              Repetir contrasena <span class="text-red-500">*</span>
            </label>
            <input
              id="repetir"
              type="password"
              formControlName="repetir"
              class="w-full rounded-xl border bg-white px-3 py-2.5 text-base transition-all focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
              [class.border-red-500]="repetirInvalid || (!passwordsMatch && passwordForm.get('repetir')?.touched)"
              [class.border-gray-300]="!repetirInvalid && (passwordsMatch || !passwordForm.get('repetir')?.touched)"
            />
            @if (!passwordsMatch && passwordForm.get('repetir')?.touched) {
              <span class="text-xs text-red-600">Las contrasenas no coinciden</span>
            }
          </div>

          <div class="mt-2 flex justify-between">
            <button
              type="button"
              (click)="previousStep()"
              [disabled]="isLoading()"
              class="flex h-10 items-center gap-1 rounded-xl border border-gray-300 bg-white px-4 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"
            >
              <span class="material-symbols-outlined text-lg">arrow_back</span>
              Anterior
            </button>
            <button
              type="button"
              [disabled]="!passwordForm.valid || !passwordsMatch || isLoading()"
              (click)="completarRegistro()"
              class="flex h-10 items-center gap-1 rounded-xl bg-primary px-4 text-sm font-semibold text-white transition-colors hover:bg-primary/90 disabled:cursor-not-allowed disabled:opacity-50"
            >
              @if (isLoading()) {
                <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Registrando...
              } @else {
                <span class="material-symbols-outlined text-lg">check</span>
                Finalizar
              }
            </button>
          </div>
        </form>
      </ui-step>
    </ui-stepper>

    <a
      class="mt-4 block text-center text-sm font-medium text-primary underline underline-offset-2 transition-colors hover:text-primary/80"
      routerLink="/login"
    >
      Ya tengo cuenta
    </a>
  </div>
</section>
