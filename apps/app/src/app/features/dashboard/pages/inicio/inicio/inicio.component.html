<section class="dashboard-page">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <!-- MÓVIL: Logo + Avatar -->
      @if (isMovil()) {
        <img [src]="logoUrl()" alt="Kengo" class="logo" (error)="onLogoError()" />
      } @else {
        <!-- DESKTOP: Saludo con avatar grande -->
        <div class="greeting-section">
          <div class="user-avatar-large">
            @if (userAvatar()) {
              <img [src]="userAvatar()" alt="Avatar" />
            } @else {
              <span class="material-symbols-outlined">person</span>
            }
          </div>
          <div class="greeting-text">
            <h1 class="titulo-kengo greeting-name">Hola, {{ userName() }}</h1>
            <p class="greeting-subtitle">¿Qué quieres hacer hoy?</p>
          </div>
        </div>

      }

      <!-- Avatar con menú desplegable (solo móvil) -->
      @if (isMovil()) {
        <div class="avatar-menu-container">
          <button
            type="button"
            class="avatar-btn"
            [class.menu-open]="menuAbierto()"
            (click)="toggleMenu()"
            aria-label="Abrir menú de usuario"
            [attr.aria-expanded]="menuAbierto()"
          >
            @if (userAvatar()) {
              <img [src]="userAvatar()" alt="Avatar" class="avatar-img" />
            } @else {
              <span class="material-symbols-outlined">person</span>
            }
          </button>

          <!-- Menú desplegable -->
          @if (menuAbierto()) {
            <div class="user-menu" role="menu">
              <button
                type="button"
                class="menu-item"
                role="menuitem"
                (click)="irAPerfil()"
              >
                <span class="material-symbols-outlined">person</span>
                <span>Mi perfil</span>
              </button>
              <button
                type="button"
                class="menu-item menu-item-danger"
                role="menuitem"
                (click)="cerrarSesion()"
              >
                <span class="material-symbols-outlined">logout</span>
                <span>Cerrar sesión</span>
              </button>
            </div>

            <!-- Backdrop para cerrar el menú -->
            <div
              class="menu-backdrop"
              (click)="cerrarMenu()"
              aria-hidden="true"
            ></div>
          }
        </div>
      }
    </div>
  </header>

  <!-- Main Content -->
  <main class="dashboard-main">
    <!-- Tarjeta de saludo (solo móvil) -->
    @if (isMovil()) {
      <section class="greeting-card animate-in">
        <div class="greeting-card-content">
          <h2 class="titulo-kengo greeting-title">Hola, {{ userName() }}</h2>
          <p class="greeting-message">¿Listo para tu entrenamiento?</p>
        </div>
        <div class="greeting-decoration" aria-hidden="true">
          <img src="assets/bonsai.png" alt="" class="bonsai-small" />
        </div>
      </section>
    }

    <!-- Activity Card (Featured) -->
    @for (card of cards(); track card.id) {
      @if (card.id === 'actividad-personal') {
        <article
          class="activity-hero animate-in"
          [attr.data-state]="getCardBadgeType(card) || 'loading'"
          style="--delay: 0.05s"
          (click)="navigateToCard(card)"
        >
          <!-- Background Effect -->
          <div class="activity-bg">
            <div class="activity-wave activity-wave-1"></div>
            <div class="activity-wave activity-wave-2"></div>
            <img src="assets/bonsai.png" alt="" class="bonsai-hero" aria-hidden="true" />
          </div>

          <!-- Badge -->
          <div class="activity-badge" [attr.data-type]="getCardBadgeType(card)">
            @switch (getCardBadgeType(card)) {
              @case ('loading') {
                <div class="badge-spinner"></div>
              }
              @case ('pending') {
                <span class="badge-number">{{ getCardBadgeCount(card) }}</span>
                <span class="badge-label">pendiente{{ getCardBadgeCount(card) !== 1 ? 's' : '' }}</span>
              }
              @case ('completed') {
                <span class="material-symbols-outlined icon-filled">check_circle</span>
              }
              @case ('rest') {
                <span class="material-symbols-outlined">self_improvement</span>
              }
            }
          </div>

          <!-- Content -->
          <div class="activity-content">
            <div class="activity-info">
              <h3 class="activity-title">{{ card.title }}</h3>
              <p class="activity-subtitle">{{ getCardSubtitle(card) }}</p>
            </div>

            @if (getCardProgreso(card); as progreso) {
              @if (progreso.total > 0) {
                <!-- Progress -->
                <div class="activity-progress">
                  <div class="progress-track">
                    <div
                      class="progress-fill"
                      [style.width.%]="(progreso.completados / progreso.total) * 100"
                    ></div>
                  </div>
                  <span class="progress-text">
                    {{ progreso.completados }}/{{ progreso.total }} ejercicios
                  </span>
                </div>

                <!-- Next Exercise -->
                @if (getCardSiguienteEjercicio(card); as siguiente) {
                  <div class="next-exercise">
                    <span class="material-symbols-outlined icon-filled">play_circle</span>
                    <span>Siguiente: {{ siguiente }}</span>
                  </div>
                }

                <!-- CTA -->
                @if (progreso.completados < progreso.total) {
                  <button
                    type="button"
                    class="activity-cta"
                    (click)="navigateToCard(card); $event.stopPropagation()"
                  >
                    <span class="material-symbols-outlined icon-filled">play_arrow</span>
                    <span>{{ progreso.completados > 0 ? 'Continuar' : 'Empezar' }} sesión</span>
                  </button>
                } @else {
                  <div class="activity-completed">
                    <span class="material-symbols-outlined icon-filled">celebration</span>
                    <span>¡Buen trabajo hoy!</span>
                  </div>
                }
              }
            }
          </div>
        </article>
      }
    }

    <!-- Quick Actions Grid -->
    <section class="actions-section animate-in" style="--delay: 0.1s">
      <h2 class="section-title">Accesos rápidos</h2>
      <div class="actions-grid">
        @for (card of cards(); track card.id; let i = $index) {
          @if (card.id !== 'actividad-personal') {
            <article
              class="action-card animate-in"
              [style.--delay]="(0.15 + i * 0.03) + 's'"
              (click)="navigateToCard(card)"
            >
              <div class="action-image">
                <img
                  [src]="card.image"
                  [alt]="card.title"
                  loading="lazy"
                />
              </div>
              <div class="action-content">
                <h3 class="titulo-kengo action-title">{{ card.title }}</h3>
                <p class="action-subtitle">{{ card.subtitle }}</p>
              </div>
              <div class="action-arrow">
                <span class="material-symbols-outlined">arrow_forward</span>
              </div>
            </article>
          }
        }
      </div>
    </section>
  </main>

  <!-- Vista carrusel móvil (layout alternativo, oculto) -->
  @if (false && isMovil()) {
    <div class="carousel-wrapper">
      <div #carousel class="carousel">
        @for (card of cards(); track card.id; let i = $index) {
          <article
            class="carousel-card"
            [class.active]="currentIndex() === i"
            (click)="navigateToCard(card)"
          >
            <img [src]="card.image" [alt]="card.title" class="carousel-image" />
            <div class="carousel-overlay"></div>
            <div class="carousel-content">
              <h2 class="titulo-kengo carousel-title">{{ card.title }}</h2>
              <p class="carousel-subtitle">{{ card.subtitle }}</p>
            </div>
          </article>
        }
      </div>
      <nav class="pagination-dots">
        @for (card of cards(); track card.id; let i = $index) {
          <button
            type="button"
            class="dot"
            [class.active]="currentIndex() === i"
            (click)="scrollToCard(i)"
          ></button>
        }
      </nav>
    </div>
  }
</section>
