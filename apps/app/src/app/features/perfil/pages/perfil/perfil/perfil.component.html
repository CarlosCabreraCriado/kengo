<section class="profile-page">
  <!-- Aurora Background -->
  <div class="aurora-bg" aria-hidden="true">
    <div class="aurora-wave aurora-wave-1"></div>
    <div class="aurora-wave aurora-wave-2"></div>
    <div class="aurora-wave aurora-wave-3"></div>
  </div>

  <!-- Header responsivo alineado con navegación -->
  <header class="header-glass sticky top-0 z-50 shrink-0 px-4 pt-3 pb-4">
    <div class="mx-auto max-w-2xl">

      <!-- MÓVIL: Header con título y navegación -->
      @if (isMobile()) {
        <div class="flex items-center gap-3">
          <a
            routerLink="/inicio"
            class="flex h-10 w-10 items-center justify-center rounded-xl
                   bg-white/60 backdrop-blur-md border border-white/40
                   text-zinc-600 transition-all duration-200
                   hover:bg-white/80 hover:scale-105 active:scale-95"
            aria-label="Volver al inicio"
          >
            <span class="material-symbols-outlined text-xl">arrow_back</span>
          </a>
          <div>
            <h1 class="titulo-kengo text-2xl text-[#e75c3e]">Mi Perfil</h1>
            <p class="text-xs font-medium text-zinc-500">Gestiona tu cuenta</p>
          </div>
        </div>
      }

    </div>
  </header>

  <!-- Main Content -->
  <main class="profile-main">
    <!-- Loading State -->
    @if (!formularioInicializado()) {
      <div class="state-card loading-state">
        <div class="shimmer-effect"></div>
        <div class="state-icon pulse">
          <span class="material-symbols-outlined">person</span>
        </div>
        <p class="state-text">Cargando perfil...</p>
      </div>
    } @else {
      <!-- Hero Card with Avatar -->
      <article class="hero-card animate-in">
        <div class="hero-visual">
          <div class="hero-gradient"></div>
          <div class="hero-pattern" aria-hidden="true"></div>

          <!-- Botón guardar en la esquina superior derecha -->
          <button
            type="button"
            class="absolute top-3 right-3 flex items-center gap-1.5 rounded-full px-3 py-2
                   transition-all duration-200 active:scale-95 z-10"
            [class]="formularioCambiado()
              ? 'bg-white text-[#e75c3e] shadow-lg hover:bg-white/90'
              : 'bg-white/30 backdrop-blur-md text-white/70 cursor-default'"
            [disabled]="!formularioCambiado() || formularioUsuario.invalid"
            (click)="guardarCambios()"
            aria-label="Guardar cambios"
          >
            <span class="material-symbols-outlined text-lg">{{ formularioCambiado() ? 'save' : 'check' }}</span>
            <span class="text-xs font-semibold">{{ formularioCambiado() ? 'Guardar' : 'Guardado' }}</span>
          </button>
        </div>

        <div class="hero-content">
          <!-- Avatar -->
          <button
            type="button"
            class="avatar-container"
            (click)="cambiarFotoPerfil()"
            [disabled]="subiendoAvatar()"
            aria-label="Cambiar foto de perfil"
          >
            @if (previewUrl() ?? url_perfil()) {
              <img
                [src]="previewUrl() ?? url_perfil()!"
                alt="Foto de perfil"
                class="avatar-image"
              />
            } @else {
              <div class="avatar-placeholder">
                <span class="material-symbols-outlined icon-filled">person</span>
              </div>
            }

            <!-- Camera overlay -->
            <div class="avatar-overlay">
              <span class="material-symbols-outlined">photo_camera</span>
            </div>

            <!-- Upload spinner -->
            @if (subiendoAvatar()) {
              <div class="avatar-loading">
                <div class="avatar-spinner"></div>
              </div>
            }

            <input
              #fileInput
              type="file"
              accept="image/*"
              class="hidden"
              (change)="onArchivoSeleccionado($event)"
            />
          </button>

          <!-- User Info -->
          <div class="hero-info">
            <h2 class="user-name">{{ usuario()?.first_name }} {{ usuario()?.last_name }}</h2>
            <p class="user-email">{{ usuario()?.email }}</p>
            @if (esFisio()) {
              <span class="role-badge">
                <span class="material-symbols-outlined icon-filled">verified</span>
                Fisioterapeuta
              </span>
            }
          </div>
        </div>
      </article>

      <!-- Quick Actions -->
      <section class="quick-actions animate-in" style="--delay: 0.1s">
        <button type="button" class="quick-action primary" (click)="scrollToSection('personal')">
          <div class="action-icon">
            <span class="material-symbols-outlined icon-filled">edit</span>
          </div>
          <span class="action-label">Editar</span>
        </button>
        <button type="button" class="quick-action secondary" (click)="scrollToSection('security')">
          <div class="action-icon">
            <span class="material-symbols-outlined">lock</span>
          </div>
          <span class="action-label">Seguridad</span>
        </button>
        <button type="button" class="quick-action tertiary" (click)="abrirPrivacyPolicy()">
          <div class="action-icon">
            <span class="material-symbols-outlined">policy</span>
          </div>
          <span class="action-label">Privacidad</span>
        </button>
        <button type="button" class="quick-action neutral" (click)="abrirTermsConditions()">
          <div class="action-icon">
            <span class="material-symbols-outlined">gavel</span>
          </div>
          <span class="action-label">Términos</span>
        </button>
      </section>

      <!-- Personal Data Section -->
      <section
        #personalSection
        class="data-section animate-in"
        style="--delay: 0.15s"
        [class.expanded]="personalExpanded()"
      >
        <header class="section-header" (click)="togglePersonal()">
          <div class="section-title-group">
            <div class="section-icon">
              <span class="material-symbols-outlined icon-filled">person</span>
            </div>
            <div>
              <h3 class="section-title">Datos Personales</h3>
              <p class="section-subtitle">Información de tu cuenta</p>
            </div>
          </div>
          <span class="material-symbols-outlined expand-icon" [class.rotated]="personalExpanded()">expand_more</span>
        </header>

        @if (personalExpanded()) {
          <div class="section-content" [formGroup]="formularioUsuario">
            <!-- Name fields in grid -->
            <div class="form-grid">
              <div class="form-field">
                <label class="field-label">Nombre</label>
                <div class="input-wrapper">
                  <span class="material-symbols-outlined input-icon">badge</span>
                  <input
                    type="text"
                    formControlName="first_name"
                    class="field-input"
                    placeholder="Tu nombre"
                  />
                </div>
              </div>

              <div class="form-field">
                <label class="field-label">Apellidos</label>
                <div class="input-wrapper">
                  <span class="material-symbols-outlined input-icon">badge</span>
                  <input
                    type="text"
                    formControlName="last_name"
                    class="field-input"
                    placeholder="Tus apellidos"
                  />
                </div>
              </div>
            </div>

            <!-- Contact fields -->
            <div class="form-grid">
              <div class="form-field">
                <label class="field-label">Teléfono</label>
                <div class="input-wrapper">
                  <span class="material-symbols-outlined input-icon">phone</span>
                  <input
                    type="tel"
                    formControlName="telefono"
                    class="field-input"
                    placeholder="+34 600 000 000"
                  />
                </div>
              </div>

              <div class="form-field">
                <label class="field-label">Email</label>
                <div class="input-wrapper locked">
                  <span class="material-symbols-outlined input-icon">mail</span>
                  <input
                    type="email"
                    formControlName="email"
                    class="field-input"
                    placeholder="tu@email.com"
                  />
                  <span class="material-symbols-outlined lock-icon">lock</span>
                </div>
              </div>
            </div>

            <!-- Address fields -->
            <div class="form-field full-width">
              <label class="field-label">Dirección</label>
              <div class="input-wrapper">
                <span class="material-symbols-outlined input-icon">location_on</span>
                <input
                  type="text"
                  formControlName="direccion"
                  class="field-input"
                  placeholder="Tu dirección completa"
                />
              </div>
            </div>

            <div class="form-grid">
              <div class="form-field">
                <label class="field-label">Código Postal</label>
                <div class="input-wrapper">
                  <span class="material-symbols-outlined input-icon">pin_drop</span>
                  <input
                    type="text"
                    formControlName="postal"
                    class="field-input"
                    placeholder="00000"
                    maxlength="5"
                  />
                </div>
              </div>

              @if (esFisio()) {
                <div class="form-field">
                  <label class="field-label">Nº Colegiado</label>
                  <div class="input-wrapper">
                    <span class="material-symbols-outlined input-icon">verified</span>
                    <input
                      type="text"
                      formControlName="numero_colegiado"
                      class="field-input"
                      placeholder="Opcional"
                    />
                  </div>
                </div>
              }
            </div>

            <!-- Save Button (visible on expanded) -->
            @if (formularioCambiado()) {
              <div class="section-actions">
                <button
                  type="button"
                  class="save-button"
                  [disabled]="formularioUsuario.invalid"
                  (click)="guardarCambios()"
                >
                  <span class="material-symbols-outlined">save</span>
                  Guardar cambios
                </button>
              </div>
            }
          </div>
        }
      </section>

      <!-- Security Section -->
      <section
        #securitySection
        class="data-section animate-in"
        style="--delay: 0.2s"
        [class.expanded]="securityExpanded()"
      >
        <header class="section-header" (click)="toggleSecurity()">
          <div class="section-title-group">
            <div class="section-icon security">
              <span class="material-symbols-outlined">lock</span>
            </div>
            <div>
              <h3 class="section-title">Seguridad</h3>
              <p class="section-subtitle">Contraseña y acceso</p>
            </div>
          </div>
          <span class="material-symbols-outlined expand-icon" [class.rotated]="securityExpanded()">expand_more</span>
        </header>

        @if (securityExpanded()) {
          <div class="section-content" [formGroup]="formularioPassword">
            <p class="section-hint">
              <span class="material-symbols-outlined">info</span>
              Cambia tu contraseña para mantener tu cuenta segura
            </p>

            <!-- Current Password -->
            <div class="form-field full-width">
              <label class="field-label">Contraseña actual</label>
              <div class="input-wrapper">
                <span class="material-symbols-outlined input-icon">key</span>
                <input
                  [type]="hideCurrentPassword() ? 'password' : 'text'"
                  formControlName="currentPassword"
                  class="field-input"
                  placeholder="••••••••"
                />
                <button
                  type="button"
                  class="visibility-toggle"
                  (click)="hideCurrentPassword.set(!hideCurrentPassword())"
                >
                  <span class="material-symbols-outlined">
                    {{ hideCurrentPassword() ? 'visibility_off' : 'visibility' }}
                  </span>
                </button>
              </div>
            </div>

            <!-- New Password fields -->
            <div class="form-grid">
              <div class="form-field">
                <label class="field-label">Nueva contraseña</label>
                <div class="input-wrapper">
                  <span class="material-symbols-outlined input-icon">lock</span>
                  <input
                    [type]="hideNewPassword() ? 'password' : 'text'"
                    formControlName="newPassword"
                    class="field-input"
                    placeholder="Mínimo 8 caracteres"
                  />
                  <button
                    type="button"
                    class="visibility-toggle"
                    (click)="hideNewPassword.set(!hideNewPassword())"
                  >
                    <span class="material-symbols-outlined">
                      {{ hideNewPassword() ? 'visibility_off' : 'visibility' }}
                    </span>
                  </button>
                </div>
              </div>

              <div class="form-field">
                <label class="field-label">Confirmar</label>
                <div class="input-wrapper">
                  <span class="material-symbols-outlined input-icon">lock</span>
                  <input
                    [type]="hideConfirmPassword() ? 'password' : 'text'"
                    formControlName="confirmPassword"
                    class="field-input"
                    placeholder="Repetir contraseña"
                  />
                  <button
                    type="button"
                    class="visibility-toggle"
                    (click)="hideConfirmPassword.set(!hideConfirmPassword())"
                  >
                    <span class="material-symbols-outlined">
                      {{ hideConfirmPassword() ? 'visibility_off' : 'visibility' }}
                    </span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Change Password Button -->
            <div class="section-actions">
              <button
                type="button"
                class="save-button secondary"
                [disabled]="formularioPassword.invalid || cambiandoPassword()"
                (click)="cambiarPassword()"
              >
                @if (cambiandoPassword()) {
                  <div class="button-spinner"></div>
                } @else {
                  <span class="material-symbols-outlined">lock_reset</span>
                }
                Cambiar contraseña
              </button>
            </div>
          </div>
        }
      </section>

      <!-- Legal Section -->
      <section class="data-section animate-in" style="--delay: 0.25s" [class.expanded]="legalExpanded()">
        <header class="section-header" (click)="toggleLegal()">
          <div class="section-title-group">
            <div class="section-icon legal">
              <span class="material-symbols-outlined">description</span>
            </div>
            <div>
              <h3 class="section-title">Legal</h3>
              <p class="section-subtitle">Políticas y términos</p>
            </div>
          </div>
          <span class="material-symbols-outlined expand-icon" [class.rotated]="legalExpanded()">expand_more</span>
        </header>

        @if (legalExpanded()) {
          <div class="section-content">
            <div class="legal-cards">
              <button type="button" class="legal-card" (click)="abrirPrivacyPolicy()">
                <div class="legal-icon">
                  <span class="material-symbols-outlined">policy</span>
                </div>
                <div class="legal-info">
                  <h4 class="legal-title">Política de Privacidad</h4>
                  <p class="legal-desc">Cómo protegemos tus datos</p>
                </div>
                <span class="material-symbols-outlined legal-arrow">chevron_right</span>
              </button>

              <button type="button" class="legal-card" (click)="abrirTermsConditions()">
                <div class="legal-icon">
                  <span class="material-symbols-outlined">gavel</span>
                </div>
                <div class="legal-info">
                  <h4 class="legal-title">Términos y Condiciones</h4>
                  <p class="legal-desc">Condiciones de uso del servicio</p>
                </div>
                <span class="material-symbols-outlined legal-arrow">chevron_right</span>
              </button>
            </div>
          </div>
        }
      </section>

      <!-- App Info Footer -->
      <footer class="app-footer animate-in" style="--delay: 0.3s">
        <div class="app-logo">
          <span class="titulo-kengo">KENGO</span>
        </div>
        <p class="app-version">Versión 1.0.0</p>
        <p class="app-copyright">© 2026 Kengo Health</p>
      </footer>
    }
  </main>

  <!-- Privacy Policy Overlay -->
  @if (showPrivacyPolicy()) {
    <div class="overlay-panel" (click)="cerrarPrivacyPolicy()">
      <div class="overlay-sheet" (click)="$event.stopPropagation()">
        <header class="overlay-header">
          <h2 class="overlay-title">Política de Privacidad</h2>
          <button type="button" class="overlay-close" (click)="cerrarPrivacyPolicy()">
            <span class="material-symbols-outlined">close</span>
          </button>
        </header>
        <div class="overlay-content">
          <section class="legal-section">
            <h3>¿Quién es el responsable del tratamiento de sus datos?</h3>
            <p>
              IDENTIDAD: Kengo<br />
              CIF: G-********<br />
              DIRECCIÓN POSTAL: 38002, Santa Cruz de Tenerife, España<br />
              TELÉFONO: --- --- ---
            </p>
          </section>

          <section class="legal-section">
            <h3>¿Con qué finalidad tratamos sus datos personales?</h3>
            <p>
              Tratamos los datos que nos facilitan los usuarios que se registren en la
              plataforma de Kengo para gestionar su cuenta, proporcionar los servicios
              solicitados y mejorar la experiencia de usuario.
            </p>
          </section>

          <section class="legal-section">
            <h3>¿Por cuánto tiempo conservaremos sus datos?</h3>
            <p>
              Los datos personales proporcionados se conservarán mientras no se solicite
              la supresión por parte del interesado, o por obligación legal.
            </p>
          </section>

          <section class="legal-section">
            <h3>¿Cuál es la legitimación para el tratamiento de sus datos?</h3>
            <p>
              La base legal para el tratamiento de sus datos es la relación contractual
              y/o su consentimiento.
            </p>
          </section>

          <section class="legal-section">
            <h3>¿A qué destinatarios se comunicarán sus datos?</h3>
            <p>
              No se cederán datos a terceros sin su previo consentimiento, salvo
              obligación legal o contractual.
            </p>
          </section>

          <section class="legal-section">
            <h3>¿Cuáles son sus derechos cuando nos facilita sus datos?</h3>
            <p>
              Cualquier persona tiene derecho a obtener confirmación sobre si estamos
              tratando datos personales que les conciernan, o no. Las personas interesadas
              tienen derecho a acceder a sus datos personales, así como a solicitar la
              rectificación de los datos inexactos o, en su caso, solicitar su supresión
              cuando, entre otros motivos, los datos ya no sean necesarios para los fines
              que fueron recogidos.
            </p>
            <p>
              En determinadas circunstancias, los interesados podrán solicitar la
              limitación del tratamiento de sus datos, en cuyo caso únicamente los
              conservaremos para el ejercicio o la defensa de reclamaciones.
            </p>
          </section>

          <section class="legal-section">
            <h3>¿Cómo hemos obtenido sus datos?</h3>
            <p>Los datos los hemos obtenido del propio interesado.</p>
          </section>

          <section class="legal-section">
            <h3>Tipología de datos:</h3>
            <ul>
              <li>Datos identificativos (nombre completo, DNI)</li>
              <li>Datos de contacto (correo electrónico, dirección postal)</li>
            </ul>
          </section>
        </div>
        <footer class="overlay-footer">
          <button type="button" class="overlay-btn primary" (click)="cerrarPrivacyPolicy()">
            Entendido
          </button>
        </footer>
      </div>
    </div>
  }

  <!-- Terms & Conditions Overlay -->
  @if (showTermsConditions()) {
    <div class="overlay-panel" (click)="cerrarTermsConditions()">
      <div class="overlay-sheet" (click)="$event.stopPropagation()">
        <header class="overlay-header">
          <h2 class="overlay-title">Términos y Condiciones</h2>
          <button type="button" class="overlay-close" (click)="cerrarTermsConditions()">
            <span class="material-symbols-outlined">close</span>
          </button>
        </header>
        <div class="overlay-content">
          <section class="legal-section">
            <h3>Aviso Legal</h3>
            <p>
              En cumplimiento del artículo 10 de la Ley 34/2002, del 11 de julio, de
              servicios de la Sociedad de la Información y Comercio Electrónico (LSSICE),
              Kengo, facilita a continuación sus datos de contacto e información general.
            </p>
          </section>

          <section class="legal-section">
            <h3>Datos de la Organización</h3>
            <p><strong>Denominación social:</strong> KENGO</p>
            <p><strong>NIF:</strong> G-***********</p>
            <p><strong>Correo electrónico:</strong> info&#64;kengo.com</p>
            <p><strong>Teléfono:</strong> +34 *** *** ***</p>
            <p>
              <strong>Datos registrales:</strong> Inscrita en el Registro de Fundaciones
              de Competencia Estatal con el número ***.
            </p>
          </section>

          <section class="legal-section">
            <h3>Términos Legales y Condiciones Generales de Uso</h3>
            <p>
              Este sitio web ha sido creado por KENGO con carácter informativo y para uso
              personal de los usuarios. A través de las Condiciones Generales de uso, se
              pretende regular el acceso y uso de este sitio web, así como la relación
              entre el sitio web y sus usuarios.
            </p>
            <p>
              Accediendo a este sitio web se aceptan los siguientes términos y condiciones:
              el acceso a este sitio web es responsabilidad exclusiva de los usuarios. El
              simple acceso a este sitio web no supone entablar ningún tipo de relación
              comercial entre KENGO y el usuario.
            </p>
            <p>
              El acceso y la navegación en este sitio web supone aceptar y conocer las
              advertencias legales, condiciones y términos de uso contenidas en ella.
            </p>
          </section>
        </div>
        <footer class="overlay-footer">
          <button type="button" class="overlay-btn primary" (click)="cerrarTermsConditions()">
            Entendido
          </button>
        </footer>
      </div>
    </div>
  }
</section>
