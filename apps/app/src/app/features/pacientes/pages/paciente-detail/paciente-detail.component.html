<section class="detail-page">
  <!-- Aurora Background -->
  <div class="aurora-bg" aria-hidden="true">
    <div class="aurora-wave aurora-wave-1"></div>
    <div class="aurora-wave aurora-wave-2"></div>
    <div class="aurora-wave aurora-wave-3"></div>
  </div>

  <!-- Compact Header (mobile only) -->
  @if (isMovil()) {
    <header class="header-glass sticky top-0 z-50 shrink-0 px-4 pt-3 pb-4">
      <div class="header-content">
        <div class="header-left">
          <button
            type="button"
            class="back-btn"
            aria-label="Volver a pacientes"
            (click)="volver()"
          >
            <span class="material-symbols-outlined">arrow_back</span>
          </button>
          <h1 class="titulo-kengo header-title">Paciente</h1>
        </div>
        <button
          type="button"
          class="header-action"
          aria-label="Gestionar acceso"
          (click)="gestionarAcceso()"
        >
          <span class="material-symbols-outlined">key</span>
        </button>
      </div>
    </header>
  }

  <!-- Main Content -->
  <main class="detail-main" [class.pt-desktop]="!isMovil()">
    <!-- Loading State -->
    @if (isLoadingPaciente()) {
      <div class="state-card loading-state">
        <div class="shimmer-effect"></div>
        <div class="state-icon pulse">
          <span class="material-symbols-outlined">person</span>
        </div>
        <p class="state-text">Cargando paciente...</p>
      </div>
    }

    <!-- Error State -->
    @if (error()) {
      <div class="state-card error-state animate-in">
        <div class="state-icon error">
          <span class="material-symbols-outlined">error</span>
        </div>
        <h2 class="state-title">Algo salió mal</h2>
        <p class="state-text">{{ error() }}</p>
        <button type="button" class="retry-btn" (click)="volver()">
          <span class="material-symbols-outlined">arrow_back</span>
          Volver a pacientes
        </button>
      </div>
    }

    <!-- Patient Content -->
    @if (!isLoadingPaciente() && !error() && paciente()) {
      <div class="content-grid">
        <!-- Main Column -->
        <div class="main-column">
          <!-- Hero Card: Patient Info -->
          <article class="hero-card animate-in">
            <div class="hero-visual">
              <div class="hero-gradient"></div>
              <div class="hero-pattern" aria-hidden="true"></div>
            </div>

            <!-- Back Button (desktop only) -->
            @if (!isMovil()) {
              <button
                type="button"
                class="hero-back-btn"
                aria-label="Volver a pacientes"
                (click)="volver()"
              >
                <span class="material-symbols-outlined">arrow_back</span>
                <span>Mis pacientes</span>
              </button>
            }

            <div class="hero-content">
              <!-- Avatar -->
              <div class="hero-avatar">
                @if (avatarUrl()) {
                  <img
                    [src]="avatarUrl()"
                    [alt]="fullName()"
                    class="avatar-img"
                  />
                } @else {
                  <div class="avatar-placeholder">
                    <span class="material-symbols-outlined">person</span>
                  </div>
                }
              </div>
              <!-- Info -->
              <div class="hero-info">
                <h2 class="hero-name">{{ fullName() }}</h2>
                @if (getClinicaNombre()) {
                  <p class="hero-clinic">
                    <span class="material-symbols-outlined icon-sm">location_city</span>
                    {{ getClinicaNombre() }}
                  </p>
                }
              </div>
              <!-- Edit Button -->
              <button
                type="button"
                class="edit-btn"
                aria-label="Editar paciente"
                (click)="editarPaciente()"
              >
                <span class="material-symbols-outlined">edit</span>
              </button>
            </div>

            <!-- Contact Info -->
            <div class="contact-grid">
              @if (paciente()?.email) {
                <a
                  [href]="'mailto:' + paciente()?.email"
                  class="contact-item"
                >
                  <div class="contact-icon">
                    <span class="material-symbols-outlined">mail</span>
                  </div>
                  <div class="contact-info">
                    <span class="contact-label">Email</span>
                    <span class="contact-value">{{ paciente()?.email }}</span>
                  </div>
                </a>
              }
              @if (paciente()?.telefono) {
                <a
                  [href]="'tel:' + paciente()?.telefono"
                  class="contact-item"
                >
                  <div class="contact-icon">
                    <span class="material-symbols-outlined">phone</span>
                  </div>
                  <div class="contact-info">
                    <span class="contact-label">Teléfono</span>
                    <span class="contact-value">{{ paciente()?.telefono }}</span>
                  </div>
                </a>
              }
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
              <button
                type="button"
                class="action-btn primary"
                (click)="crearPlan()"
              >
                <span class="material-symbols-outlined icon-filled">add</span>
                <span class="action-label">Nuevo Plan</span>
              </button>
              <button
                type="button"
                class="action-btn"
                (click)="gestionarAcceso()"
              >
                <span class="material-symbols-outlined">key</span>
                <span class="action-label">Gestionar acceso</span>
              </button>
            </div>
          </article>

          <!-- Plans Section -->
          <section class="content-section animate-in" style="--delay: 0.1s">
            <header
              class="section-header clickable"
              (click)="planesExpanded = !planesExpanded"
            >
              <div class="section-header-left">
                <div class="section-icon">
                  <span class="material-symbols-outlined">assignment</span>
                </div>
                <div>
                  <h2 class="section-title">Planes de tratamiento</h2>
                  <p class="section-subtitle">{{ planes().length }} plan{{ planes().length !== 1 ? 'es' : '' }} asignado{{ planes().length !== 1 ? 's' : '' }}</p>
                </div>
              </div>
              <span
                class="material-symbols-outlined expand-icon"
                [class.rotated]="planesExpanded"
              >expand_more</span>
            </header>

            @if (planesExpanded) {
              <div class="section-content">
                @if (isLoadingPlanes()) {
                  <div class="loading-inline">
                    <div class="shimmer-bar"></div>
                    <div class="shimmer-bar short"></div>
                  </div>
                } @else if (planes().length === 0) {
                  <div class="empty-state-inline">
                    <div class="empty-icon">
                      <span class="material-symbols-outlined">content_paste_off</span>
                    </div>
                    <p class="empty-text">No hay planes asignados</p>
                    <button
                      type="button"
                      class="empty-action"
                      (click)="crearPlan()"
                    >
                      <span class="material-symbols-outlined">add</span>
                      Crear primer plan
                    </button>
                  </div>
                } @else {
                  <div class="plans-list">
                    @for (plan of planes(); track plan.id_plan) {
                      <article class="plan-card" [class.completed]="plan.estado === 'completado'">
                        <div class="plan-main">
                          <div class="plan-info">
                            <div class="plan-header-row">
                              <h3 class="plan-title">{{ plan.titulo }}</h3>
                              <span class="plan-badge" [class]="getEstadoClass(plan.estado)">
                                {{ getEstadoLabel(plan.estado) }}
                              </span>
                            </div>
                            @if (plan.fecha_inicio || plan.fecha_fin) {
                              <p class="plan-dates">
                                <span class="material-symbols-outlined icon-xs">calendar_today</span>
                                @if (plan.fecha_inicio) {
                                  {{ formatearFecha(plan.fecha_inicio) }}
                                }
                                @if (plan.fecha_inicio && plan.fecha_fin) {
                                  <span class="date-separator">→</span>
                                }
                                @if (plan.fecha_fin) {
                                  {{ formatearFecha(plan.fecha_fin) }}
                                }
                              </p>
                            }
                          </div>
                          <div class="plan-actions">
                            <button
                              type="button"
                              class="plan-action-btn"
                              aria-label="Ver plan"
                              (click)="verPlan(plan)"
                            >
                              <span class="material-symbols-outlined">visibility</span>
                            </button>
                            <button
                              type="button"
                              class="plan-action-btn"
                              aria-label="Editar plan"
                              (click)="editarPlan(plan)"
                            >
                              <span class="material-symbols-outlined">edit</span>
                            </button>
                            <button
                              type="button"
                              class="plan-action-btn"
                              aria-label="Descargar PDF"
                              [disabled]="descargandoInforme() !== null"
                              (click)="descargarInforme(plan)"
                            >
                              @if (descargandoInforme() === plan.id_plan) {
                                <span class="material-symbols-outlined spin">progress_activity</span>
                              } @else {
                                <span class="material-symbols-outlined">picture_as_pdf</span>
                              }
                            </button>
                          </div>
                        </div>
                      </article>
                    }
                  </div>

                  @if (planes().length > 3) {
                    <button
                      type="button"
                      class="see-all-btn"
                      (click)="verTodosPlanes()"
                    >
                      Ver todos los planes
                      <span class="material-symbols-outlined">arrow_forward</span>
                    </button>
                  }
                }
              </div>
            }
          </section>
        </div>

        <!-- Sidebar Column -->
        <aside class="sidebar-column">
          <!-- Statistics Section -->
          <section class="content-section stats-section animate-in" style="--delay: 0.15s">
            <header
              class="section-header clickable"
              (click)="statsExpanded = !statsExpanded"
            >
              <div class="section-header-left">
                <div class="section-icon gold">
                  <span class="material-symbols-outlined">analytics</span>
                </div>
                <div>
                  <h2 class="section-title">Estadísticas</h2>
                  <p class="section-subtitle">Últimos 30 días</p>
                </div>
              </div>
              <span
                class="material-symbols-outlined expand-icon"
                [class.rotated]="statsExpanded"
              >expand_more</span>
            </header>

            @if (statsExpanded) {
              <div class="section-content">
                @if (isLoadingEstadisticas()) {
                  <div class="loading-inline">
                    <div class="shimmer-bar"></div>
                    <div class="shimmer-bar short"></div>
                  </div>
                } @else if (estadisticas()) {
                  <!-- Main Stats Grid -->
                  <div class="stats-grid">
                    <!-- Adherence -->
                    <div class="stat-card primary">
                      <div class="stat-header">
                        <span class="stat-label">Adherencia</span>
                        <span class="material-symbols-outlined stat-icon">trending_up</span>
                      </div>
                      <div class="stat-value-large">{{ estadisticas()?.adherenciaGeneral }}%</div>
                      <div class="stat-progress">
                        <div
                          class="stat-progress-fill"
                          [style.width.%]="estadisticas()?.adherenciaGeneral ?? 0"
                        ></div>
                      </div>
                    </div>

                    <!-- Total Sessions -->
                    <div class="stat-card">
                      <div class="stat-header">
                        <span class="stat-label">Sesiones</span>
                        <span class="material-symbols-outlined stat-icon">event_available</span>
                      </div>
                      <div class="stat-value-large">{{ estadisticas()?.totalSesiones }}</div>
                      <span class="stat-hint">días con actividad</span>
                    </div>

                    <!-- Pain Average -->
                    <div class="stat-card">
                      <div class="stat-header">
                        <span class="stat-label">Dolor promedio</span>
                        <span
                          class="material-symbols-outlined stat-icon"
                          [class]="getDolorColor(estadisticas()?.promedioDolorGeneral ?? null)"
                        >sentiment_dissatisfied</span>
                      </div>
                      @if (estadisticas()?.promedioDolorGeneral !== null && estadisticas()?.promedioDolorGeneral !== undefined) {
                        <div
                          class="stat-value-large"
                          [class]="getDolorColor(estadisticas()?.promedioDolorGeneral ?? null)"
                        >{{ estadisticas()?.promedioDolorGeneral }}<span class="stat-unit">/10</span></div>
                      } @else {
                        <div class="stat-value-large muted">—</div>
                        <span class="stat-hint">Sin datos</span>
                      }
                    </div>

                    <!-- Streak -->
                    <div class="stat-card gold">
                      <div class="stat-header">
                        <span class="stat-label">Racha actual</span>
                        <span class="material-symbols-outlined stat-icon icon-filled">local_fire_department</span>
                      </div>
                      <div class="stat-value-large">{{ estadisticas()?.rachaActual }}</div>
                      <span class="stat-hint">días seguidos</span>
                    </div>
                  </div>

                  <!-- Weekly Adherence Chart -->
                  @if (estadisticas()?.adherenciaSemanal && estadisticas()!.adherenciaSemanal.length > 0) {
                    <div class="weekly-chart">
                      <h4 class="chart-title">Adherencia semanal</h4>
                      <div class="chart-bars">
                        @for (semana of estadisticas()!.adherenciaSemanal; track semana.semana) {
                          <div class="chart-bar-container">
                            <div class="chart-bar-bg">
                              <div
                                class="chart-bar-fill"
                                [style.height.%]="semana.porcentaje"
                              ></div>
                            </div>
                            <span class="chart-bar-label">{{ semana.semana }}</span>
                            <span class="chart-bar-value">{{ semana.porcentaje }}%</span>
                          </div>
                        }
                      </div>
                    </div>
                  }

                  <!-- Last Activity -->
                  @if (estadisticas()?.diasDesdeUltimaSesion !== null && estadisticas()?.diasDesdeUltimaSesion !== undefined) {
                    <div class="last-activity">
                      <span class="material-symbols-outlined activity-icon">schedule</span>
                      <span class="activity-text">
                        Última actividad:
                        @if (estadisticas()?.diasDesdeUltimaSesion === 0) {
                          <strong class="text-success">Hoy</strong>
                        } @else if (estadisticas()?.diasDesdeUltimaSesion === 1) {
                          <strong>Ayer</strong>
                        } @else {
                          <strong>hace {{ estadisticas()?.diasDesdeUltimaSesion }} días</strong>
                        }
                      </span>
                    </div>
                  }
                } @else {
                  <div class="empty-state-inline">
                    <div class="empty-icon">
                      <span class="material-symbols-outlined">bar_chart</span>
                    </div>
                    <p class="empty-text">Sin datos suficientes</p>
                  </div>
                }
              </div>
            }
          </section>

          <!-- Recent Activity Section -->
          <section class="content-section animate-in" style="--delay: 0.2s">
            <header
              class="section-header clickable"
              (click)="activityExpanded = !activityExpanded"
            >
              <div class="section-header-left">
                <div class="section-icon">
                  <span class="material-symbols-outlined">history</span>
                </div>
                <div>
                  <h2 class="section-title">Actividad reciente</h2>
                  <p class="section-subtitle">{{ sesiones().length }} sesión{{ sesiones().length !== 1 ? 'es' : '' }} registrada{{ sesiones().length !== 1 ? 's' : '' }}</p>
                </div>
              </div>
              <span
                class="material-symbols-outlined expand-icon"
                [class.rotated]="activityExpanded"
              >expand_more</span>
            </header>

            @if (activityExpanded) {
              <div class="section-content">
                @if (isLoadingSesiones()) {
                  <div class="loading-inline">
                    <div class="shimmer-bar"></div>
                    <div class="shimmer-bar short"></div>
                  </div>
                } @else if (sesiones().length === 0) {
                  <div class="empty-state-inline">
                    <div class="empty-icon">
                      <span class="material-symbols-outlined">event_busy</span>
                    </div>
                    <p class="empty-text">Sin actividad registrada</p>
                  </div>
                } @else {
                  <div class="activity-list">
                    @for (sesion of sesiones().slice(0, 10); track sesion.fecha; let i = $index) {
                      <article
                        class="activity-item"
                        [style.--delay]="(0.25 + i * 0.03) + 's'"
                      >
                        <div class="activity-date-badge">
                          <span class="activity-day">{{ sesion.fechaFormateada }}</span>
                        </div>
                        <div class="activity-details">
                          <div class="activity-exercises">
                            <span class="material-symbols-outlined icon-filled text-success">check_circle</span>
                            <span>{{ sesion.totalEjercicios }} ejercicio{{ sesion.totalEjercicios !== 1 ? 's' : '' }}</span>
                          </div>
                          @if (sesion.promedioDolorValue !== null) {
                            <div class="activity-pain">
                              <span
                                class="material-symbols-outlined"
                                [class]="getDolorColor(sesion.promedioDolorValue)"
                              >sentiment_dissatisfied</span>
                              <span [class]="getDolorColor(sesion.promedioDolorValue)">
                                {{ sesion.promedioDolorValue | number:'1.0-1' }}/10
                              </span>
                            </div>
                          }
                        </div>
                      </article>
                    }
                  </div>

                  @if (sesiones().length > 10) {
                    <p class="activity-footer">
                      Mostrando las últimas 10 de {{ sesiones().length }} sesiones
                    </p>
                  }
                }
              </div>
            }
          </section>
        </aside>
      </div>
    }
  </main>
</section>
