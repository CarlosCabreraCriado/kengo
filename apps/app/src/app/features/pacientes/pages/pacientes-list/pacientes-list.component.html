<section class="patients-page">
  <!-- Aurora Background -->
  <div class="aurora-bg" aria-hidden="true">
    <div class="aurora-wave aurora-wave-1"></div>
    <div class="aurora-wave aurora-wave-2"></div>
    <div class="aurora-wave aurora-wave-3"></div>
  </div>

  <!-- Compact Header -->
  <header class="patients-header">
    <div class="header-content">
      <div class="header-left">
        @if (!isDesktop()) {
          <a class="back-btn" aria-label="Volver" routerLink="/inicio">
            <span class="material-symbols-outlined">arrow_back</span>
          </a>
        }
        <div class="header-title-group">
          <h1 class="titulo-kengo header-title">Mis Pacientes</h1>
          @if (pacientes().length > 0) {
            <span class="patient-count">{{ pacientes().length }} {{ pacientes().length === 1 ? 'paciente' : 'pacientes' }}</span>
          }
        </div>
      </div>
      <div class="header-actions">
        <button class="action-btn" aria-label="Recargar" (click)="reload()">
          <span class="material-symbols-outlined">refresh</span>
        </button>
        <button class="action-btn primary-action" (click)="openAddPaciente()" aria-label="Añadir paciente">
          <span class="material-symbols-outlined icon-filled">person_add</span>
        </button>
      </div>
    </div>

    <!-- Search Bar -->
    <div class="search-container">
      <div class="search-bar">
        <span class="material-symbols-outlined search-icon">search</span>
        <input
          #buscador
          type="text"
          class="search-input"
          placeholder="Buscar por nombre, email..."
          (input)="onBuscar(buscador.value)"
        />
        @if (buscador.value) {
          <button class="clear-btn" aria-label="Borrar búsqueda" (click)="buscador.value = ''; onBuscar('')">
            <span class="material-symbols-outlined">close</span>
          </button>
        }
      </div>
      <button class="view-toggle" (click)="vista.set(vista() === 'card' ? 'lista' : 'card')" aria-label="Cambiar vista">
        <span class="material-symbols-outlined">{{ vista() === 'card' ? 'view_list' : 'grid_view' }}</span>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="patients-main">
    <!-- Loading State -->
    @if (pacientesRes.isLoading() && idsClinicas() !== null) {
      <div class="state-card loading-state">
        <div class="shimmer-effect"></div>
        <div class="state-icon pulse">
          <span class="material-symbols-outlined">groups</span>
        </div>
        <p class="state-text">Cargando pacientes...</p>
      </div>
    }

    <!-- Error State -->
    @else if (pacientesRes.error()) {
      <div class="state-card error-state">
        <div class="state-icon error">
          <span class="material-symbols-outlined">error</span>
        </div>
        <p class="state-text error">No se pudieron cargar los pacientes</p>
        <button class="retry-btn" (click)="reload()">
          <span class="material-symbols-outlined">refresh</span>
          Reintentar
        </button>
      </div>
    }

    <!-- Empty State -->
    @else if (pacientes().length === 0 && !pacientesRes.isLoading()) {
      <div class="state-card empty-state">
        <div class="state-icon empty">
          <span class="material-symbols-outlined">group_off</span>
        </div>
        <h3 class="state-title">Sin pacientes</h3>
        <p class="state-text">Aún no tienes pacientes registrados. Añade tu primer paciente para comenzar.</p>
        <button class="cta-btn" (click)="openAddPaciente()">
          <span class="material-symbols-outlined icon-filled">person_add</span>
          Añadir primer paciente
        </button>
      </div>
    }

    <!-- Patients Content -->
    @else if (pacientes().length > 0) {
      <!-- Quick Stats Bar -->
      <section class="stats-bar animate-in">
        <div class="stat-pill">
          <span class="material-symbols-outlined stat-icon">groups</span>
          <span class="stat-value">{{ pacientes().length }}</span>
          <span class="stat-label">Total</span>
        </div>
        <div class="stat-pill accent">
          <span class="material-symbols-outlined stat-icon icon-filled">favorite</span>
          <span class="stat-value">{{ pacientes().length }}</span>
          <span class="stat-label">Activos</span>
        </div>
      </section>

      <!-- Patients Grid/List -->
      @if (vista() === 'card') {
        <section class="patients-grid animate-in" style="--delay: 0.1s">
          @for (p of pacientes(); track p.id; let i = $index) {
            <article class="patient-card" [style.--card-delay]="(i * 0.03) + 's'" (click)="verDetalle(p)">
              <div class="card-content">
                <!-- Avatar -->
                <div class="patient-avatar">
                  @if (avatarUrl(p)) {
                    <img [src]="avatarUrl(p)" [alt]="fullName(p)" class="avatar-img"/>
                  } @else {
                    <span class="avatar-initials">{{ getInitials(p) }}</span>
                  }
                  <span class="online-dot"></span>
                </div>

                <!-- Info -->
                <div class="patient-info">
                  <h3 class="patient-name">{{ fullName(p) }}</h3>

                  @if (p.email) {
                    <div class="info-row">
                      <span class="material-symbols-outlined info-icon">mail</span>
                      <span class="info-text">{{ p.email }}</span>
                    </div>
                  }

                  @if (p.telefono) {
                    <div class="info-row">
                      <span class="material-symbols-outlined info-icon">phone</span>
                      <span class="info-text">{{ p.telefono }}</span>
                    </div>
                  }

                  @if (getClinicaNombre(p)) {
                    <span class="clinic-badge">
                      <span class="material-symbols-outlined">domain</span>
                      {{ getClinicaNombre(p) }}
                    </span>
                  }
                </div>

                <!-- Arrow -->
                <span class="material-symbols-outlined card-arrow">chevron_right</span>
              </div>

              <!-- Quick Actions (on hover/press) -->
              <div class="card-actions">
                @if (p.telefono) {
                  <a [href]="'tel:' + p.telefono" class="mini-action" (click)="$event.stopPropagation()" aria-label="Llamar">
                    <span class="material-symbols-outlined icon-filled">call</span>
                  </a>
                }
                @if (p.email) {
                  <a [href]="'mailto:' + p.email" class="mini-action" (click)="$event.stopPropagation()" aria-label="Email">
                    <span class="material-symbols-outlined">mail</span>
                  </a>
                }
                <button class="mini-action" (click)="$event.stopPropagation(); generarQr(p.magic_link_url || '')" aria-label="QR Code">
                  <span class="material-symbols-outlined">qr_code_2</span>
                </button>
              </div>
            </article>
          }
        </section>
      } @else {
        <!-- List View -->
        <section class="patients-list animate-in" style="--delay: 0.1s">
          @for (p of pacientes(); track p.id; let i = $index) {
            <article class="patient-row" [style.--row-delay]="(i * 0.02) + 's'" (click)="verDetalle(p)">
              <!-- Avatar -->
              <div class="row-avatar">
                @if (avatarUrl(p)) {
                  <img [src]="avatarUrl(p)" [alt]="fullName(p)" class="avatar-img"/>
                } @else {
                  <span class="avatar-initials">{{ getInitials(p) }}</span>
                }
              </div>

              <!-- Info -->
              <div class="row-info">
                <h4 class="row-name">{{ fullName(p) }}</h4>
                <span class="row-detail">{{ p.email || p.telefono || 'Sin contacto' }}</span>
              </div>

              <!-- Quick Actions -->
              <div class="row-actions">
                @if (p.telefono) {
                  <a [href]="'tel:' + p.telefono" class="row-action" (click)="$event.stopPropagation()" aria-label="Llamar">
                    <span class="material-symbols-outlined icon-filled">call</span>
                  </a>
                }
              </div>

              <!-- Arrow -->
              <span class="material-symbols-outlined row-arrow">chevron_right</span>
            </article>
          }
        </section>
      }
    }
  </main>

  <!-- Floating Action Button (Mobile only) -->
  @if (!isDesktop() && pacientes().length > 0) {
    <button class="fab" (click)="openAddPaciente()" aria-label="Añadir paciente">
      <span class="material-symbols-outlined icon-filled">person_add</span>
    </button>
  }
</section>
