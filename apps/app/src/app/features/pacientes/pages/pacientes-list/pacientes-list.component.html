<section class="patients-page">
  <!-- Aurora Background -->
  <div class="aurora-bg" aria-hidden="true">
    <div class="aurora-wave aurora-wave-1"></div>
    <div class="aurora-wave aurora-wave-2"></div>
    <div class="aurora-wave aurora-wave-3"></div>
  </div>

  <!-- Header Responsivo Alineado con Navegación -->
  <header class="header-glass sticky top-0 z-50 shrink-0 px-4 pt-3 pb-4">
    <div class="mx-auto max-w-6xl">

      <!-- MÓVIL: Header completo con título y navegación -->
      @if (isMovil()) {
        <div class="mb-4 flex items-center justify-between">
          <!-- Botón volver + Título -->
          <div class="flex items-center gap-3">
            <button
              type="button"
              routerLink="/inicio"
              class="flex h-10 w-10 items-center justify-center rounded-xl
                     bg-white/60 backdrop-blur-md border border-white/40
                     text-zinc-600 transition-all duration-200
                     hover:bg-white/80 hover:scale-105 active:scale-95"
              aria-label="Volver al inicio"
            >
              <span class="material-symbols-outlined text-xl">arrow_back</span>
            </button>
            <div>
              <h1 class="titulo-kengo text-2xl text-[#e75c3e]">Mis Pacientes</h1>
              @if (pacientes().length > 0) {
                <p class="text-xs font-medium text-zinc-500">
                  {{ pacientes().length }} {{ pacientes().length === 1 ? 'paciente' : 'pacientes' }}
                </p>
              }
            </div>
          </div>

          <!-- Acción añadir paciente (móvil) -->
          <button
            type="button"
            class="flex h-10 w-10 items-center justify-center rounded-xl
                   bg-[#e75c3e] text-white transition-all duration-200
                   hover:bg-[#c94a2f] hover:scale-105 active:scale-95
                   shadow-[0_4px_16px_rgba(231,92,62,0.3)]"
            aria-label="Añadir paciente"
            (click)="openAddPaciente()"
          >
            <span class="material-symbols-outlined text-xl icon-filled">person_add</span>
          </button>
        </div>
      }

      <!-- Barra de controles (siempre visible) -->
      <div class="flex items-center gap-2">
        <!-- DESKTOP: Información compacta al inicio -->
        @if (!isMovil() && pacientes().length > 0) {
          <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/50 backdrop-blur-md shrink-0">
            <span class="text-sm font-bold text-[#e75c3e]">{{ pacientes().length }}</span>
            <span class="text-xs text-zinc-500">{{ pacientes().length === 1 ? 'paciente' : 'pacientes' }}</span>
          </div>
        }

        <!-- Barra de búsqueda -->
        <div class="relative flex-1">
          <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#e75c3e] text-xl pointer-events-none z-10">search</span>
          <input
            #buscador
            type="text"
            class="w-full h-12 pl-11 pr-10 rounded-2xl
                   bg-white/70 border border-white/40
                   text-zinc-700 text-sm
                   transition-all outline-none
                   focus:border-[#e75c3e]/40 focus:bg-white/90
                   backdrop-blur-sm"
            placeholder="Buscar por nombre, email..."
            (input)="onBuscar(buscador.value)"
          />
          @if (buscador.value) {
            <button
              type="button"
              class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full
                     bg-transparent text-zinc-400 flex items-center justify-center
                     cursor-pointer transition-all border-none hover:bg-zinc-100 hover:text-zinc-600"
              aria-label="Borrar búsqueda"
              (click)="buscador.value = ''; onBuscar('')"
            >
              <span class="material-symbols-outlined text-lg">close</span>
            </button>
          }
        </div>

        <!-- Toggle de vista -->
        <button
          type="button"
          class="flex h-12 w-12 items-center justify-center rounded-2xl
                 bg-white/70 backdrop-blur-md border border-white/40
                 text-zinc-600 transition-all duration-200
                 hover:bg-white/90 hover:text-[#e75c3e] active:scale-95"
          (click)="vista.set(vista() === 'card' ? 'lista' : 'card')"
          aria-label="Cambiar vista"
        >
          <span class="material-symbols-outlined text-xl">{{ vista() === 'card' ? 'view_list' : 'grid_view' }}</span>
        </button>

        <!-- DESKTOP: Botón añadir -->
        @if (!isMovil()) {
          <button
            type="button"
            class="flex h-10 items-center gap-1.5 rounded-full px-4 ml-2
                   bg-[#e75c3e] text-white transition-all duration-200
                   hover:bg-[#c94a2f] hover:scale-105 active:scale-95
                   shadow-[0_4px_16px_rgba(231,92,62,0.3)]"
            (click)="openAddPaciente()"
          >
            <span class="material-symbols-outlined text-lg icon-filled">person_add</span>
            <span class="text-xs font-semibold">Añadir</span>
          </button>
        }
      </div>

    </div>
  </header>

  <!-- Main Content -->
  <main class="patients-main">
    <!-- Loading State -->
    @if (pacientesRes.isLoading() && idsClinicas() !== null) {
      <div class="state-card loading-state">
        <div class="shimmer-effect"></div>
        <div class="state-icon pulse">
          <span class="material-symbols-outlined">groups</span>
        </div>
        <p class="state-text">Cargando pacientes...</p>
      </div>
    }

    <!-- Error State -->
    @else if (pacientesRes.error()) {
      <div class="state-card error-state">
        <div class="state-icon error">
          <span class="material-symbols-outlined">error</span>
        </div>
        <p class="state-text error">No se pudieron cargar los pacientes</p>
        <button class="retry-btn" (click)="reload()">
          <span class="material-symbols-outlined">refresh</span>
          Reintentar
        </button>
      </div>
    }

    <!-- Empty State -->
    @else if (pacientes().length === 0 && !pacientesRes.isLoading()) {
      <div class="state-card empty-state">
        <div class="state-icon empty">
          <span class="material-symbols-outlined">group_off</span>
        </div>
        <h3 class="state-title">Sin pacientes</h3>
        <p class="state-text">Aún no tienes pacientes registrados. Añade tu primer paciente para comenzar.</p>
        <button class="cta-btn" (click)="openAddPaciente()">
          <span class="material-symbols-outlined icon-filled">person_add</span>
          Añadir primer paciente
        </button>
      </div>
    }

    <!-- Patients Content -->
    @else if (pacientes().length > 0) {
      <!-- Quick Stats Bar -->
      <section class="stats-bar animate-in">
        <div class="stat-pill">
          <span class="material-symbols-outlined stat-icon">groups</span>
          <span class="stat-value">{{ pacientes().length }}</span>
          <span class="stat-label">Total</span>
        </div>
        <div class="stat-pill accent">
          <span class="material-symbols-outlined stat-icon icon-filled">favorite</span>
          <span class="stat-value">{{ pacientes().length }}</span>
          <span class="stat-label">Activos</span>
        </div>
      </section>

      <!-- Patients Grid/List -->
      @if (vista() === 'card') {
        <section class="patients-grid animate-in" style="--delay: 0.1s">
          @for (p of pacientes(); track p.id; let i = $index) {
            <article class="patient-card" [style.--card-delay]="(i * 0.03) + 's'" (click)="verDetalle(p)">
              <div class="card-content">
                <!-- Avatar -->
                <div class="patient-avatar">
                  @if (avatarUrl(p)) {
                    <img [src]="avatarUrl(p)" [alt]="fullName(p)" class="avatar-img"/>
                  } @else {
                    <span class="avatar-initials">{{ getInitials(p) }}</span>
                  }
                  <span class="online-dot"></span>
                </div>

                <!-- Info -->
                <div class="patient-info">
                  <h3 class="patient-name">{{ fullName(p) }}</h3>

                  @if (p.email) {
                    <div class="info-row">
                      <span class="material-symbols-outlined info-icon">mail</span>
                      <span class="info-text">{{ p.email }}</span>
                    </div>
                  }

                  <div class="info-row">
                    <span class="material-symbols-outlined info-icon">phone</span>
                    <span class="info-text" [class.text-zinc-400]="!p.telefono">{{ p.telefono || 'Sin teléfono' }}</span>
                  </div>

                  @if (getClinicaNombre(p)) {
                    <span class="clinic-badge">
                      <span class="material-symbols-outlined">domain</span>
                      {{ getClinicaNombre(p) }}
                    </span>
                  }
                </div>

                <!-- Arrow -->
                <span class="material-symbols-outlined card-arrow">chevron_right</span>
              </div>

            </article>
          }

          <!-- Card: Nuevo Paciente (al final) -->
          <article class="patient-card add-patient-card" (click)="openAddPaciente()">
            <div class="card-content">
              <div class="patient-avatar add-avatar">
                <span class="material-symbols-outlined text-2xl icon-filled">person_add</span>
              </div>
              <div class="patient-info">
                <h3 class="patient-name text-[#e75c3e]">Nuevo paciente</h3>
                <p class="text-xs text-zinc-500 mt-1">Añadir a la lista</p>
              </div>
              <span class="material-symbols-outlined card-arrow">add</span>
            </div>
          </article>
        </section>
      } @else {
        <!-- List View -->
        <section class="patients-list animate-in" style="--delay: 0.1s">
          @for (p of pacientes(); track p.id; let i = $index) {
            <article class="patient-row" [style.--row-delay]="(i * 0.02) + 's'" (click)="verDetalle(p)">
              <!-- Avatar -->
              <div class="row-avatar">
                @if (avatarUrl(p)) {
                  <img [src]="avatarUrl(p)" [alt]="fullName(p)" class="avatar-img"/>
                } @else {
                  <span class="avatar-initials">{{ getInitials(p) }}</span>
                }
              </div>

              <!-- Info -->
              <div class="row-info">
                <h4 class="row-name">{{ fullName(p) }}</h4>
                <span class="row-detail">{{ p.email || p.telefono || 'Sin contacto' }}</span>
              </div>

              <!-- Arrow -->
              <span class="material-symbols-outlined row-arrow">chevron_right</span>
            </article>
          }

          <!-- Row: Nuevo Paciente (al final) -->
          <article class="patient-row add-patient-row" (click)="openAddPaciente()">
            <div class="row-avatar add-avatar">
              <span class="material-symbols-outlined text-lg icon-filled">person_add</span>
            </div>
            <div class="row-info">
              <h4 class="row-name text-[#e75c3e]">Nuevo paciente</h4>
              <span class="row-detail">Añadir a la lista</span>
            </div>
            <span class="material-symbols-outlined row-arrow">add</span>
          </article>
        </section>
      }
    }
  </main>

  <!-- Floating Action Button (Mobile only) -->
  @if (isMovil() && pacientes().length > 0) {
    <button class="fab" (click)="openAddPaciente()" aria-label="Añadir paciente">
      <span class="material-symbols-outlined icon-filled">person_add</span>
    </button>
  }
</section>
