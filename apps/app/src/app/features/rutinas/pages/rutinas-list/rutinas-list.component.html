<section class="rutinas-page flex h-full w-full flex-col overflow-hidden">
  <!-- Header sticky con glassmorphism -->
  <header class="header-glass sticky top-0 z-50 shrink-0 px-4 pt-3 pb-4">
    <div class="mx-auto max-w-6xl">
      @if (isMovil()) {
        <!-- MÓVIL: Header con título y navegación -->
        <div class="mb-4 flex items-center justify-between">
          <!-- Back + Título -->
          <div class="flex items-center gap-3">
            <button
              type="button"
              routerLink="/inicio"
              class="flex h-10 w-10 items-center justify-center rounded-xl
                     bg-white/60 backdrop-blur-md border border-white/40
                     text-zinc-600 transition-all duration-200
                     hover:bg-white/80 hover:scale-105 active:scale-95"
              aria-label="Volver al inicio"
            >
              <span class="material-symbols-outlined text-xl">arrow_back</span>
            </button>
            <div>
              <h1 class="titulo-kengo text-2xl text-[#e75c3e]">Galería</h1>
              @if (rutinas().length > 0) {
                <p class="text-xs font-medium text-zinc-500 tracking-wide">
                  {{ rutinas().length }} {{ rutinas().length === 1 ? 'rutina' : 'rutinas' }}
                </p>
              }
            </div>
          </div>

          <!-- Action: Create -->
          <button
            type="button"
            (click)="crearRutina()"
            class="flex h-10 items-center justify-center gap-1.5 rounded-full
                   bg-[#e75c3e] px-4 text-white font-medium text-sm
                   shadow-md shadow-[#e75c3e]/25
                   transition-all duration-200
                   hover:bg-[#d14d30] hover:shadow-lg active:scale-95"
            aria-label="Crear rutina"
          >
            <span class="material-symbols-outlined text-xl">add</span>
            <span>Crear rutina</span>
          </button>
        </div>
      }

      <!-- Toggle + Búsqueda + Filtros -->
      <div class="flex items-center gap-2">
        <!-- Toggle Galería -->
        <app-toggle-galeria />

        <!-- DESKTOP: Contador de rutinas -->
        @if (!isMovil() && rutinas().length > 0) {
          <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/50 backdrop-blur-md shrink-0">
            <span class="text-sm font-bold text-[#e75c3e]">{{ rutinas().length }}</span>
            <span class="text-xs text-zinc-500">{{ rutinas().length === 1 ? 'rutina' : 'rutinas' }}</span>
          </div>
        }

        <!-- Buscador con glassmorphism -->
        <div class="search-container relative flex-1">
          <div class="search-glow absolute -inset-1 rounded-2xl bg-gradient-to-r from-[#e75c3e]/20 to-[#efc048]/20 blur-lg opacity-0 transition-opacity"></div>
          <div class="relative flex items-center">
            <span class="material-symbols-outlined absolute left-3.5 text-[#e75c3e] text-xl z-10">search</span>
            <input
              type="text"
              class="search-input h-12 w-full rounded-2xl
                     bg-white/70 backdrop-blur-xl
                     border border-white/50
                     pl-11 pr-10
                     text-zinc-800 text-sm font-medium
                     placeholder:text-zinc-400 placeholder:font-normal
                     shadow-sm shadow-black/5
                     transition-all duration-300
                     focus:bg-white/90 focus:border-[#e75c3e]/40
                     focus:shadow-lg focus:shadow-[#e75c3e]/10
                     focus:outline-none"
              placeholder="Buscar rutina..."
              [(ngModel)]="busquedaRutinas"
              (ngModelChange)="onBusquedaRutinasChange($event)"
            />
            @if (busquedaRutinas) {
              <button
                type="button"
                class="absolute right-3 p-1 rounded-full
                       text-zinc-400 hover:text-zinc-600
                       hover:bg-zinc-100 transition-all active:scale-90"
                (click)="busquedaRutinas = ''; onBusquedaRutinasChange('')"
                aria-label="Limpiar búsqueda"
              >
                <span class="material-symbols-outlined text-lg">close</span>
              </button>
            }
          </div>
        </div>

        <!-- Botón Filtros con dropdown -->
        <div class="filter-dropdown-container relative">
          <button
            type="button"
            (click)="toggleFiltroMenu(); $event.stopPropagation()"
            class="filter-btn relative flex h-12 w-12 items-center justify-center
                   rounded-2xl bg-white/70 backdrop-blur-xl
                   border border-white/50 shadow-sm
                   text-zinc-600 transition-all duration-200
                   hover:bg-white/90 hover:shadow-md active:scale-95"
            [class.ring-2]="filtroMenuAbierto()"
            [class.ring-[#e75c3e]/30]="filtroMenuAbierto()"
            aria-label="Filtrar rutinas"
            [attr.aria-expanded]="filtroMenuAbierto()"
          >
            <span class="material-symbols-outlined text-xl">tune</span>
            @if (filtroVisibilidad !== 'todas') {
              <span class="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center
                           rounded-full bg-[#e75c3e] text-[10px] font-bold text-white
                           shadow-lg shadow-[#e75c3e]/40 animate-bounce-subtle">
                1
              </span>
            }
          </button>

          <!-- Dropdown de filtros -->
          @if (filtroMenuAbierto()) {
            <div
              class="filter-dropdown absolute right-0 top-full mt-2 z-50
                     w-72 p-4 rounded-2xl
                     bg-white/95 backdrop-blur-xl
                     border border-white/50
                     shadow-2xl shadow-black/20"
              (click)="$event.stopPropagation()"
            >
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                  <div class="flex h-8 w-8 items-center justify-center rounded-xl bg-[#e75c3e]/10">
                    <span class="material-symbols-outlined text-lg text-[#e75c3e]">filter_list</span>
                  </div>
                  <span class="text-base font-bold text-zinc-800">Visibilidad</span>
                </div>
                @if (filtroVisibilidad !== 'todas') {
                  <span class="text-xs font-medium text-[#e75c3e] bg-[#e75c3e]/10 px-2 py-1 rounded-full">
                    Filtro activo
                  </span>
                }
              </div>

              <div class="h-px bg-gradient-to-r from-transparent via-zinc-200 to-transparent mb-3"></div>

              <div class="space-y-1">
                @for (opcion of opcionesFiltro; track opcion.value) {
                  <label
                    class="flex items-center gap-3 p-2.5 rounded-xl cursor-pointer
                           transition-colors hover:bg-[#e75c3e]/5"
                    [class.bg-[#e75c3e]/10]="filtroVisibilidad === opcion.value"
                  >
                    <div class="relative flex items-center justify-center">
                      <input
                        type="radio"
                        name="visibilidad"
                        [value]="opcion.value"
                        [checked]="filtroVisibilidad === opcion.value"
                        (change)="onFiltroVisibilidadChange(opcion.value)"
                        class="peer sr-only"
                      />
                      <div class="h-5 w-5 rounded-full border-2 border-zinc-300
                                  peer-checked:border-[#e75c3e]
                                  transition-all duration-200
                                  flex items-center justify-center">
                        <div class="h-2.5 w-2.5 rounded-full bg-[#e75c3e]
                                    scale-0 peer-checked:scale-100 transition-transform"></div>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="material-symbols-outlined text-lg text-zinc-500">{{ opcion.icon }}</span>
                      <span class="text-sm font-medium text-zinc-700 select-none">{{ opcion.label }}</span>
                    </div>
                  </label>
                }
              </div>

              <div class="h-px bg-gradient-to-r from-transparent via-zinc-200 to-transparent my-3"></div>

              <div class="flex gap-2">
                <button
                  type="button"
                  (click)="limpiarFiltro()"
                  class="flex-1 h-10 rounded-xl border border-zinc-200
                         text-sm font-medium text-zinc-600
                         transition-all hover:bg-zinc-50 active:scale-98"
                >
                  Limpiar
                </button>
                <button
                  type="button"
                  (click)="cerrarFiltroMenu()"
                  class="flex-1 h-10 rounded-xl
                         bg-gradient-to-r from-[#e75c3e] to-[#d14d30]
                         text-sm font-semibold text-white
                         shadow-lg shadow-[#e75c3e]/30
                         transition-all hover:shadow-xl hover:shadow-[#e75c3e]/40
                         active:scale-98"
                >
                  Aplicar
                </button>
              </div>
            </div>
          }
        </div>

        <!-- DESKTOP: Crear -->
        @if (!isMovil()) {
          <div class="flex items-center gap-2 ml-2 pl-2 border-l border-zinc-200/50">
            <button
              type="button"
              class="inline-flex h-10 items-center justify-center gap-2 rounded-xl
                     bg-[#e75c3e] px-4 text-sm font-semibold text-white
                     shadow-md shadow-[#e75c3e]/25
                     transition-all duration-200
                     hover:bg-[#d14d30] hover:shadow-lg active:scale-95"
              (click)="crearRutina()"
            >
              <span class="material-symbols-outlined text-xl">add</span>
              <span>Crear rutina</span>
            </button>
          </div>
        }
      </div>
    </div>
  </header>

  <!-- Contenido principal con scroll -->
  <main class="flex-1 overflow-y-auto px-4 pb-28 lg:pb-8">
    <div class="mx-auto max-w-6xl">
      @if (isLoadingRutinas()) {
        <!-- Loading State -->
        <div class="tarjeta-kengo rounded-2xl p-6">
          <div class="flex items-center justify-center gap-3">
            <div class="h-1.5 w-48 overflow-hidden rounded-full bg-zinc-100">
              <div class="progress-bar-indeterminate h-full w-1/3 rounded-full"></div>
            </div>
          </div>
        </div>
      } @else if (rutinas().length === 0) {
        <!-- Empty State -->
        <div class="tarjeta-kengo empty-state rounded-3xl">
          <div class="empty-state-icon">
            <span class="material-symbols-outlined">bookmarks</span>
          </div>
          <h3 class="text-lg font-semibold text-zinc-700">No tienes rutinas guardadas</h3>
          <p class="mt-2 max-w-xs text-sm text-zinc-500">
            Crea tu primera rutina de ejercicios para reutilizarla con tus pacientes
          </p>
          <button
            type="button"
            class="mt-5 inline-flex h-12 items-center justify-center gap-2 rounded-xl
                   bg-[#e75c3e] px-6 text-sm font-semibold text-white
                   shadow-lg shadow-[#e75c3e]/30
                   transition-all duration-200
                   hover:bg-[#d14d30] hover:shadow-xl hover:shadow-[#e75c3e]/40
                   active:scale-98"
            (click)="crearRutina()"
          >
            <span class="material-symbols-outlined text-xl">add</span>
            Crear primera rutina
          </button>
        </div>
      } @else {
        <!-- Lista de rutinas -->
        <div class="space-y-4">
          @for (rutina of rutinas(); track rutina.id_rutina) {
            <div class="tarjeta-kengo rutina-card rounded-2xl cursor-pointer"
                 [class.expanded]="expandedRutinaId() === rutina.id_rutina"
                 [class.menu-open]="openRutinaMenuId === rutina.id_rutina"
                 (click)="togglePreview(rutina)">
              <!-- Header rutina -->
              <div class="flex items-start gap-4 p-5">
                <!-- Icono -->
                <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-xl
                            bg-gradient-to-br from-[#efc048]/20 to-[#e75c3e]/10">
                  <span class="material-symbols-outlined text-2xl text-[#efc048]">bookmark</span>
                </div>

                <div class="min-w-0 flex-1">
                  <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <h3 class="font-bold text-zinc-800">{{ rutina.nombre }}</h3>
                      @if (rutina.descripcion) {
                        <p class="mt-1 line-clamp-2 text-sm text-zinc-600">
                          {{ rutina.descripcion }}
                        </p>
                      }
                      <!-- Badge visibilidad (móvil: debajo de descripción) -->
                      <span class="visibility-badge mt-2 inline-flex lg:hidden"
                            [class.private]="rutina.visibilidad === 'privado'"
                            [class.public]="rutina.visibilidad === 'clinica'">
                        <span class="material-symbols-outlined text-xs">
                          {{ rutina.visibilidad === "privado" ? "lock" : "domain" }}
                        </span>
                        {{ rutina.visibilidad === "privado" ? "Privada" : "Clínica" }}
                      </span>
                    </div>

                    <!-- Badge visibilidad (desktop: en línea) -->
                    <span class="visibility-badge hidden shrink-0 lg:inline-flex"
                          [class.private]="rutina.visibilidad === 'privado'"
                          [class.public]="rutina.visibilidad === 'clinica'">
                      <span class="material-symbols-outlined text-xs">
                        {{ rutina.visibilidad === "privado" ? "lock" : "domain" }}
                      </span>
                      {{ rutina.visibilidad === "privado" ? "Privada" : "Clínica" }}
                    </span>
                  </div>

                  <!-- Metadata -->
                  <div class="mt-3 flex flex-wrap items-center gap-3 text-xs text-zinc-500">
                    @if (rutina.date_created) {
                      <span class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-sm">schedule</span>
                        {{ formatDateLong(rutina.date_created) }}
                      </span>
                    }
                    @if (!isOwner(rutina)) {
                      <span class="rounded-full bg-[#efc048]/10 px-2 py-0.5 text-[#efc048] font-medium">
                        De otro fisio
                      </span>
                    }
                  </div>
                </div>

                <!-- Menu acciones rutina -->
                <div class="relative shrink-0" (click)="$event.stopPropagation()">
                  <button
                    type="button"
                    class="flex h-10 w-10 items-center justify-center rounded-xl
                           text-zinc-500 transition-all hover:bg-zinc-100"
                    (click)="toggleRutinaMenu(rutina.id_rutina)"
                  >
                    <span class="material-symbols-outlined">more_vert</span>
                  </button>
                  @if (openRutinaMenuId === rutina.id_rutina) {
                    <div class="dropdown-menu right-0">
                      <button
                        type="button"
                        class="dropdown-item"
                        (click)="asignarAPaciente(rutina); openRutinaMenuId = null"
                      >
                        <span class="material-symbols-outlined text-xl">assignment_ind</span>
                        <span>Asignar a paciente</span>
                      </button>
                      <button
                        type="button"
                        class="dropdown-item"
                        (click)="duplicarRutina(rutina); openRutinaMenuId = null"
                      >
                        <span class="material-symbols-outlined text-xl">content_copy</span>
                        <span>Duplicar</span>
                      </button>
                      @if (isOwner(rutina)) {
                        <hr class="my-1.5 border-zinc-100" />
                        <button
                          type="button"
                          class="dropdown-item"
                          (click)="cambiarVisibilidadRutina(rutina); openRutinaMenuId = null"
                        >
                          <span class="material-symbols-outlined text-xl">
                            {{ rutina.visibilidad === "privado" ? "domain" : "lock" }}
                          </span>
                          <span>
                            {{ rutina.visibilidad === "privado" ? "Compartir con clínica" : "Hacer privada" }}
                          </span>
                        </button>
                        <button
                          type="button"
                          class="dropdown-item text-red-500"
                          (click)="eliminarRutina(rutina); openRutinaMenuId = null"
                        >
                          <span class="material-symbols-outlined text-xl">delete</span>
                          <span>Eliminar</span>
                        </button>
                      }
                    </div>
                  }
                </div>
              </div>

              <!-- Panel preview -->
              @if (expandedRutinaId() === rutina.id_rutina) {
                <div class="border-t border-zinc-100 bg-zinc-50/50 p-4">
                  @if (loadingPreview()) {
                    <div class="h-1.5 overflow-hidden rounded-full bg-zinc-200">
                      <div class="progress-bar-indeterminate h-full w-1/3 rounded-full"></div>
                    </div>
                  } @else if (previewEjercicios().length > 0) {
                    <div class="space-y-2.5">
                      @for (ej of previewEjercicios(); track ej.id; let i = $index) {
                        <div class="flex items-center gap-3 rounded-xl bg-white p-3
                                    shadow-sm ring-1 ring-zinc-100">
                          <div class="h-11 w-11 shrink-0 overflow-hidden rounded-lg bg-zinc-100">
                            @if (ej.ejercicio.portada) {
                              <img
                                [src]="assetUrl(ej.ejercicio.portada)"
                                class="h-full w-full object-cover"
                              />
                            } @else {
                              <div class="flex h-full w-full items-center justify-center">
                                <span class="material-symbols-outlined text-zinc-300">fitness_center</span>
                              </div>
                            }
                          </div>
                          <div class="min-w-0 flex-1">
                            <p class="text-sm font-semibold text-zinc-800">
                              {{ i + 1 }}. {{ ej.ejercicio.nombre_ejercicio }}
                            </p>
                            <p class="mt-0.5 text-xs text-zinc-500">
                              {{ ej.series || 3 }} series x {{ ej.repeticiones || 12 }} reps
                              @if (ej.descanso_seg) {
                                <span class="text-zinc-400">· {{ ej.descanso_seg }}s descanso</span>
                              }
                            </p>
                          </div>
                        </div>
                      }
                    </div>
                    <!-- Botón asignar a paciente -->
                    <button
                      type="button"
                      class="mt-4 flex w-full items-center justify-center gap-2 rounded-xl
                             bg-[#e75c3e] px-4 py-3 text-sm font-semibold text-white
                             shadow-md shadow-[#e75c3e]/25
                             transition-all duration-200
                             hover:bg-[#d14d30] hover:shadow-lg active:scale-[0.98]"
                      (click)="asignarAPaciente(rutina); $event.stopPropagation()"
                    >
                      <span class="material-symbols-outlined text-xl">assignment_ind</span>
                      <span>Asignar a paciente</span>
                    </button>
                  } @else {
                    <p class="py-4 text-center text-sm text-zinc-500">
                      Esta rutina no tiene ejercicios
                    </p>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  </main>
</section>
