<!-- Backdrop overlay -->
@if (drawerAbierto()) {
  <div
    class="fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm transition-opacity duration-300"
    (click)="toggle()"
  ></div>
}

<!-- Drawer panel -->
<div
  #drawerEl
  class="fixed top-0 right-0 z-[70] h-full w-80 transform transition-transform duration-300 ease-out"
  [class.translate-x-0]="drawerAbierto()"
  [class.translate-x-full]="!drawerAbierto()"
>
  <div
    class="flex h-full w-full flex-col border-l border-white/20 bg-white/80 backdrop-blur-xl"
  >
    <!-- Cabecera -->
    <div
      class="flex items-center justify-between border-b border-zinc-200/50 px-4 py-3"
      [class.bg-amber-50/50]="isRutinaMode()"
    >
      <h2 class="titulo-kengo text-lg" [class.text-amber-600]="isRutinaMode()">
        {{ isRutinaMode() ? 'Nueva rutina' : 'Plan de ejercicios' }}
      </h2>
      <button
        type="button"
        (click)="toggle()"
        class="flex h-9 w-9 items-center justify-center rounded-xl bg-zinc-100/80 transition-colors hover:bg-zinc-200"
        aria-label="Cerrar panel"
      >
        <span class="material-symbols-outlined text-xl text-zinc-600">close</span>
      </button>
    </div>

    <!-- Paciente seleccionado / Modo Rutina -->
    <div class="border-b border-zinc-200/50 px-4 py-4">
      @if (isRutinaMode()) {
        <!-- Modo Rutina: sin paciente -->
        <div class="flex items-center gap-3">
          <div
            class="flex h-14 w-14 shrink-0 items-center justify-center rounded-full bg-amber-100 shadow-md ring-2 ring-white"
          >
            <span
              class="material-symbols-outlined text-3xl text-amber-600"
              aria-hidden="true"
              >bookmark_add</span
            >
          </div>
          <div class="min-w-0 flex-1">
            <p class="truncate text-base font-semibold text-zinc-800">
              Creando rutina
            </p>
            <p class="text-sm text-zinc-500">
              {{ total() }}
              {{ total() === 1 ? "ejercicio" : "ejercicios" }} seleccionados
            </p>
          </div>
          <button
            type="button"
            class="flex h-8 w-8 shrink-0 items-center justify-center rounded-full text-zinc-400 transition-all hover:bg-red-50 hover:text-red-500"
            aria-label="Salir modo rutina"
            (click)="salirModoRutina()"
          >
            <span class="material-symbols-outlined text-xl">close</span>
          </button>
        </div>
      } @else {
        <!-- Modo Plan: con paciente -->
        <div class="flex items-center gap-3">
          @if (perfilUrl()) {
            <img
              [src]="perfilUrl()"
              alt="Avatar del paciente"
              class="h-14 w-14 shrink-0 rounded-full object-cover shadow-md ring-2 ring-white"
            />
          } @else {
            <div
              class="flex h-14 w-14 shrink-0 items-center justify-center rounded-full bg-zinc-100 shadow-md ring-2 ring-white"
            >
              <span
                class="material-symbols-outlined text-3xl text-zinc-400"
                aria-hidden="true"
                >person</span
              >
            </div>
          }
          <div class="min-w-0 flex-1">
            <p class="truncate text-base font-semibold text-zinc-800">
              {{ pacienteNombre() }}
            </p>
            <p class="text-sm text-zinc-500">
              {{ total() }}
              {{ total() === 1 ? "ejercicio" : "ejercicios" }} seleccionados
            </p>
          </div>
          <button
            type="button"
            class="flex h-8 w-8 shrink-0 items-center justify-center rounded-full text-zinc-400 transition-all hover:bg-red-50 hover:text-red-500"
            aria-label="Eliminar asignación"
            (click)="eliminarAsignacion()"
          >
            <span class="material-symbols-outlined text-xl">person_remove</span>
          </button>
        </div>
      }
    </div>

    <!-- Lista de items del carrito -->
    <div class="flex flex-1 flex-col gap-2 overflow-auto p-4">
      @if (svc.items().length) {
        @for (it of svc.items(); track it.ejercicio.id_ejercicio) {
          <div
            class="group flex items-center gap-3 rounded-xl bg-white/60 p-3 shadow-sm ring-1 ring-zinc-200/50 transition-all hover:bg-white/80 hover:shadow-md"
          >
            <div
              class="h-14 w-20 shrink-0 overflow-hidden rounded-lg bg-zinc-100"
            >
              @if (it.ejercicio.portada) {
                <img
                  [src]="assetUrl(it.ejercicio.portada)"
                  alt=""
                  class="h-full w-full object-cover"
                />
              } @else {
                <div
                  class="flex h-full w-full items-center justify-center text-zinc-300"
                >
                  <span class="material-symbols-outlined">fitness_center</span>
                </div>
              }
            </div>
            <div class="min-w-0 flex-1">
              <p class="line-clamp-2 text-sm font-medium text-zinc-800">
                {{ it.ejercicio.nombre_ejercicio }}
              </p>
              <p class="mt-0.5 text-xs text-zinc-500">
                {{ it.series || "—" }} series ×
                {{ it.repeticiones || "—" }} reps
                @if (it.duracion_seg) {
                  <span class="text-zinc-400"> • {{ it.duracion_seg }}s</span>
                }
                @if (it.veces_dia) {
                  <span class="text-zinc-400"> • {{ it.veces_dia }}/día</span>
                }
              </p>
            </div>

            <button
              type="button"
              class="flex h-8 w-8 shrink-0 items-center justify-center rounded-full text-zinc-400 opacity-60 transition-all group-hover:opacity-100 hover:bg-red-50 hover:text-red-500"
              aria-label="Eliminar ejercicio"
              (click)="eliminar(it.ejercicio.id_ejercicio)"
            >
              <span class="material-symbols-outlined text-xl">delete</span>
            </button>
          </div>
        }
        <!-- Botón añadir ejercicio al final de la lista -->
        <button
          type="button"
          class="flex items-center justify-center gap-2 rounded-xl border-2 border-dashed border-zinc-300 bg-white/40 p-3 text-zinc-500 transition-all hover:border-kengo-primary hover:bg-kengo-primary/5 hover:text-kengo-primary"
          (click)="irAEjercicios()"
          aria-label="Añadir ejercicio"
        >
          <span class="material-symbols-outlined text-2xl">add</span>
          <span class="text-sm font-medium">Añadir ejercicio</span>
        </button>
      } @else {
        <div
          class="flex flex-1 flex-col items-center justify-center px-6 text-center"
        >
          <!-- Botón añadir ejercicio cuando no hay ejercicios -->
          <button
            type="button"
            class="mb-3 flex h-16 w-16 items-center justify-center rounded-full bg-kengo-primary/10 text-kengo-primary transition-all hover:scale-105 hover:bg-kengo-primary/20"
            (click)="irAEjercicios()"
            aria-label="Añadir ejercicio"
          >
            <span class="material-symbols-outlined text-4xl">add</span>
          </button>
          <p class="text-sm font-medium text-zinc-600">
            No hay ejercicios en el plan
          </p>
          <p class="mt-1 text-xs text-zinc-400">
            Pulsa para añadir ejercicios
          </p>
        </div>
      }
    </div>

    <!-- Acciones -->
    <div
      class="flex flex-col gap-2 border-t border-zinc-200/50 bg-white/50 p-4"
    >
      @if (isRutinaMode()) {
        <!-- Acciones para modo Rutina -->
        <button
          type="button"
          class="inline-flex h-12 w-full items-center justify-center gap-2 rounded-xl bg-amber-500 px-6 text-sm font-semibold text-white shadow-lg shadow-amber-500/25 transition-all duration-200 hover:bg-amber-600 hover:shadow-xl hover:shadow-amber-500/30 disabled:cursor-not-allowed disabled:bg-zinc-300 disabled:shadow-none"
          [disabled]="!svc.items().length"
          (click)="guardarRutinaDirectamente()"
        >
          <span class="material-symbols-outlined text-xl">bookmark_add</span>
          <span>Guardar rutina</span>
        </button>

        <div class="flex gap-2">
          <button
            type="button"
            class="inline-flex h-11 flex-1 items-center justify-center gap-2 rounded-xl border border-zinc-200 bg-white/80 px-4 text-sm font-medium text-zinc-700 transition-all hover:border-zinc-300 hover:bg-zinc-50 disabled:cursor-not-allowed disabled:opacity-50"
            [disabled]="!svc.items().length"
            (click)="configurarRutina()"
          >
            <span class="material-symbols-outlined text-xl text-amber-500">tune</span>
            <span>Dosificación</span>
          </button>

          <button
            type="button"
            class="inline-flex h-11 flex-1 items-center justify-center gap-2 rounded-xl border border-zinc-200 bg-white/80 px-4 text-sm font-medium text-zinc-700 transition-all hover:border-zinc-300 hover:bg-zinc-50"
            (click)="cargarRutina()"
          >
            <span class="material-symbols-outlined text-xl text-zinc-500">folder_open</span>
            <span>Cargar</span>
          </button>
        </div>
      } @else {
        <!-- Acciones para modo Plan -->
        <button
          type="button"
          class="inline-flex h-12 w-full items-center justify-center gap-2 rounded-xl bg-kengo-primary px-6 text-sm font-semibold text-white shadow-lg-kengo-primary/25 transition-all duration-200 hover:bg-kengo-primary-dark hover:shadow-xl-kengo-primary/30 disabled:cursor-not-allowed disabled:bg-zinc-300 disabled:shadow-none"
          [disabled]="!svc.items().length || !svc.paciente()"
          (click)="configurarPlan()"
        >
          <span>Configurar plan</span>
          <span class="material-symbols-outlined text-xl">arrow_forward</span>
        </button>

        <div class="flex gap-2">
          <button
            type="button"
            class="inline-flex h-11 flex-1 items-center justify-center gap-2 rounded-xl border border-zinc-200 bg-white/80 px-4 text-sm font-medium text-zinc-700 transition-all hover:border-zinc-300 hover:bg-zinc-50 disabled:cursor-not-allowed disabled:opacity-50"
            [disabled]="!svc.paciente()"
            (click)="cargarRutina()"
          >
            <span class="material-symbols-outlined text-xl text-zinc-500">bookmarks</span>
            <span>Rutinas</span>
          </button>

          <button
            type="button"
            class="inline-flex h-11 flex-1 items-center justify-center gap-2 rounded-xl border border-zinc-200 bg-white/80 px-4 text-sm font-medium text-zinc-700 transition-all hover:border-zinc-300 hover:bg-zinc-50"
            (click)="cambiarPaciente()"
          >
            <span class="material-symbols-outlined text-xl text-zinc-500">person_search</span>
            <span>Paciente</span>
          </button>
        </div>
      }
    </div>
  </div>
</div>

<!-- Botón pestaña lateral para abrir el drawer (si hay paciente O modo rutina, y no estamos en /planes) -->
@if ((svc.paciente() || isRutinaMode()) && !ocultarTab()) {
  <button
    type="button"
    class="tab-carrito pointer-events-auto"
    [class.tab-carrito--abierto]="drawerAbierto()"
    [class.tab-carrito--rutina]="isRutinaMode()"
    (click)="toggle()"
    [attr.aria-label]="isRutinaMode() ? 'Abrir carrito de rutina' : 'Abrir carrito de ejercicios'"
  >
    <div class="tab-carrito__contenido">
      @if (isRutinaMode()) {
        <!-- Modo Rutina: icono bookmark -->
        <div
          class="flex h-10 w-10 items-center justify-center rounded-full bg-white/90"
        >
          <span
            class="material-symbols-outlined text-2xl text-amber-500"
            aria-hidden="true"
            >bookmark_add</span
          >
        </div>
      } @else if (perfilUrl()) {
        <img
          [src]="perfilUrl()"
          alt=""
          class="h-10 w-10 rounded-full object-cover ring-2 ring-white"
        />
      } @else {
        <div
          class="flex h-10 w-10 items-center justify-center rounded-full bg-white/90"
        >
          <span
            class="material-symbols-outlined text-2xl text-kengo-primary"
            aria-hidden="true"
            >personal_injury</span
          >
        </div>
      }
      @if (total() > 0) {
        <span class="tab-carrito__badge" [class.tab-carrito__badge--rutina]="isRutinaMode()">{{ total() }}</span>
      }
    </div>
    <span class="tab-carrito__label">{{ isRutinaMode() ? 'Rutina' : 'Asignar' }}</span>
  </button>
}
