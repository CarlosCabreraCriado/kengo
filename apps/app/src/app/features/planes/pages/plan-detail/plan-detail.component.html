@if (isLoading()) {
  <div class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner">
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
      </div>
      <p class="loading-text">Cargando plan...</p>
    </div>
  </div>
}

<section class="plan-detail-container">
  <!-- Decorative background elements -->
  <div class="bg-decoration">
    <div class="bg-orb bg-orb-1"></div>
    <div class="bg-orb bg-orb-2"></div>
    <div class="bg-orb bg-orb-3"></div>
    <div class="bg-mesh"></div>
  </div>

  <!-- Floating Header -->
  <header class="header-glass sticky top-0 z-50 shrink-0 px-4 pt-3 pb-4">
    <div class="mx-auto max-w-4xl">

      <!-- MÓVIL: Header completo con título y navegación -->
      @if (isMovil()) {
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <button
              type="button"
              class="header-btn"
              aria-label="Volver"
              (click)="volver()"
            >
              <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <div>
              <h1 class="header-title titulo-kengo">Plan de Tratamiento</h1>
              @if (plan(); as p) {
                <p class="text-xs font-medium text-zinc-500">{{ totalEjercicios() }} ejercicios</p>
              }
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button
              type="button"
              class="header-btn header-btn-pdf"
              aria-label="Descargar PDF"
              [disabled]="descargandoPdf()"
              (click)="descargarPdf()"
            >
              @if (descargandoPdf()) {
                <span class="material-symbols-outlined spin">progress_activity</span>
              } @else {
                <span class="material-symbols-outlined">picture_as_pdf</span>
              }
            </button>
            <button
              type="button"
              class="header-btn header-btn-edit"
              aria-label="Editar plan"
              (click)="editarPlan()"
            >
              <span class="material-symbols-outlined">edit</span>
            </button>
          </div>
        </div>
      } @else {
        <!-- DESKTOP: Header simplificado (solo controles) -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            @if (plan(); as p) {
              <div class="flex items-center gap-2 px-4 py-2 rounded-xl bg-white/50 backdrop-blur-md">
                <span class="material-symbols-outlined text-lg text-kengo-primary">assignment</span>
                <span class="text-sm font-bold text-zinc-700 truncate max-w-[200px]">{{ p.titulo }}</span>
                <span class="text-zinc-300">|</span>
                <span class="text-sm font-semibold text-kengo-primary">{{ totalEjercicios() }}</span>
                <span class="text-xs text-zinc-500">ejercicios</span>
              </div>
            }
          </div>

          <div class="flex items-center gap-2">
            <button
              type="button"
              class="header-btn-desktop"
              [disabled]="descargandoPdf()"
              (click)="descargarPdf()"
            >
              @if (descargandoPdf()) {
                <span class="material-symbols-outlined text-lg spin">progress_activity</span>
                <span class="text-xs font-semibold">Generando...</span>
              } @else {
                <span class="material-symbols-outlined text-lg">picture_as_pdf</span>
                <span class="text-xs font-semibold">PDF</span>
              }
            </button>

            <button
              type="button"
              class="header-btn-desktop"
              (click)="editarPlan()"
            >
              <span class="material-symbols-outlined text-lg">edit</span>
              <span class="text-xs font-semibold">Editar</span>
            </button>

            <button
              type="button"
              class="header-btn-desktop header-btn-desktop-primary"
              (click)="crearOtroPlan()"
            >
              <span class="material-symbols-outlined text-lg">add</span>
              <span class="text-xs font-semibold">Nuevo plan</span>
            </button>
          </div>
        </div>
      }

    </div>
  </header>

  <!-- Main Content -->
  <div class="content-wrapper">
    @if (plan(); as p) {
      <!-- Success Hero (only shown after create/update) -->
      @if (showSuccessHero()) {
        <div class="success-hero animate-in" style="--delay: 0s">
          <div class="success-badge">
            <div class="success-icon-wrapper">
              <div class="success-icon">
                <span class="material-symbols-outlined relleno">check_circle</span>
              </div>
              <div class="success-rings">
                <div class="ring ring-1"></div>
                <div class="ring ring-2"></div>
                <div class="ring ring-3"></div>
              </div>
            </div>
            <div class="success-confetti">
              @for (i of [1,2,3,4,5,6,7,8]; track i) {
                <div class="confetti-piece" [style.--i]="i"></div>
              }
            </div>
          </div>
          <h2 class="success-title titulo-kengo">{{ heroTitle() }}</h2>
          <p class="success-subtitle">{{ heroSubtitle() }}</p>
        </div>
      }

      <!-- Patient Card -->
      @if (paciente(); as pac) {
        <div
          class="patient-card animate-in"
          [style.--delay]="showSuccessHero() ? '0.15s' : '0s'"
          (click)="verPerfilPaciente()"
          role="button"
          tabindex="0"
          (keydown.enter)="verPerfilPaciente()"
        >
          <div class="patient-avatar-wrapper">
            @if (pac.avatar) {
              <img
                [src]="avatarUrl(pac.avatar)"
                alt="Avatar de {{ pac.first_name }}"
                class="patient-avatar"
              />
            } @else {
              <div class="patient-avatar patient-avatar-placeholder">
                <span class="material-symbols-outlined">person</span>
              </div>
            }
            <div class="patient-status-dot"></div>
          </div>
          <div class="patient-info">
            <span class="patient-label">Paciente</span>
            <h3 class="patient-name">{{ pac.first_name }} {{ pac.last_name }}</h3>
            <p class="patient-email">{{ pac.email }}</p>
          </div>
          <div class="patient-action-icon">
            <span class="material-symbols-outlined">chevron_right</span>
          </div>
        </div>
      }

      <!-- Plan Info Card -->
      <div class="plan-card animate-in" [style.--delay]="showSuccessHero() ? '0.25s' : '0.1s'">
        <div class="plan-header">
          <div class="plan-badge">
            <span class="material-symbols-outlined">assignment</span>
          </div>
          <div class="plan-title-group">
            <h2 class="plan-title">{{ p.titulo }}</h2>
            @if (p.descripcion) {
              <p class="plan-description">{{ p.descripcion }}</p>
            }
          </div>
        </div>

        <!-- Stats Row -->
        <div class="stats-row">
          <div class="stat-item">
            <div class="stat-icon stat-icon-start">
              <span class="material-symbols-outlined">event_available</span>
            </div>
            <div class="stat-content">
              <span class="stat-label">Inicio</span>
              <span class="stat-value">{{ formatDate(p.fecha_inicio) }}</span>
            </div>
          </div>

          <div class="stat-divider"></div>

          <div class="stat-item">
            <div class="stat-icon stat-icon-end">
              <span class="material-symbols-outlined">event_busy</span>
            </div>
            <div class="stat-content">
              <span class="stat-label">Fin</span>
              <span class="stat-value">{{ formatDate(p.fecha_fin) }}</span>
            </div>
          </div>

          <div class="stat-divider"></div>

          <div class="stat-item">
            <div class="stat-icon stat-icon-exercises">
              <span class="material-symbols-outlined">fitness_center</span>
            </div>
            <div class="stat-content">
              <span class="stat-label">Ejercicios</span>
              <span class="stat-value stat-value-highlight">{{ totalEjercicios() }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Exercises Section -->
      <div class="exercises-section animate-in" [style.--delay]="showSuccessHero() ? '0.35s' : '0.2s'">
        <div class="section-header">
          <h3 class="section-title">
            <span class="section-icon">
              <span class="material-symbols-outlined">list_alt</span>
            </span>
            Rutina de ejercicios
          </h3>
          <span class="exercise-count">{{ totalEjercicios() }} ejercicios</span>
        </div>

        <div class="exercises-list">
          @for (item of items(); track item.id; let i = $index) {
            <div
              class="exercise-card"
              [style.--index]="i"
              [style.animation-delay]="(showSuccessHero() ? 0.4 : 0.25) + (i * 0.06) + 's'"
            >
              <div class="exercise-number">{{ i + 1 }}</div>

              <div class="exercise-thumbnail">
                @if (item.ejercicio.portada) {
                  <img
                    [src]="assetUrl(item.ejercicio.portada, 120, 120)"
                    [alt]="item.ejercicio.nombre_ejercicio"
                    loading="lazy"
                  />
                } @else {
                  <div class="exercise-thumbnail-placeholder">
                    <span class="material-symbols-outlined">fitness_center</span>
                  </div>
                }
              </div>

              <div class="exercise-content">
                <h4 class="exercise-name">{{ item.ejercicio.nombre_ejercicio }}</h4>

                <div class="exercise-params">
                  <div class="param-chip param-chip-primary">
                    <span class="material-symbols-outlined">repeat</span>
                    <span>{{ item.series || 3 }} × {{ item.repeticiones || 12 }}</span>
                  </div>

                  @if (item.descanso_seg) {
                    <div class="param-chip param-chip-neutral">
                      <span class="material-symbols-outlined">timer</span>
                      <span>{{ item.descanso_seg }}s</span>
                    </div>
                  }

                  @if (item.veces_dia && item.veces_dia > 1) {
                    <div class="param-chip param-chip-accent">
                      <span class="material-symbols-outlined">schedule</span>
                      <span>{{ item.veces_dia }}×/día</span>
                    </div>
                  }
                </div>

                @if (item.dias_semana && item.dias_semana.length > 0) {
                  <div class="exercise-days">
                    @for (dia of diasSemanaArray; track dia) {
                      <span
                        class="day-badge"
                        [class.day-badge-active]="item.dias_semana.includes(dia)"
                      >
                        {{ dia }}
                      </span>
                    }
                  </div>
                }

                @if (item.instrucciones_paciente) {
                  <p class="exercise-instructions">
                    <span class="material-symbols-outlined">info</span>
                    {{ item.instrucciones_paciente }}
                  </p>
                }
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Action Button -->
      <div class="actions-section animate-in" [style.--delay]="showSuccessHero() ? '0.5s' : '0.35s'">
        <button
          type="button"
          class="action-btn action-btn-primary"
          (click)="irAInicio()"
        >
          <span class="material-symbols-outlined">home</span>
          <span>Volver al inicio</span>
        </button>
      </div>

    } @else if (!isLoading()) {
      <!-- Empty State -->
      <div class="empty-state animate-in">
        <div class="empty-icon-wrapper">
          <div class="empty-icon">
            <span class="material-symbols-outlined">search_off</span>
          </div>
        </div>
        <h3 class="empty-title">Plan no encontrado</h3>
        <p class="empty-description">
          No pudimos encontrar el plan que buscas. Es posible que haya sido eliminado o que no tengas acceso.
        </p>
        <a
          routerLink="/inicio/planes"
          class="action-btn action-btn-primary"
        >
          <span class="material-symbols-outlined">arrow_back</span>
          <span>Ver mis planes</span>
        </a>
      </div>
    }
  </div>
</section>
