<!-- Loading bar premium -->
@if (isLoading() || isSaving()) {
  <div class="loading-bar-container">
    <div class="loading-bar-track">
      <div class="loading-bar-fill"></div>
    </div>
  </div>
}

<section class="plan-builder-container">
  <!-- Header con glassmorfismo (solo mobile < 768px) -->
  @if (isMovil()) {
    <header class="plan-header">
      <div class="plan-header__inner">
        <div class="plan-header__mobile">
          <button
            type="button"
            class="btn-icon-glass"
            aria-label="Volver"
            (click)="cancelar()"
          >
            <span class="material-symbols-outlined">arrow_back</span>
          </button>

          <div class="plan-header__title-group">
            <h1 class="plan-header__title">{{ pageTitle() }}</h1>
            <div class="plan-header__badge">
              <span class="plan-header__badge-dot"></span>
              <span class="plan-header__badge-text">
                {{ totalItems() }} {{ totalItems() === 1 ? "ejercicio" : "ejercicios" }}
              </span>
            </div>
          </div>

          <div class="relative">
            <button
              #menuAccionesMobileBtn
              type="button"
              class="btn-icon-glass"
              [disabled]="isSaving()"
              (click)="menuAccionesMobileOpen = !menuAccionesMobileOpen"
              aria-label="Más opciones"
            >
              <span class="material-symbols-outlined">more_vert</span>
            </button>

            @if (menuAccionesMobileOpen) {
              <div class="dropdown-panel" (clickOutside)="menuAccionesMobileOpen = false">
                <div class="dropdown-panel__header">
                  <span class="dropdown-panel__title">Acciones</span>
                </div>
                <div class="dropdown-panel__body">
                  <button
                    type="button"
                    class="dropdown-action"
                    [disabled]="isLoading()"
                    (click)="cargarPlantilla(); menuAccionesMobileOpen = false"
                  >
                    <span class="dropdown-action__icon dropdown-action__icon--gold">
                      <span class="material-symbols-outlined">folder_open</span>
                    </span>
                    <span class="dropdown-action__content">
                      <span class="dropdown-action__label">Cargar plantilla</span>
                      <span class="dropdown-action__hint">Usar rutina existente</span>
                    </span>
                  </button>
                  <button
                    type="button"
                    class="dropdown-action"
                    [disabled]="items().length === 0"
                    (click)="guardarComoPlantilla(); menuAccionesMobileOpen = false"
                  >
                    <span class="dropdown-action__icon dropdown-action__icon--coral">
                      <span class="material-symbols-outlined">bookmark_add</span>
                    </span>
                    <span class="dropdown-action__content">
                      <span class="dropdown-action__label">Guardar como plantilla</span>
                      <span class="dropdown-action__hint">Reutilizar este plan</span>
                    </span>
                  </button>
                  @if (!isEditMode()) {
                    <div class="dropdown-panel__divider"></div>
                    <a
                      routerLink="/galeria/ejercicios"
                      class="dropdown-action"
                      (click)="menuAccionesMobileOpen = false"
                    >
                      <span class="dropdown-action__icon dropdown-action__icon--green">
                        <span class="material-symbols-outlined">add</span>
                      </span>
                      <span class="dropdown-action__content">
                        <span class="dropdown-action__label">Agregar ejercicios</span>
                        <span class="dropdown-action__hint">Desde el catálogo</span>
                      </span>
                    </a>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    </header>
  }

  <!-- Barra superior desktop -->
  @if (!isMovil()) {
    <div class="plan-back-bar">
      @if (isEditMode()) {
        <div class="plan-top-actions">
          <button type="button" class="btn-back" (click)="cancelar()">
            <span class="material-symbols-outlined">arrow_back</span>
            <span>Cancelar</span>
          </button>
          <button
            type="button"
            class="btn-top-save"
            (click)="guardarPlan()"
            [disabled]="!canSubmit() || isSaving() || !svc.isDirty()"
          >
            @if (isSaving()) {
              <span class="btn-save__spinner"></span>
              <span>Guardando...</span>
            } @else {
              <span class="material-symbols-outlined">check</span>
              <span>Guardar</span>
            }
          </button>
        </div>
      } @else {
        <button type="button" class="btn-back" (click)="cancelar()">
          <span class="material-symbols-outlined">arrow_back</span>
          <span>Volver</span>
        </button>
      }
    </div>
  }

  <!-- Main content -->
  <div class="plan-content">
    <div class="plan-content__inner">

      <!-- Card principal del plan -->
      <article class="plan-card plan-card--main">
        <!-- Paciente section -->
        @if (paciente(); as p) {
          <div class="plan-card__section plan-card__section--patient">
            <div class="patient-info">
              <div class="patient-avatar">
                @if (p.avatar) {
                  <img
                    [src]="avatarUrl(p.avatar)"
                    alt="Avatar de {{ p.first_name }}"
                    class="patient-avatar__img"
                  />
                } @else {
                  <div class="patient-avatar__fallback">
                    <span class="material-symbols-outlined">person</span>
                  </div>
                }
                <span class="patient-avatar__status"></span>
              </div>
              <div class="patient-details">
                <h3 class="patient-name">{{ p.first_name }} {{ p.last_name }}</h3>
                <p class="patient-email">{{ p.email }}</p>
              </div>
            </div>
            <div class="patient-section__actions">
              <div class="patient-badge">
                <span class="material-symbols-outlined">healing</span>
                Paciente
              </div>
              <!-- Menu acciones rápidas (solo desktop >= 768px) -->
              @if (!isMovil()) {
                <div class="relative">
                  <button
                    #menuAccionesBtn
                    type="button"
                    class="btn-icon-subtle"
                    [disabled]="isSaving()"
                    (click)="menuAccionesOpen = !menuAccionesOpen"
                    aria-label="Más opciones"
                  >
                    <span class="material-symbols-outlined">more_vert</span>
                  </button>

                  @if (menuAccionesOpen) {
                    <div class="dropdown-panel dropdown-panel--right" (clickOutside)="menuAccionesOpen = false">
                      <div class="dropdown-panel__header">
                        <span class="dropdown-panel__title">Acciones rápidas</span>
                      </div>
                      <div class="dropdown-panel__body">
                        <button
                          type="button"
                          class="dropdown-action"
                          [disabled]="isLoading()"
                          (click)="cargarPlantilla(); menuAccionesOpen = false"
                        >
                          <span class="dropdown-action__icon dropdown-action__icon--gold">
                            <span class="material-symbols-outlined">folder_open</span>
                          </span>
                          <span class="dropdown-action__content">
                            <span class="dropdown-action__label">Cargar plantilla</span>
                            <span class="dropdown-action__hint">Usar rutina existente</span>
                          </span>
                        </button>
                        <button
                          type="button"
                          class="dropdown-action"
                          [disabled]="items().length === 0"
                          (click)="guardarComoPlantilla(); menuAccionesOpen = false"
                        >
                          <span class="dropdown-action__icon dropdown-action__icon--coral">
                            <span class="material-symbols-outlined">bookmark_add</span>
                          </span>
                          <span class="dropdown-action__content">
                            <span class="dropdown-action__label">Guardar como plantilla</span>
                            <span class="dropdown-action__hint">Reutilizar este plan</span>
                          </span>
                        </button>
                        @if (!isEditMode()) {
                          <div class="dropdown-panel__divider"></div>
                          <a
                            routerLink="/galeria/ejercicios"
                            class="dropdown-action"
                            (click)="menuAccionesOpen = false"
                          >
                            <span class="dropdown-action__icon dropdown-action__icon--green">
                              <span class="material-symbols-outlined">add</span>
                            </span>
                            <span class="dropdown-action__content">
                              <span class="dropdown-action__label">Agregar ejercicios</span>
                              <span class="dropdown-action__hint">Desde el catálogo</span>
                            </span>
                          </a>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }

        <!-- Detalles del plan -->
        <div class="plan-card__section plan-card__section--details">
          @if (!editandoDetalles()) {
            <!-- Vista mode -->
            <div class="plan-details-view">
              <div class="plan-details-view__content">
                <h2 class="plan-title">{{ form.value.titulo || "Sin título" }}</h2>
                @if (form.value.descripcion) {
                  <p class="plan-description">{{ form.value.descripcion }}</p>
                }
              </div>
              <button
                type="button"
                class="btn-edit-subtle"
                (click)="editandoDetalles.set(true)"
                title="Editar título y descripción"
              >
                <span class="material-symbols-outlined">edit</span>
              </button>
            </div>
          } @else {
            <!-- Edit mode -->
            <form [formGroup]="form" class="plan-details-form">
              <div class="form-field">
                <label class="form-label">
                  <span class="form-label__icon material-symbols-outlined">title</span>
                  Título del plan
                </label>
                <input
                  type="text"
                  class="form-input"
                  formControlName="titulo"
                  placeholder="Ej: Rehabilitación rodilla derecha"
                />
                @if (form.controls.titulo.hasError("required") && form.controls.titulo.touched) {
                  <p class="form-error">
                    <span class="material-symbols-outlined">error</span>
                    El título es requerido
                  </p>
                }
              </div>

              <div class="form-field">
                <label class="form-label">
                  <span class="form-label__icon material-symbols-outlined">description</span>
                  Descripción
                  <span class="form-label__optional">(opcional)</span>
                </label>
                <textarea
                  rows="2"
                  class="form-input form-input--textarea"
                  formControlName="descripcion"
                  placeholder="Breve descripción del plan de tratamiento..."
                ></textarea>
              </div>

              <div class="form-actions">
                <button
                  type="button"
                  class="btn-primary btn-primary--sm"
                  (click)="editandoDetalles.set(false)"
                >
                  <span class="material-symbols-outlined">check</span>
                  Listo
                </button>
              </div>
            </form>
          }
        </div>

        <!-- Selector de fechas -->
        <div class="plan-card__section plan-card__section--dates">
          <div class="date-selector">
            <div class="date-selector__header">
              <span class="date-selector__icon material-symbols-outlined">calendar_month</span>
              <span class="date-selector__title">Duración del plan</span>
            </div>

            <div class="date-range">
              <div class="date-input-group">
                <label class="date-input-label">Inicio</label>
                <input
                  type="date"
                  class="date-input"
                  [min]="minDate"
                  [value]="form.value.fecha_inicio"
                  (change)="onFechaInicioChange($event)"
                />
              </div>
              <div class="date-range__arrow">
                <span class="material-symbols-outlined">trending_flat</span>
              </div>
              <div class="date-input-group">
                <label class="date-input-label">Fin</label>
                <input
                  type="date"
                  class="date-input"
                  [min]="form.value.fecha_inicio || minDate"
                  [value]="form.value.fecha_fin"
                  (change)="onFechaFinChange($event)"
                />
              </div>
            </div>

            <div class="duration-presets">
              @for (preset of duracionPresets; track preset.dias) {
                <button
                  type="button"
                  class="duration-chip"
                  [class.duration-chip--active]="duracionSeleccionada() === preset.dias"
                  (click)="seleccionarDuracion(preset.dias)"
                >
                  {{ preset.label }}
                </button>
              }
              <button
                type="button"
                class="duration-chip duration-chip--custom"
                [class.duration-chip--active]="duracionSeleccionada() === 'custom'"
              >
                <span class="material-symbols-outlined">tune</span>
                Otro
              </button>
            </div>
          </div>
        </div>
      </article>

      <!-- Sección de ejercicios -->
      <div class="exercises-section">
        <div class="exercises-header">
          <h2 class="exercises-title">
            <span class="exercises-title__icon material-symbols-outlined">fitness_center</span>
            Ejercicios del plan
          </h2>
          <span class="exercises-count">{{ totalItems() }}</span>
        </div>

        @if (items().length === 0) {
          <!-- Empty state -->
          <article class="empty-state-card">
            <div class="empty-state-card__visual">
              <div class="empty-state-card__circles">
                <span class="empty-state-card__circle empty-state-card__circle--1"></span>
                <span class="empty-state-card__circle empty-state-card__circle--2"></span>
                <span class="empty-state-card__circle empty-state-card__circle--3"></span>
              </div>
              <span class="material-symbols-outlined empty-state-card__icon">fitness_center</span>
            </div>
            <h3 class="empty-state-card__title">Sin ejercicios todavía</h3>
            <p class="empty-state-card__text">
              Añade ejercicios del catálogo para crear el plan de tratamiento
            </p>
            <a routerLink="/galeria/ejercicios" class="btn-primary btn-primary--glow">
              <span class="material-symbols-outlined">add</span>
              Agregar ejercicios
            </a>
          </article>
        } @else {
          <!-- Lista de ejercicios -->
          <div cdkDropList class="exercises-list" (cdkDropListDropped)="onDrop($event)">
            @for (it of items(); track trackByIndex($index); let i = $index) {
              <article
                class="exercise-card"
                [class.exercise-card--editing]="ejercicioEditando() === i"
                cdkDrag
                [cdkDragDisabled]="ejercicioEditando() === i"
              >
                <!-- Drag preview -->
                <div *cdkDragPreview class="exercise-card-preview">
                  <div class="exercise-card-preview__inner">
                    @if (it.ejercicio.portada) {
                      <img
                        [src]="assetUrl(it.ejercicio.portada, 56, 56)"
                        class="exercise-card-preview__img"
                        alt=""
                      />
                    } @else {
                      <div class="exercise-card-preview__placeholder">
                        <span class="material-symbols-outlined">fitness_center</span>
                      </div>
                    }
                    <span class="exercise-card-preview__name">{{ it.ejercicio.nombre_ejercicio }}</span>
                  </div>
                </div>

                <!-- Placeholder -->
                <div *cdkDragPlaceholder class="exercise-card-placeholder"></div>

                @if (ejercicioEditando() !== i) {
                  <!-- Vista compacta -->
                  <div class="exercise-card__compact">
                    <div class="exercise-drag" cdkDragHandle>
                      <span class="material-symbols-outlined">drag_indicator</span>
                    </div>

                    <div class="exercise-thumb">
                      @if (it.ejercicio.portada) {
                        <img
                          [src]="assetUrl(it.ejercicio.portada, 80, 80)"
                          [alt]="it.ejercicio.nombre_ejercicio"
                          class="exercise-thumb__img"
                        />
                      } @else {
                        <div class="exercise-thumb__fallback">
                          <span class="material-symbols-outlined">fitness_center</span>
                        </div>
                      }
                    </div>

                    <div class="exercise-info">
                      <h3 class="exercise-name">{{ it.ejercicio.nombre_ejercicio }}</h3>
                      <div class="exercise-meta">
                        <span class="exercise-dosage">
                          <span class="exercise-dosage__value">{{ it.series || 3 }}</span>
                          <span class="exercise-dosage__sep">×</span>
                          <span class="exercise-dosage__value">{{ it.repeticiones || 10 }}</span>
                        </span>
                        @if (it.descanso_seg) {
                          <span class="exercise-meta__divider">·</span>
                          <span class="exercise-rest">{{ it.descanso_seg }}s</span>
                        }
                        @if (it.veces_dia && it.veces_dia > 1) {
                          <span class="exercise-meta__divider">·</span>
                          <span class="exercise-frequency">{{ it.veces_dia }}/día</span>
                        }
                      </div>
                      <div class="exercise-days">
                        @for (d of dias; track d) {
                          <span class="day-dot" [class.day-dot--active]="isDia(it, d)">{{ d }}</span>
                        }
                      </div>
                    </div>

                    <button
                      type="button"
                      class="btn-edit-exercise"
                      (click)="ejercicioEditando.set(i)"
                      title="Editar ejercicio"
                    >
                      <span class="material-symbols-outlined">edit</span>
                    </button>
                  </div>
                } @else {
                  <!-- Vista expandida (edición) -->
                  <div class="exercise-card__expanded">
                    <div class="exercise-edit-header">
                      <div class="exercise-edit-thumb">
                        @if (it.ejercicio.portada) {
                          <img
                            [src]="assetUrl(it.ejercicio.portada, 120, 120)"
                            [alt]="it.ejercicio.nombre_ejercicio"
                          />
                        } @else {
                          <div class="exercise-edit-thumb__fallback">
                            <span class="material-symbols-outlined">fitness_center</span>
                          </div>
                        }
                      </div>
                      <div class="exercise-edit-info">
                        <h3 class="exercise-edit-name">{{ it.ejercicio.nombre_ejercicio }}</h3>
                        @if (it.ejercicio.descripcion) {
                          <div
                            class="exercise-edit-desc"
                            [innerHTML]="it.ejercicio.descripcion | safeHtml"
                          ></div>
                        }
                      </div>
                    </div>

                    <!-- Dosificación -->
                    <div class="dosage-grid">
                      <div class="dosage-field">
                        <label class="dosage-label">Series</label>
                        <div class="dosage-input-wrap">
                          <input
                            type="number"
                            min="1"
                            class="dosage-input"
                            [value]="it.series || 3"
                            (input)="update(i, { series: +$any($event.target).value || 1 })"
                          />
                        </div>
                      </div>
                      <div class="dosage-field">
                        <label class="dosage-label">Repeticiones</label>
                        <div class="dosage-input-wrap">
                          <input
                            type="number"
                            min="1"
                            class="dosage-input"
                            [value]="it.repeticiones || 10"
                            (input)="update(i, { repeticiones: +$any($event.target).value || 1 })"
                          />
                        </div>
                      </div>
                      <div class="dosage-field">
                        <label class="dosage-label">Descanso</label>
                        <div class="dosage-input-wrap dosage-input-wrap--suffix">
                          <input
                            type="number"
                            min="0"
                            class="dosage-input"
                            [value]="it.descanso_seg ?? 45"
                            (input)="update(i, { descanso_seg: +$any($event.target).value || 0 })"
                          />
                          <span class="dosage-suffix">seg</span>
                        </div>
                      </div>
                      <div class="dosage-field">
                        <label class="dosage-label">Veces/día</label>
                        <div class="dosage-input-wrap">
                          <input
                            type="number"
                            min="1"
                            class="dosage-input"
                            [value]="it.veces_dia ?? 1"
                            (input)="update(i, { veces_dia: +$any($event.target).value || 1 })"
                          />
                        </div>
                      </div>
                    </div>

                    <!-- Días de la semana -->
                    <div class="days-selector">
                      <label class="days-selector__label">Días de la semana</label>
                      <div class="days-selector__grid">
                        @for (d of dias; track d) {
                          <button
                            type="button"
                            class="day-btn"
                            [class.day-btn--active]="isDia(it, d)"
                            (click)="toggleDia(i, d)"
                          >
                            <span class="day-btn__letter">{{ d }}</span>
                            <span class="day-btn__name">{{ diasNombres[d] }}</span>
                          </button>
                        }
                      </div>
                    </div>

                    <!-- Instrucciones -->
                    <div class="instructions-field">
                      <label class="form-label">
                        <span class="form-label__icon material-symbols-outlined">note</span>
                        Instrucciones para el paciente
                        <span class="form-label__optional">(opcional)</span>
                      </label>
                      <textarea
                        rows="2"
                        class="form-input form-input--textarea"
                        placeholder="Indicaciones especiales, precauciones, consejos..."
                        [value]="it.instrucciones_paciente || ''"
                        (input)="update(i, { instrucciones_paciente: $any($event.target).value })"
                      ></textarea>
                    </div>

                    <!-- Actions -->
                    <div class="exercise-edit-actions">
                      <button
                        type="button"
                        class="btn-delete"
                        (click)="removeEjercicio(it.ejercicio.id_ejercicio)"
                      >
                        <span class="material-symbols-outlined">delete</span>
                        Eliminar
                      </button>
                      <button
                        type="button"
                        class="btn-primary btn-primary--sm"
                        (click)="ejercicioEditando.set(null)"
                      >
                        <span class="material-symbols-outlined">check</span>
                        Listo
                      </button>
                    </div>
                  </div>
                }
              </article>
            }
          </div>
        }
      </div>
    </div>
  </div>
</section>

<!-- Floating action bar (oculta en desktop edit mode, los botones están arriba) -->
<div class="floating-action-bar" [class.floating-action-bar--hidden]="isEditMode() && !isMovil()">
  <div class="floating-action-bar__inner">
    <button
      type="button"
      class="btn-save"
      (click)="guardarPlan()"
      [disabled]="!canSubmit() || isSaving() || (isEditMode() && !svc.isDirty())"
    >
      @if (isSaving()) {
        <span class="btn-save__loading">
          <span class="btn-save__spinner"></span>
          <span>Guardando...</span>
        </span>
      } @else {
        <span class="btn-save__content">
          <span class="material-symbols-outlined">check_circle</span>
          <span>{{ isEditMode() ? "Actualizar plan" : "Guardar plan" }}</span>
        </span>
      }
    </button>
  </div>
</div>
