<section class="clinic-page">
  <!-- Aurora Background -->
  <div class="aurora-bg" aria-hidden="true">
    <div class="aurora-wave aurora-wave-1"></div>
    <div class="aurora-wave aurora-wave-2"></div>
    <div class="aurora-wave aurora-wave-3"></div>
  </div>

  <!-- Header Responsivo -->
  <header class="header-glass sticky top-0 z-50 shrink-0 px-4 pt-3 pb-4">
    <div class="mx-auto max-w-2xl">

      <!-- MÓVIL: Header completo con título y navegación -->
      @if (isMovil()) {
        <div class="mb-4 flex items-center justify-between">
          <!-- Botón volver + Título -->
          <div class="flex items-center gap-3">
            <button
              type="button"
              routerLink="/inicio"
              class="flex h-10 w-10 items-center justify-center rounded-xl
                     bg-white/60 backdrop-blur-md border border-white/40
                     text-zinc-600 transition-all duration-200
                     hover:bg-white/80 hover:scale-105 active:scale-95"
              aria-label="Volver al inicio"
            >
              <span class="material-symbols-outlined text-xl">arrow_back</span>
            </button>
            <div>
              <h1 class="titulo-kengo text-2xl text-[#e75c3e]">Mi Clínica</h1>
              @if (clinicasRes().length > 1) {
                <button class="clinic-switcher" (click)="showClinicPicker = !showClinicPicker">
                  <span class="current-clinic-name">{{ clinicasRes()[selectedClinicIndex()]?.nombre || 'Seleccionar' }}</span>
                  <span class="material-symbols-outlined switcher-icon" [class.rotated]="showClinicPicker">expand_more</span>
                </button>
              }
            </div>
          </div>
        </div>
      }

      <!-- Barra de controles (siempre visible) -->
      <div class="flex items-center gap-2">
        <!-- DESKTOP: Selector de clínica compacto -->
        @if (!isMovil() && clinicasRes().length > 1) {
          <button
            class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/50 backdrop-blur-md
                   border border-white/40 text-sm font-medium text-zinc-700
                   hover:bg-white/70 transition-all shrink-0"
            (click)="showClinicPicker = !showClinicPicker"
          >
            <span class="material-symbols-outlined text-lg text-[#e75c3e]">domain</span>
            <span class="max-w-[150px] truncate">{{ clinicasRes()[selectedClinicIndex()]?.nombre || 'Seleccionar' }}</span>
            <span class="material-symbols-outlined text-base text-zinc-400" [class.rotate-180]="showClinicPicker">expand_more</span>
          </button>
        }

      </div>

    </div>

    <!-- Clinic Picker Dropdown -->
    @if (showClinicPicker && clinicasRes().length > 1) {
      <div class="clinic-picker-overlay" (click)="showClinicPicker = false"></div>
      <div class="clinic-picker">
        @for (c of clinicasRes(); track c.id_clinica; let i = $index) {
          <button class="picker-option" [class.active]="i === selectedClinicIndex()" (click)="selectClinic(i)">
            <div class="picker-logo">
              @if (c.logo) {
                <img [src]="assetUrl(c.logo)" [alt]="c.nombre"/>
              } @else {
                <span class="material-symbols-outlined icon-filled">domain</span>
              }
            </div>
            <div class="picker-info">
              <span class="picker-name">{{ c.nombre || 'Clínica ' + c.id_clinica }}</span>
              <span class="picker-location">{{ c.direccion || 'Sin dirección' }}</span>
            </div>
            @if (i === selectedClinicIndex()) {
              <span class="material-symbols-outlined picker-check">check_circle</span>
            }
          </button>
        }
      </div>
    }
  </header>

  <!-- Main Content -->
  <main class="clinic-main">
    <!-- Loading State -->
    @if (!clinicasRes()) {
      <div class="state-card loading-state">
        <div class="shimmer-effect"></div>
        <div class="state-icon pulse">
          <span class="material-symbols-outlined">domain</span>
        </div>
        <p class="state-text">Cargando clínica...</p>
      </div>
    }

    <!-- Error State -->
    @if (error()) {
      <div class="state-card error-state">
        <div class="state-icon error">
          <span class="material-symbols-outlined">error</span>
        </div>
        <p class="state-text error">{{ error() }}</p>
        <button class="retry-btn">
          <span class="material-symbols-outlined">refresh</span>
          Reintentar
        </button>
      </div>
    }

    <!-- Empty State - Options to link or create clinic -->
    @if (clinicIds() && clinicIds()?.length === 0) {
      <div class="no-clinic-container animate-in">
        <!-- Welcome Card -->
        <article class="welcome-card">
          <div class="welcome-icon">
            <span class="material-symbols-outlined icon-filled">domain_add</span>
          </div>
          <h2 class="welcome-title">Bienvenido a Kengo</h2>
          <p class="welcome-text">Aún no estás vinculado a ninguna clínica. Elige una opción para comenzar:</p>
        </article>

        <!-- Options Grid -->
        <div class="options-grid">
          <button type="button" class="option-card" (click)="abrirVincularClinica()">
            <div class="option-icon link">
              <span class="material-symbols-outlined icon-filled">link</span>
            </div>
            <h3 class="option-title">Vincularme a una clínica</h3>
            <p class="option-desc">Tengo un código de acceso</p>
          </button>

          <button type="button" class="option-card" (click)="abrirCrearClinica()">
            <div class="option-icon create">
              <span class="material-symbols-outlined icon-filled">add_business</span>
            </div>
            <h3 class="option-title">Crear nueva clínica</h3>
            <p class="option-desc">Soy propietario y quiero gestionar mi clínica</p>
          </button>
        </div>
      </div>
    }

    <!-- Clinic Content -->
    @if (currentClinic(); as c) {
      <!-- Hero Card -->
      <article class="hero-card animate-in">
        <div class="hero-visual">
          @if (c.imagenes?.length) {
            <img [src]="assetUrl(firstImageId(c))" [alt]="c.nombre" class="hero-image"/>
          } @else {
            <div class="hero-gradient" [style.--clinic-color]="c.color_primario || '#e75c3e'"></div>
          }
          <div class="hero-overlay"></div>

          <!-- Floating Logo -->
          <div class="hero-logo">
            @if (c.logo) {
              <img [src]="assetUrl(c.logo)" [alt]="c.nombre"/>
            } @else {
              <span class="material-symbols-outlined icon-filled">domain</span>
            }
          </div>

          <!-- Status Badge -->
          <div class="status-badge">
            <span class="status-dot"></span>
            Activa
          </div>
        </div>

        <div class="hero-info">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1 min-w-0">
              <h2 class="clinic-name">{{ c.nombre || 'Mi Clínica' }}</h2>
              <p class="clinic-address">
                <span class="material-symbols-outlined">location_on</span>
                {{ c.direccion || 'Sin dirección' }}
                @if (c.postal) {
                  <span class="postal-badge">{{ c.postal }}</span>
                }
              </p>
            </div>
            <button
              type="button"
              disabled
              class="edit-clinic-btn"
              aria-label="Editar clínica"
            >
              <span class="material-symbols-outlined">edit</span>
              <span class="edit-label">Editar</span>
            </button>
          </div>
        </div>
      </article>

      <!-- Quick Actions -->
      <section class="quick-actions animate-in" style="--delay: 0.1s">
        @if (c.telefono) {
          <a [href]="'tel:' + c.telefono" class="quick-action primary">
            <div class="action-icon">
              <span class="material-symbols-outlined icon-filled">call</span>
            </div>
            <span class="action-label">Llamar</span>
          </a>
        }
        @if (c.email) {
          <a [href]="'mailto:' + c.email" class="quick-action secondary">
            <div class="action-icon">
              <span class="material-symbols-outlined">mail</span>
            </div>
            <span class="action-label">Email</span>
          </a>
        }
        @if (c.direccion) {
          <button type="button" class="quick-action tertiary">
            <div class="action-icon">
              <span class="material-symbols-outlined">map</span>
            </div>
            <span class="action-label">Mapa</span>
          </button>
        }
        <button type="button" class="quick-action neutral">
          <div class="action-icon">
            <span class="material-symbols-outlined">share</span>
          </div>
          <span class="action-label">Compartir</span>
        </button>
      </section>

      <!-- Info Cards Grid -->
      <section class="info-grid animate-in" style="--delay: 0.15s">
        <!-- Contact Card -->
        <div class="info-card">
          <div class="info-card-header">
            <span class="material-symbols-outlined info-icon">contact_phone</span>
            <span class="info-card-title">Contacto</span>
          </div>
          <div class="info-card-body">
            <div class="info-row">
              <span class="info-label">Teléfono</span>
              <span class="info-value">{{ c.telefono || '—' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Email</span>
              <span class="info-value truncate">{{ c.email || '—' }}</span>
            </div>
          </div>
        </div>

        <!-- Legal Card -->
        <div class="info-card">
          <div class="info-card-header">
            <span class="material-symbols-outlined info-icon">badge</span>
            <span class="info-card-title">Fiscal</span>
          </div>
          <div class="info-card-body">
            <div class="info-row">
              <span class="info-label">NIF</span>
              <span class="info-value mono">{{ c.nif || '—' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">C.P.</span>
              <span class="info-value">{{ c.postal || '—' }}</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Team Section -->
      <section class="team-section animate-in" style="--delay: 0.2s">
        <header class="section-header" (click)="toggleTeamExpanded()">
          <div class="section-title-group">
            <div class="section-icon">
              <span class="material-symbols-outlined icon-filled">groups</span>
            </div>
            <div>
              <h3 class="section-title">Equipo</h3>
              <p class="section-subtitle">{{ fisios(c.id_clinica).length }} fisioterapeutas</p>
            </div>
          </div>
          <span class="material-symbols-outlined expand-icon" [class.rotated]="teamExpanded()">expand_more</span>
        </header>

        @if (fisios(c.id_clinica).length === 0) {
          <div class="empty-team">
            <span class="material-symbols-outlined">person_off</span>
            <p>Sin fisioterapeutas asignados</p>
          </div>
        } @else {
          <!-- Collapsed: Avatar Stack -->
          @if (!teamExpanded()) {
            <div class="team-preview">
              <div class="avatar-stack">
                @for (f of fisios(c.id_clinica).slice(0, 4); track f.id; let i = $index) {
                  <div class="stacked-avatar" [style.--stack-index]="i">
                    @if (f.avatar) {
                      <img [src]="assetUrl(f.avatar)" [alt]="f.first_name"/>
                    } @else {
                      <span class="avatar-initials">{{ iniciales(f.first_name, f.last_name) }}</span>
                    }
                  </div>
                }
                @if (fisios(c.id_clinica).length > 4) {
                  <div class="stacked-avatar more" [style.--stack-index]="4">
                    +{{ fisios(c.id_clinica).length - 4 }}
                  </div>
                }
              </div>
              <span class="preview-hint">Toca para ver el equipo</span>
            </div>
          }

          <!-- Expanded: Team List -->
          @if (teamExpanded()) {
            <div class="team-list">
              @for (f of fisios(c.id_clinica); track f.id; let j = $index) {
                <article class="team-member" [style.--member-delay]="(j * 0.05) + 's'">
                  <div class="member-avatar">
                    @if (f.avatar) {
                      <img [src]="assetUrl(f.avatar)" [alt]="f.first_name + ' ' + f.last_name"/>
                    } @else {
                      <span class="avatar-initials">{{ iniciales(f.first_name, f.last_name) }}</span>
                    }
                    <span class="online-indicator"></span>
                  </div>

                  <div class="member-info">
                    <h4 class="member-name">{{ f.first_name }} {{ f.last_name }}</h4>
                    <div class="member-meta">
                      @if (f.numero_colegiado) {
                        <span class="colegiado-badge">
                          <span class="material-symbols-outlined">verified</span>
                          Col. {{ f.numero_colegiado }}
                        </span>
                      } @else {
                        <span class="role-badge">Fisioterapeuta</span>
                      }
                    </div>
                  </div>

                  <div class="member-actions">
                    @if (f.telefono) {
                      <a [href]="'tel:' + f.telefono" class="member-action" aria-label="Llamar">
                        <span class="material-symbols-outlined">call</span>
                      </a>
                    }
                    @if (f.email) {
                      <a [href]="'mailto:' + f.email" class="member-action" aria-label="Email">
                        <span class="material-symbols-outlined">mail</span>
                      </a>
                    }
                  </div>
                </article>
              }
            </div>
          }
        }
      </section>

      <!-- Códigos de Acceso Section (visible para admin/fisio) -->
      @if (esFisioOAdmin()) {
        <section class="codes-section animate-in" style="--delay: 0.25s">
          <header class="section-header" (click)="toggleCodigosExpanded()">
            <div class="section-title-group">
              <div class="section-icon codes">
                <span class="material-symbols-outlined icon-filled">key</span>
              </div>
              <div>
                <h3 class="section-title">Códigos de Acceso</h3>
                <p class="section-subtitle">Invita pacientes y fisioterapeutas</p>
              </div>
            </div>
            <div class="codes-header-actions">
              <button
                type="button"
                class="generate-code-btn"
                (click)="abrirGenerarCodigo(); $event.stopPropagation()"
                aria-label="Generar código"
              >
                <span class="material-symbols-outlined">add</span>
                <span class="btn-label">Generar</span>
              </button>
              <span class="material-symbols-outlined expand-icon" [class.rotated]="codigosExpanded()">expand_more</span>
            </div>
          </header>

          @if (codigosExpanded()) {
            <div class="codes-content">
              @if (codigosLoading()) {
                <div class="codes-loading">
                  <div class="shimmer-effect"></div>
                  <p>Cargando códigos...</p>
                </div>
              } @else if (codigosClinica().length === 0) {
                <div class="empty-codes">
                  <span class="material-symbols-outlined">vpn_key_off</span>
                  <p>No hay códigos activos</p>
                  <button type="button" class="generate-empty-btn" (click)="abrirGenerarCodigo()">
                    <span class="material-symbols-outlined">add</span>
                    Generar primer código
                  </button>
                </div>
              } @else {
                <div class="codes-list">
                  @for (codigo of codigosClinica(); track codigo.id) {
                    <article class="code-item" [class.inactive]="!codigo.activo">
                      <div class="code-info">
                        <div class="code-value">
                          <span class="code-text">{{ codigo.codigo }}</span>
                          <button
                            type="button"
                            class="copy-btn"
                            (click)="copiarCodigo(codigo.codigo)"
                            aria-label="Copiar código"
                          >
                            <span class="material-symbols-outlined">content_copy</span>
                          </button>
                        </div>
                        <div class="code-meta">
                          <span class="code-type" [class.fisio]="codigo.tipo === 'fisioterapeuta'">
                            {{ codigo.tipo === 'fisioterapeuta' ? 'Fisioterapeuta' : 'Paciente' }}
                          </span>
                          @if (codigo.usosMaximos) {
                            <span class="code-uses">{{ codigo.usosActuales }}/{{ codigo.usosMaximos }} usos</span>
                          } @else {
                            <span class="code-uses">{{ codigo.usosActuales }} usos</span>
                          }
                          @if (codigo.fechaExpiracion) {
                            <span class="code-expiry">
                              Expira: {{ codigo.fechaExpiracion | date:'dd/MM/yyyy' }}
                            </span>
                          }
                        </div>
                      </div>
                      @if (codigo.activo) {
                        <button
                          type="button"
                          class="deactivate-btn"
                          (click)="desactivarCodigo(codigo.id)"
                          aria-label="Desactivar código"
                        >
                          <span class="material-symbols-outlined">block</span>
                        </button>
                      } @else {
                        <span class="inactive-badge">Inactivo</span>
                      }
                    </article>
                  }
                </div>
              }
            </div>
          }
        </section>
      }
    }
  </main>

  <!-- Snackbar -->
  @if (snackbarVisible()) {
    <div class="snackbar">{{ snackbarMessage() }}</div>
  }

  <!-- Dialogs -->
  @if (mostrarModalVincular()) {
    <app-vincular-clinica-dialog
      (cerrar)="cerrarVincularClinica()"
      (vinculacionExitosa)="onVinculacionExitosa()"
    />
  }

  @if (mostrarModalCrear()) {
    <app-crear-clinica-dialog
      (cerrar)="cerrarCrearClinica()"
      (clinicaCreada)="onClinicaCreada()"
    />
  }

  @if (mostrarModalGenerarCodigo() && currentClinic()) {
    <app-generar-codigo-dialog
      [clinicaId]="currentClinic()!.id_clinica"
      [esAdmin]="esAdmin()"
      (cerrar)="cerrarGenerarCodigo()"
      (codigoGenerado)="onCodigoGenerado($event)"
    />
  }
</section>
