<section class="clinic-page">
  <!-- Aurora Background -->
  <div class="aurora-bg" aria-hidden="true">
    <div class="aurora-wave aurora-wave-1"></div>
    <div class="aurora-wave aurora-wave-2"></div>
    <div class="aurora-wave aurora-wave-3"></div>
  </div>

  <!-- Compact Header -->
  <header class="clinic-header">
    <div class="header-content">
      <div class="header-left">
        @if (!isDesktop()) {
          <a class="back-btn" aria-label="Volver" routerLink="/inicio">
            <span class="material-symbols-outlined">arrow_back</span>
          </a>
        }
        <div class="header-title-group">
          <h1 class="titulo-kengo header-title">Mi Clínica</h1>
          @if (clinicasRes().length > 1) {
            <button class="clinic-switcher" (click)="showClinicPicker = !showClinicPicker">
              <span class="current-clinic-name">{{ clinicasRes()[selectedClinicIndex()]?.nombre || 'Seleccionar' }}</span>
              <span class="material-symbols-outlined switcher-icon" [class.rotated]="showClinicPicker">expand_more</span>
            </button>
          }
        </div>
      </div>
      @if (currentClinic()) {
        <div class="header-actions">
          <button class="action-btn" disabled aria-label="Editar clínica">
            <span class="material-symbols-outlined">edit</span>
          </button>
        </div>
      }
    </div>

    <!-- Clinic Picker Dropdown -->
    @if (showClinicPicker && clinicasRes().length > 1) {
      <div class="clinic-picker-overlay" (click)="showClinicPicker = false"></div>
      <div class="clinic-picker">
        @for (c of clinicasRes(); track c.id_clinica; let i = $index) {
          <button class="picker-option" [class.active]="i === selectedClinicIndex()" (click)="selectClinic(i)">
            <div class="picker-logo">
              @if (c.logo) {
                <img [src]="assetUrl(c.logo)" [alt]="c.nombre"/>
              } @else {
                <span class="material-symbols-outlined icon-filled">domain</span>
              }
            </div>
            <div class="picker-info">
              <span class="picker-name">{{ c.nombre || 'Clínica ' + c.id_clinica }}</span>
              <span class="picker-location">{{ c.direccion || 'Sin dirección' }}</span>
            </div>
            @if (i === selectedClinicIndex()) {
              <span class="material-symbols-outlined picker-check">check_circle</span>
            }
          </button>
        }
      </div>
    }
  </header>

  <!-- Main Content -->
  <main class="clinic-main">
    <!-- Loading State -->
    @if (!clinicasRes()) {
      <div class="state-card loading-state">
        <div class="shimmer-effect"></div>
        <div class="state-icon pulse">
          <span class="material-symbols-outlined">domain</span>
        </div>
        <p class="state-text">Cargando clínica...</p>
      </div>
    }

    <!-- Error State -->
    @if (error()) {
      <div class="state-card error-state">
        <div class="state-icon error">
          <span class="material-symbols-outlined">error</span>
        </div>
        <p class="state-text error">{{ error() }}</p>
        <button class="retry-btn">
          <span class="material-symbols-outlined">refresh</span>
          Reintentar
        </button>
      </div>
    }

    <!-- Empty State -->
    @if (clinicIds() && clinicIds()?.length === 0) {
      <div class="state-card empty-state">
        <div class="state-icon empty">
          <span class="material-symbols-outlined">domain_disabled</span>
        </div>
        <h3 class="state-title">Sin clínicas</h3>
        <p class="state-text">No estás vinculado a ninguna clínica. Contacta con el administrador.</p>
      </div>
    }

    <!-- Clinic Content -->
    @if (currentClinic(); as c) {
      <!-- Hero Card -->
      <article class="hero-card animate-in">
        <div class="hero-visual">
          @if (c.imagenes?.length) {
            <img [src]="assetUrl(firstImageId(c))" [alt]="c.nombre" class="hero-image"/>
          } @else {
            <div class="hero-gradient" [style.--clinic-color]="c.color_primario || '#e75c3e'"></div>
          }
          <div class="hero-overlay"></div>

          <!-- Floating Logo -->
          <div class="hero-logo">
            @if (c.logo) {
              <img [src]="assetUrl(c.logo)" [alt]="c.nombre"/>
            } @else {
              <span class="material-symbols-outlined icon-filled">domain</span>
            }
          </div>

          <!-- Status Badge -->
          <div class="status-badge">
            <span class="status-dot"></span>
            Activa
          </div>
        </div>

        <div class="hero-info">
          <h2 class="clinic-name">{{ c.nombre || 'Mi Clínica' }}</h2>
          <p class="clinic-address">
            <span class="material-symbols-outlined">location_on</span>
            {{ c.direccion || 'Sin dirección' }}
            @if (c.postal) {
              <span class="postal-badge">{{ c.postal }}</span>
            }
          </p>
        </div>
      </article>

      <!-- Quick Actions -->
      <section class="quick-actions animate-in" style="--delay: 0.1s">
        @if (c.telefono) {
          <a [href]="'tel:' + c.telefono" class="quick-action primary">
            <div class="action-icon">
              <span class="material-symbols-outlined icon-filled">call</span>
            </div>
            <span class="action-label">Llamar</span>
          </a>
        }
        @if (c.email) {
          <a [href]="'mailto:' + c.email" class="quick-action secondary">
            <div class="action-icon">
              <span class="material-symbols-outlined">mail</span>
            </div>
            <span class="action-label">Email</span>
          </a>
        }
        @if (c.direccion) {
          <button type="button" class="quick-action tertiary">
            <div class="action-icon">
              <span class="material-symbols-outlined">map</span>
            </div>
            <span class="action-label">Mapa</span>
          </button>
        }
        <button type="button" class="quick-action neutral">
          <div class="action-icon">
            <span class="material-symbols-outlined">share</span>
          </div>
          <span class="action-label">Compartir</span>
        </button>
      </section>

      <!-- Info Cards Grid -->
      <section class="info-grid animate-in" style="--delay: 0.15s">
        <!-- Contact Card -->
        <div class="info-card">
          <div class="info-card-header">
            <span class="material-symbols-outlined info-icon">contact_phone</span>
            <span class="info-card-title">Contacto</span>
          </div>
          <div class="info-card-body">
            <div class="info-row">
              <span class="info-label">Teléfono</span>
              <span class="info-value">{{ c.telefono || '—' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Email</span>
              <span class="info-value truncate">{{ c.email || '—' }}</span>
            </div>
          </div>
        </div>

        <!-- Legal Card -->
        <div class="info-card">
          <div class="info-card-header">
            <span class="material-symbols-outlined info-icon">badge</span>
            <span class="info-card-title">Fiscal</span>
          </div>
          <div class="info-card-body">
            <div class="info-row">
              <span class="info-label">NIF</span>
              <span class="info-value mono">{{ c.nif || '—' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">C.P.</span>
              <span class="info-value">{{ c.postal || '—' }}</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Team Section -->
      <section class="team-section animate-in" style="--delay: 0.2s">
        <header class="section-header" (click)="toggleTeamExpanded()">
          <div class="section-title-group">
            <div class="section-icon">
              <span class="material-symbols-outlined icon-filled">groups</span>
            </div>
            <div>
              <h3 class="section-title">Equipo</h3>
              <p class="section-subtitle">{{ fisios(c.id_clinica).length }} fisioterapeutas</p>
            </div>
          </div>
          <span class="material-symbols-outlined expand-icon" [class.rotated]="teamExpanded()">expand_more</span>
        </header>

        @if (fisios(c.id_clinica).length === 0) {
          <div class="empty-team">
            <span class="material-symbols-outlined">person_off</span>
            <p>Sin fisioterapeutas asignados</p>
          </div>
        } @else {
          <!-- Collapsed: Avatar Stack -->
          @if (!teamExpanded()) {
            <div class="team-preview">
              <div class="avatar-stack">
                @for (f of fisios(c.id_clinica).slice(0, 4); track f.id; let i = $index) {
                  <div class="stacked-avatar" [style.--stack-index]="i">
                    @if (f.avatar) {
                      <img [src]="assetUrl(f.avatar)" [alt]="f.first_name"/>
                    } @else {
                      <span class="avatar-initials">{{ iniciales(f.first_name, f.last_name) }}</span>
                    }
                  </div>
                }
                @if (fisios(c.id_clinica).length > 4) {
                  <div class="stacked-avatar more" [style.--stack-index]="4">
                    +{{ fisios(c.id_clinica).length - 4 }}
                  </div>
                }
              </div>
              <span class="preview-hint">Toca para ver el equipo</span>
            </div>
          }

          <!-- Expanded: Team List -->
          @if (teamExpanded()) {
            <div class="team-list">
              @for (f of fisios(c.id_clinica); track f.id; let j = $index) {
                <article class="team-member" [style.--member-delay]="(j * 0.05) + 's'">
                  <div class="member-avatar">
                    @if (f.avatar) {
                      <img [src]="assetUrl(f.avatar)" [alt]="f.first_name + ' ' + f.last_name"/>
                    } @else {
                      <span class="avatar-initials">{{ iniciales(f.first_name, f.last_name) }}</span>
                    }
                    <span class="online-indicator"></span>
                  </div>

                  <div class="member-info">
                    <h4 class="member-name">{{ f.first_name }} {{ f.last_name }}</h4>
                    <div class="member-meta">
                      @if (f.numero_colegiado) {
                        <span class="colegiado-badge">
                          <span class="material-symbols-outlined">verified</span>
                          Col. {{ f.numero_colegiado }}
                        </span>
                      } @else {
                        <span class="role-badge">Fisioterapeuta</span>
                      }
                    </div>
                  </div>

                  <div class="member-actions">
                    @if (f.telefono) {
                      <a [href]="'tel:' + f.telefono" class="member-action" aria-label="Llamar">
                        <span class="material-symbols-outlined">call</span>
                      </a>
                    }
                    @if (f.email) {
                      <a [href]="'mailto:' + f.email" class="member-action" aria-label="Email">
                        <span class="material-symbols-outlined">mail</span>
                      </a>
                    }
                  </div>
                </article>
              }
            </div>
          }
        }
      </section>
    }
  </main>

  <!-- Snackbar -->
  @if (snackbarVisible()) {
    <div class="snackbar">{{ snackbarMessage() }}</div>
  }
</section>
