<div class="dialog-overlay" (click)="onOverlayClick($event)">
  <div class="dialog-content">
    <header class="dialog-header">
      <div class="dialog-icon">
        <span class="material-symbols-outlined icon-filled">edit</span>
      </div>
      <h2 class="dialog-title">Editar clínica</h2>
      <p class="dialog-subtitle">Actualiza los datos de tu clínica</p>
      <button type="button" class="close-btn" (click)="cerrar.emit()" aria-label="Cerrar">
        <span class="material-symbols-outlined">close</span>
      </button>
    </header>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="dialog-body">
      <!-- Logo Section -->
      <div class="media-section">
        <span class="form-label">Logo de la clínica</span>
        <div class="logo-container">
          @if (logoPreviewUrl()) {
            <div class="logo-preview">
              <img [src]="logoPreviewUrl()" alt="Logo de la clínica" class="logo-image" />
              <div class="logo-actions">
                <button type="button" class="logo-action-btn" (click)="openLogoUploader()" title="Cambiar logo">
                  <span class="material-symbols-outlined">edit</span>
                </button>
                <button type="button" class="logo-action-btn danger" (click)="clearLogo()" title="Eliminar logo">
                  <span class="material-symbols-outlined">delete</span>
                </button>
              </div>
            </div>
          } @else {
            <button type="button" class="logo-upload-btn" (click)="openLogoUploader()">
              <span class="material-symbols-outlined">add_photo_alternate</span>
              <span>Añadir logo</span>
            </button>
          }
        </div>
      </div>

      <!-- Gallery Section -->
      <div class="media-section">
        <div class="gallery-header">
          <span class="form-label">Galería de imágenes</span>
          <span class="gallery-count">{{ existingImages().length - imagesToDelete().length + newImageFiles().length }} / 5</span>
        </div>
        <div class="gallery-grid">
          <!-- Existing images -->
          @for (img of existingImages(); track img.junctionId) {
            <div class="gallery-item" [class.marked-for-deletion]="isImageMarkedForDeletion(img.junctionId)">
              <img [src]="getExistingImageUrl(img.fileId)" alt="Imagen de clínica" class="gallery-image" />
              @if (isImageMarkedForDeletion(img.junctionId)) {
                <div class="gallery-item-overlay deleted">
                  <span class="material-symbols-outlined">delete</span>
                  <button type="button" class="restore-btn" (click)="restoreImage(img.junctionId)">
                    Restaurar
                  </button>
                </div>
              } @else {
                <button type="button" class="gallery-delete-btn" (click)="markImageForDeletion(img.junctionId)" title="Eliminar imagen">
                  <span class="material-symbols-outlined">close</span>
                </button>
              }
            </div>
          }
          <!-- New images (pending upload) -->
          @for (file of newImageFiles(); track $index) {
            <div class="gallery-item new-image">
              <img [src]="getNewImagePreviewUrl(file)" alt="Nueva imagen" class="gallery-image" />
              <button type="button" class="gallery-delete-btn" (click)="removeNewImage($index)" title="Quitar imagen">
                <span class="material-symbols-outlined">close</span>
              </button>
              <div class="new-badge">Nueva</div>
            </div>
          }
          <!-- Add image button -->
          @if (canAddMoreImages()) {
            <label class="gallery-add-btn">
              <input
                type="file"
                accept="image/png,image/jpeg,image/webp"
                multiple
                class="hidden-input"
                (change)="onGalleryImagesSelected($event)"
              />
              <span class="material-symbols-outlined">add_photo_alternate</span>
              <span class="add-text">Añadir</span>
            </label>
          }
        </div>
        <p class="gallery-hint">Máximo 5 imágenes. Formatos: PNG, JPG, WebP (máx. 5MB)</p>
      </div>

      <!-- Nombre (required) -->
      <div class="form-group">
        <label for="nombre" class="form-label">
          Nombre de la clínica <span class="required">*</span>
        </label>
        <input
          id="nombre"
          type="text"
          formControlName="nombre"
          class="form-input"
          placeholder="Clínica Ejemplo"
          [class.error]="form.get('nombre')?.touched && form.get('nombre')?.invalid"
        />
        @if (form.get('nombre')?.touched && form.get('nombre')?.errors?.['required']) {
          <span class="field-error">El nombre es requerido</span>
        }
      </div>

      <!-- Row: Teléfono + Email -->
      <div class="form-row">
        <div class="form-group">
          <label for="telefono" class="form-label">Teléfono</label>
          <input
            id="telefono"
            type="tel"
            formControlName="telefono"
            class="form-input"
            placeholder="612 345 678"
          />
        </div>

        <div class="form-group">
          <label for="email" class="form-label">Email</label>
          <input
            id="email"
            type="email"
            formControlName="email"
            class="form-input"
            placeholder="clinica@ejemplo.com"
            [class.error]="form.get('email')?.touched && form.get('email')?.invalid"
          />
          @if (form.get('email')?.touched && form.get('email')?.errors?.['email']) {
            <span class="field-error">Email no válido</span>
          }
        </div>
      </div>

      <!-- Dirección -->
      <div class="form-group">
        <label for="direccion" class="form-label">Dirección</label>
        <input
          id="direccion"
          type="text"
          formControlName="direccion"
          class="form-input"
          placeholder="Calle Ejemplo 123, Ciudad"
        />
      </div>

      <!-- Row: C.P. + NIF -->
      <div class="form-row">
        <div class="form-group">
          <label for="postal" class="form-label">Código Postal</label>
          <input
            id="postal"
            type="text"
            formControlName="postal"
            class="form-input"
            placeholder="28001"
          />
        </div>

        <div class="form-group">
          <label for="nif" class="form-label">NIF/CIF</label>
          <input
            id="nif"
            type="text"
            formControlName="nif"
            class="form-input"
            placeholder="B12345678"
          />
        </div>
      </div>

      <!-- Color primario -->
      <div class="form-group">
        <label for="color" class="form-label">Color corporativo</label>
        <div class="color-section">
          <!-- Paleta de colores predefinidos -->
          <div class="color-presets">
            @for (color of colorPresets; track color) {
              <button
                type="button"
                class="color-preset"
                [style.background-color]="color"
                [class.active]="form.value.color_primario === color"
                (click)="selectColor(color)"
                [title]="color"
              >
                @if (form.value.color_primario === color) {
                  <span class="material-symbols-outlined check-icon">check</span>
                }
              </button>
            }
          </div>

          <!-- Preview de elementos con el color -->
          <div class="color-preview-section">
            <span class="preview-label">Vista previa:</span>
            <div class="preview-items">
              <button
                type="button"
                class="preview-button"
                [style.background]="'linear-gradient(135deg, ' + form.value.color_primario + ', ' + getDarkerColor(form.value.color_primario) + ')'"
              >
                Botón
              </button>
              <span
                class="preview-badge"
                [style.background-color]="form.value.color_primario + '20'"
                [style.color]="form.value.color_primario"
              >
                Badge
              </span>
              <span
                class="preview-icon"
                [style.color]="form.value.color_primario"
              >
                <span class="material-symbols-outlined icon-filled">favorite</span>
              </span>
            </div>
          </div>
        </div>
      </div>

      @if (error()) {
        <div class="error-message">
          <span class="material-symbols-outlined">error</span>
          {{ error() }}
        </div>
      }

      <div class="dialog-actions">
        <button type="button" class="btn-secondary" (click)="cerrar.emit()">
          Cancelar
        </button>
        <button
          type="submit"
          class="btn-primary"
          [disabled]="form.invalid || loading()"
        >
          @if (loading()) {
            <span class="spinner"></span>
            Guardando...
          } @else {
            Guardar cambios
          }
        </button>
      </div>
    </form>
  </div>
</div>
