<div class="space-y-3 p-4">
  <!-- Errores de carga -->
  @if (loadError()) {
    <div class="text-sm text-red-600">
      {{ loadError() }}
    </div>
  }

  @if (pantallaCargarArchivo()) {
    <div
      class="cursor-pointer rounded-lg border border-dashed p-4 text-center"
      (click)="openFilePicker()"
      (drop)="onDrop($event)"
      (dragover)="onDragOver($event)"
      aria-label="Seleccionar o arrastrar una imagen"
    >
      <input
        #fileInput
        type="file"
        accept="image/*"
        class="hidden"
        (change)="onFileSelected($event)"
      />
      <div class="flex flex-col items-center gap-2">
        <span class="material-symbols-outlined text-3xl text-gray-400">upload</span>
        <div class="text-sm">
          Haz clic para seleccionar una imagen o arrástrala aquí
        </div>
      </div>
    </div>
  } @else {
    <!-- Cropper -->
    @if (
      (imageURL || imageChangedEvent || imageFile) &&
      (!data.precargar || archivoPrecargado())
    ) {
      <!-- Controles -->
      <div class="flex flex-wrap items-center justify-center gap-2">
        <button
          type="button"
          class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-100 text-gray-600 transition-colors hover:bg-gray-200"
          (click)="zoomOut()"
        >
          <span class="material-symbols-outlined">zoom_out</span>
        </button>
        <button
          type="button"
          class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-100 text-gray-600 transition-colors hover:bg-gray-200"
          (click)="zoomIn()"
        >
          <span class="material-symbols-outlined">zoom_in</span>
        </button>
        <button
          type="button"
          class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-100 text-gray-600 transition-colors hover:bg-gray-200"
          (click)="rotateLeft()"
        >
          <span class="material-symbols-outlined">rotate_left</span>
        </button>
        <button
          type="button"
          class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-100 text-gray-600 transition-colors hover:bg-gray-200"
          (click)="rotateRight()"
        >
          <span class="material-symbols-outlined">rotate_right</span>
        </button>
        <button
          type="button"
          class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-100 text-gray-600 transition-colors hover:bg-gray-200"
          (click)="toggleFlipH()"
        >
          <span class="material-symbols-outlined">swap_horiz</span>
        </button>
        <button
          type="button"
          class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-100 text-gray-600 transition-colors hover:bg-gray-200"
          (click)="toggleFlipV()"
        >
          <span class="material-symbols-outlined">swap_vert</span>
        </button>

        <button
          type="button"
          class="flex h-10 items-center justify-center gap-2 rounded-xl border border-gray-300 bg-white px-4 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50"
          (click)="pantallaCargarArchivo.set(true)"
        >
          <span class="material-symbols-outlined text-lg">upload</span>
          Cargar
        </button>
      </div>

      <div
        class="relative mx-auto mt-2 mb-2 aspect-square max-h-96 overflow-hidden rounded-lg border"
      >
        <image-cropper
          [imageURL]="imageURL || undefined"
          [imageFile]="imageFile ?? undefined"
          [imageChangedEvent]="imageChangedEvent"
          [maintainAspectRatio]="true"
          [aspectRatio]="1"
          [resizeToWidth]="data.resizeToWidth"
          [transform]="transform"
          [roundCropper]="true"
          [onlyScaleDown]="true"
          [alignImage]="'center'"
          [containWithinAspectRatio]="true"
          [format]="data.format"
          [output]="'blob'"
          [imageQuality]="data.quality"
          (cropperReady)="onCropperReady()"
          (loadImageFailed)="onLoadImageFailed()"
          (imageCropped)="onCropped($event)"
          class="relative z-10 block h-full w-full"
        >
        </image-cropper>
      </div>
    }
  }
  <!-- Preview recortado -->
  @if (croppedBase64()) {
    <div class="mt-2 flex items-center gap-3">
      <img
        [src]="croppedBase64()!"
        alt="preview"
        class="h-16 w-16 rounded-full border object-cover"
      />
      <div class="text-xs text-gray-500">Vista previa del recorte</div>
    </div>
  }
</div>

<div class="flex justify-end gap-2 border-t border-zinc-200 px-4 py-3">
  <button
    type="button"
    class="flex h-10 items-center justify-center rounded-xl border border-gray-300 bg-white px-4 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50"
    (click)="cancelar()"
  >
    Cancelar
  </button>
  <button
    type="button"
    class="flex h-10 items-center justify-center rounded-xl bg-primary px-6 text-sm font-semibold text-white transition-colors hover:bg-primary/90"
    (click)="guardar()"
  >
    Guardar
  </button>
</div>
