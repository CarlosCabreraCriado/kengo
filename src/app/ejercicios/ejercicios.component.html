<section class="absolute top-20 w-full">
  <div class="fuente-kengo m-auto mt-4 text-center text-4xl">Ejercicios</div>
  <form
    class="mx-5 mt-4 max-w-7xl"
    [formGroup]="formularioFiltros"
    (ngSubmit)="$event.preventDefault()"
  >
    <div
      class="relative m-auto mt-2 flex h-fit w-fit items-center justify-center gap-2 rounded-full border-1 pr-3 pl-3"
    >
      <mat-form-field
        class="ff-compact my-2 w-full rounded-full"
        subscriptSizing="dynamic"
      >
        <input
          matInput
          formControlName="busqueda"
          placeholder="Buscar ejercicio..."
        />
        <button
          mat-icon-button
          matSuffix
          type="button"
          aria-label="Borrar búsqueda"
          (click)="formularioFiltros.get('busqueda')?.setValue('')"
        >
          <mat-icon class="material-symbols-outlined">close</mat-icon>
        </button>
      </mat-form-field>
      <button
        class=""
        matMiniFab
        [matMenuTriggerFor]="menuCategorias"
        aria-label="Example icon button with a delete icon"
      >
        <mat-icon class="material-symbols-outlined">filter_alt</mat-icon>
      </button>

      <mat-menu #menuCategorias="matMenu" xPosition="before" class="mt-5 w-96">
        <div mat-menu-content class="p-2" (click)="$event.stopPropagation()">
          <div class="flex items-center justify-between">
            <span class="fuente-kengo ml-2 text-xl">Categorías</span>
          </div>
          <mat-divider class="my-2"></mat-divider>

          @if (ejerciciosService.categoriasRes.isLoading()) {
            <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          } @else if (ejerciciosService.categoriasRes.error()) {
            <div class="text-sm text-red-600">Error cargando categorías</div>
          } @else {
            <!-- Lista multi-selección. No cierra el menú al clicar. -->
            <div (click)="$event.stopPropagation()">
              <mat-selection-list
                formControlName="categories"
                [multiple]="true"
                class="block max-h-64 overflow-auto"
              >
                @for (
                  cat of ejerciciosService.categoriasRes.value();
                  track cat.id_categoria
                ) {
                  <mat-list-option
                    [value]="cat.id_categoria"
                    [selected]="
                      isCatSelected(cat.id_categoria, categoriasSeleccionadas)
                    "
                  >
                    {{ cat.nombre_categoria }}
                  </mat-list-option>
                }
              </mat-selection-list>
            </div>
          }

          <mat-divider class="my-2"></mat-divider>
          <div class="flex justify-end gap-2">
            <button mat-button type="button" (click)="limpiarCategorias()">
              Limpiar
            </button>
            <button
              mat-flat-button
              color="primary"
              type="button"
              (click)="closeMenu()"
            >
              Aplicar
            </button>
          </div>
        </div>
      </mat-menu>
    </div>
  </form>

  <section>
    <!-- Estado + grid -->
    <section
      class="m-5 flex max-w-7xl flex-col gap-3 md:flex-row md:flex-wrap md:justify-start md:gap-0"
    >
      @if (ejerciciosService.listaEjerciciosRes.isLoading()) {
        <mat-spinner class="mx-auto my-12"></mat-spinner>
      } @else if (ejerciciosService.listaEjerciciosRes.error()) {
        <p class="text-sm text-red-600">Error cargando ejercicios</p>
      } @else {
        <section
          class="m-5 flex max-w-7xl flex-row flex-wrap justify-center gap-2 align-baseline md:justify-start md:gap-0"
        >
          @for (
            ejercicio of ejerciciosService.ejercicios();
            track ejercicio.id_ejercicio
          ) {
            <a
              [routerLink]="[
                '/inicio/detalle-ejercicio',
                ejercicio.id_ejercicio,
              ]"
              class="md:group block w-full md:relative md:block md:aspect-[1] md:md:w-1/3 md:max-w-xs md:overflow-hidden md:rounded-2xl md:p-2 md:sm:w-1/2 md:lg:w-1/4"
            >
              <!-- ===== Vista móvil: estilo lista ===== -->
              <div
                class="flex items-center gap-3 rounded-2xl bg-zinc-900/80 p-3 md:hidden"
              >
                <img
                  [src]="getAssetUrl(ejercicio.portada)"
                  alt="{{ ejercicio.nombre_ejercicio }}"
                  class="h-20 w-28 rounded-lg object-cover"
                />
                <div class="min-w-0 flex-1">
                  <p class="truncate text-base font-semibold text-white">
                    {{ ejercicio.nombre_ejercicio }}
                  </p>
                  <p class="mt-1 truncate text-xs text-zinc-300">
                    {{ ejercicio.categoria || "Sin categoría" }}
                  </p>
                </div>
                <img
                  src="../assets/icono-play.png"
                  class="h-6 opacity-40"
                  alt=""
                />
              </div>

              <!-- ===== Vista escritorio: tu tarjeta original ===== -->
              <div
                class="relative hidden h-full w-full overflow-hidden rounded-2xl bg-black md:block"
              >
                <img
                  [src]="getAssetUrl(ejercicio.portada)"
                  alt=""
                  class="absolute inset-0 min-h-full object-cover opacity-75 transition-opacity group-hover:opacity-50"
                />
                <div class="relative p-4 sm:p-6 lg:p-8">
                  <p class="text-xl font-bold text-white sm:text-2xl">
                    {{ ejercicio.nombre_ejercicio }}
                  </p>
                  <div>
                    <div
                      class="translate-y-8 transform opacity-0 transition-all group-hover:translate-y-0 group-hover:opacity-100"
                    >
                      <p class="text-sm text-white">
                        {{ ejercicio.descripcion }}
                      </p>
                    </div>
                  </div>
                </div>
                <img
                  src="../assets/icono-play.png"
                  class="pointer-events-none absolute top-1/2 left-1/2 z-10 w-1/3 -translate-x-1/2 -translate-y-1/2 transform opacity-20"
                  alt=""
                />
              </div>
            </a>
          }
        </section>

        <!-- Paginación -->
        @if (ejerciciosService.total() > 0) {
          <div class="my-4 flex items-center justify-center gap-2">
            <button
              matButton="filled"
              class="mx-2 rounded-md border px-2 py-1"
              (click)="paginaAnterior()"
              [disabled]="ejerciciosService.page() <= 1"
            >
              Anterior
            </button>
            <span class="text-sm text-zinc-700"
              ><span class="hidden sm:inline-block">Página </span>
              {{ ejerciciosService.page() }} de
              {{ ejerciciosService.totalPages() }}</span
            >
            <button
              matButton="filled"
              class="mx-2 rounded-md border px-2 py-1"
              (click)="siguientePagina()"
              [disabled]="
                ejerciciosService.page() >= ejerciciosService.totalPages()
              "
            >
              Siguiente
            </button>
          </div>
        }

        @if (ejerciciosService.ejercicios().length === 0) {
          <p class="text-md text-center text-gray-700">
            No se han encontrado ejercicios.
          </p>
        }
      }
    </section>
  </section>
</section>
