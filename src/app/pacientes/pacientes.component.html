<section class="flex flex-col w-full h-full overflow-y-auto pb-24 md:pb-6">
  <!-- Header con búsqueda (sticky) -->
  <header
    class="sticky top-0 z-40 mx-auto mb-6 bg-gradient-to-b from-white/95 via-white/90 to-transparent px-4 pt-4 pb-2 backdrop-blur-md"
  >
    <div class="mx-auto max-w-7xl">
      <!-- Título y acciones -->
      <div class="mb-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <button
            mat-icon-button
            class="!h-10 !w-10 shrink-0"
            aria-label="Volver al inicio"
            routerLink="/inicio"
          >
            <mat-icon class="material-symbols-outlined text-zinc-600"
              >arrow_back</mat-icon
            >
          </button>
          <div>
            <h1 class="text-xl font-bold text-zinc-800 sm:text-2xl">
              Mis Pacientes
            </h1>
            @if (pacientes().length > 0) {
              <p class="text-sm text-zinc-500">
                {{ pacientes().length }}
                {{ pacientes().length === 1 ? "paciente" : "pacientes" }}
              </p>
            }
          </div>
        </div>

        <!-- Botón añadir (visible en móvil como FAB, en desktop inline) -->
        <button
          mat-flat-button
          color="primary"
          class="hidden sm:flex"
          (click)="openAddPaciente()"
        >
          <mat-icon class="material-symbols-outlined">person_add</mat-icon>
          Nuevo paciente
        </button>
      </div>

      <!-- Barra de búsqueda -->
      <div class="search-bar relative flex items-center gap-2">
        <div class="relative flex-1">
          <mat-icon
            class="material-symbols-outlined !text-primary absolute top-1/2 left-3 z-10 -translate-y-1/2"
            >search</mat-icon
          >
          <input
            #buscador
            type="text"
            class="h-12 w-full rounded-xl border border-zinc-200/80 bg-white/70 pr-10 pl-10 text-zinc-700 shadow-sm backdrop-blur-sm transition-all placeholder:text-zinc-400 focus:border-[#e75c3e]/50 focus:ring-2 focus:ring-[#e75c3e]/20 focus:outline-none"
            placeholder="Buscar por nombre, email..."
            (input)="onBuscar(buscador.value)"
          />
          @if (buscador.value) {
            <button
              type="button"
              class="absolute top-1/2 right-2 -translate-y-1/2 rounded-full p-1 text-zinc-400 transition-colors hover:bg-zinc-100 hover:text-zinc-600"
              aria-label="Borrar búsqueda"
              (click)="buscador.value = ''; onBuscar('')"
            >
              <mat-icon class="material-symbols-outlined !text-xl"
                >close</mat-icon
              >
            </button>
          }
        </div>

        <!-- Botón recargar -->
        <button
          mat-icon-button
          class="!h-12 !w-12 shrink-0 rounded-xl border border-zinc-200/80 !bg-white/70 shadow-sm backdrop-blur-sm"
          aria-label="Recargar datos"
          (click)="reload()"
        >
          <mat-icon class="material-symbols-outlined text-zinc-600"
            >refresh</mat-icon
          >
        </button>
      </div>
    </div>
  </header>

  <!-- Contenido principal -->
  <div class="mx-auto max-w-7xl px-4">
    @if (pacientesRes.isLoading() && idsClinicas() !== null) {
      <div class="rounded-2xl bg-white/60 p-4 backdrop-blur-sm">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      </div>
    } @else if (pacientesRes.error()) {
      <div class="tarjeta-kengo rounded-2xl p-6 text-center">
        <mat-icon class="material-symbols-outlined mb-2 text-4xl text-red-400"
          >error</mat-icon
        >
        <p class="text-red-600">No se pudieron cargar los pacientes.</p>
      </div>
    } @else if (pacientes().length === 0) {
      <div class="tarjeta-kengo rounded-2xl p-8 text-center">
        <mat-icon class="material-symbols-outlined mb-3 text-5xl text-zinc-300"
          >group_off</mat-icon
        >
        <p class="text-lg text-zinc-500">No hay pacientes para mostrar</p>
        <button
          mat-flat-button
          color="primary"
          class="mt-4"
          (click)="openAddPaciente()"
        >
          <mat-icon>person_add</mat-icon>
          Añadir primer paciente
        </button>
      </div>
    } @else {
      <!-- Grid de Cards -->
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
        @for (p of pacientes(); track p.id) {
          <article
            class="tarjeta-kengo group relative cursor-pointer overflow-hidden rounded-2xl p-4 transition-all duration-200 hover:shadow-lg"
            (click)="verDetalle(p)"
          >
            <!-- Header con avatar e info -->
            <div class="flex items-start gap-4">
              <!-- Avatar y Magic Link -->
              <div class="flex shrink-0 flex-col items-center gap-1">
                @if (avatarUrl(p)) {
                  <img
                    [src]="avatarUrl(p)"
                    [alt]="fullName(p)"
                    class="h-14 w-14 rounded-full object-cover ring-2 shadow-sm ring-white"
                  />
                } @else {
                  <div
                    class="flex h-14 w-14 items-center justify-center rounded-full bg-gradient-to-br from-zinc-400 to-zinc-500 shadow-sm"
                  >
                    <mat-icon
                      class="material-symbols-outlined text-2xl !text-white"
                      aria-hidden="true"
                      >person</mat-icon
                    >
                  </div>
                }
                @if (p.magic_link_url) {
                  <button
                    mat-icon-button
                    class="!h-9 !w-9"
                    aria-label="Ver código QR"
                    (click)="openDialogoQR(p.magic_link_url); $event.stopPropagation()"
                  >
                    <mat-icon
                      class="material-symbols-outlined !text-2xl text-[#e75c3e]"
                      >qr_code_2</mat-icon
                    >
                  </button>
                }
              </div>

              <!-- Info del paciente -->
              <div class="min-w-0 flex-1">
                <div class="flex items-start justify-between gap-2">
                  <h3 class="truncate text-base font-semibold text-zinc-800">
                    {{ fullName(p) }}
                  </h3>
                  <!-- Botón Editar -->
                  <button
                    mat-icon-button
                    class="!-mt-1 !-mr-2 !h-8 !w-8 shrink-0"
                    aria-label="Editar paciente"
                    (click)="openEditarPaciente(p); $event.stopPropagation()"
                  >
                    <mat-icon
                      class="material-symbols-outlined !text-lg text-zinc-400"
                      >edit</mat-icon
                    >
                  </button>
                </div>

                @if (p.email) {
                  <p
                    class="mt-1 flex items-center gap-1.5 truncate text-sm text-zinc-500"
                  >
                    <mat-icon class="material-symbols-outlined !text-base"
                      >mail</mat-icon
                    >
                    {{ p.email }}
                  </p>
                }

                @if (p.telefono) {
                  <p
                    class="mt-0.5 flex items-center gap-1.5 text-sm text-zinc-500"
                  >
                    <mat-icon class="material-symbols-outlined !text-base"
                      >phone</mat-icon
                    >
                    {{ p.telefono }}
                  </p>
                }

                @if (getClinicaNombre(p)) {
                  <p
                    class="mt-0.5 flex items-center gap-1.5 text-sm text-zinc-500"
                  >
                    <mat-icon class="material-symbols-outlined !text-base"
                      >location_city</mat-icon
                    >
                    {{ getClinicaNombre(p) }}
                  </p>
                }
              </div>
            </div>

            <!-- Acciones principales -->
            <div
              class="mt-4 flex items-center justify-end gap-2 border-t border-zinc-400 pt-3"
            >
              <!-- Crear Plan (acción principal) -->
              <button
                mat-flat-button
                color="primary"
                class="!h-8 !min-w-0 !px-3 !text-xs"
                (click)="seleccionarPaciente(p); $event.stopPropagation()"
              >
                <mat-icon class="material-symbols-outlined !text-base"
                  >add_circle</mat-icon
                >
                Crear plan
              </button>

              <!-- Ver Planes -->
              <button
                mat-stroked-button
                class="!h-8 !min-w-0 !px-3 !text-xs"
                (click)="verPlanes(p); $event.stopPropagation()"
              >
                <mat-icon
                  class="material-symbols-outlined !text-base text-zinc-600"
                  >assignment</mat-icon
                >
                <span class="text-zinc-600">Ver planes</span>
              </button>
            </div>
          </article>
        }
      </div>
    }
  </div>
</section>
