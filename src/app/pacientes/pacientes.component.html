<section class="absolute top-20 w-full px-4 pb-32">
  <!-- Header con búsqueda -->
  <header class="mx-auto mt-4 max-w-7xl">
    <div
      class="relative mx-auto mb-6 flex h-fit max-w-lg items-center justify-center gap-2 rounded-full border border-zinc-200/50 bg-white/60 px-3 shadow-sm backdrop-blur-sm"
    >
      <mat-form-field
        class="ff-compact my-2 w-full rounded-full"
        subscriptSizing="dynamic"
      >
        <input
          #buscador
          matInput
          placeholder="Buscar paciente..."
          (input)="onBuscar(buscador.value)"
        />
        <button
          mat-icon-button
          matSuffix
          type="button"
          aria-label="Borrar búsqueda"
          (click)="buscador.value = ''; onBuscar('')"
        >
          <mat-icon class="material-symbols-outlined">close</mat-icon>
        </button>
      </mat-form-field>

      <button
        mat-mini-fab
        class="!bg-white/80 !shadow-sm"
        aria-label="Recargar datos"
        (click)="reload()"
      >
        <mat-icon class="material-symbols-outlined text-zinc-600">refresh</mat-icon>
      </button>

      <button
        mat-mini-fab
        color="primary"
        type="button"
        aria-label="Añadir paciente"
        (click)="openAddPaciente()"
      >
        <mat-icon>person_add</mat-icon>
      </button>
    </div>
  </header>

  <!-- Contenido principal -->
  <div class="mx-auto max-w-7xl">
    @if (pacientesRes.isLoading() && idsClinicas() != null) {
      <div class="rounded-2xl bg-white/60 p-4 backdrop-blur-sm">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      </div>
    } @else if (pacientesRes.error()) {
      <div class="tarjeta-kengo rounded-2xl p-6 text-center">
        <mat-icon class="material-symbols-outlined mb-2 text-4xl text-red-400">error</mat-icon>
        <p class="text-red-600">No se pudieron cargar los pacientes.</p>
      </div>
    } @else if (pacientes().length === 0) {
      <div class="tarjeta-kengo rounded-2xl p-8 text-center">
        <mat-icon class="material-symbols-outlined mb-3 text-5xl text-zinc-300">group_off</mat-icon>
        <p class="text-lg text-zinc-500">No hay pacientes para mostrar</p>
        <button
          mat-flat-button
          color="primary"
          class="mt-4"
          (click)="openAddPaciente()"
        >
          <mat-icon>person_add</mat-icon>
          Añadir primer paciente
        </button>
      </div>
    } @else {
      <!-- Grid de Cards -->
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
        @for (p of pacientes(); track p.id) {
          <article
            class="tarjeta-kengo group relative overflow-hidden rounded-2xl p-4 transition-all duration-200 hover:shadow-lg"
          >
            <!-- Contenido principal de la card -->
            <div class="flex items-start gap-4">
              <!-- Avatar -->
              <div class="shrink-0">
                @if (avatarUrl(p)) {
                  <img
                    [src]="avatarUrl(p)"
                    [alt]="fullName(p)"
                    class="h-14 w-14 rounded-full object-cover ring-2 ring-white shadow-sm"
                  />
                } @else {
                  <div
                    class="flex h-14 w-14 items-center justify-center rounded-full bg-gradient-to-br from-zinc-400 to-zinc-500 shadow-sm"
                  >
                    <mat-icon
                      class="material-symbols-outlined text-2xl !text-white"
                      aria-hidden="true"
                    >person</mat-icon>
                  </div>
                }
              </div>

              <!-- Info del paciente -->
              <div class="min-w-0 flex-1">
                <h3 class="truncate text-base font-semibold text-zinc-800">
                  {{ fullName(p) }}
                </h3>

                @if (p.email) {
                  <p class="mt-1 flex items-center gap-1.5 truncate text-sm text-zinc-500">
                    <mat-icon class="material-symbols-outlined !text-base">mail</mat-icon>
                    {{ p.email }}
                  </p>
                }

                @if (p.telefono) {
                  <p class="mt-0.5 flex items-center gap-1.5 text-sm text-zinc-500">
                    <mat-icon class="material-symbols-outlined !text-base">phone</mat-icon>
                    {{ p.telefono }}
                  </p>
                }
              </div>
            </div>

            <!-- Acciones -->
            <div class="mt-4 flex items-center justify-end gap-1 border-t border-zinc-100 pt-3">
              <button
                mat-icon-button
                class="!h-10 !w-10"
                color="primary"
                aria-label="Asignar ejercicios"
                (click)="seleccionarPaciente(p)"
              >
                <mat-icon class="material-symbols-outlined">exercise</mat-icon>
              </button>

              <button
                mat-icon-button
                class="!h-10 !w-10"
                color="primary"
                aria-label="Editar paciente"
                (click)="openEditarPaciente(p)"
              >
                <mat-icon class="material-symbols-outlined">edit</mat-icon>
              </button>

              @if (p.magic_link_url) {
                <button
                  mat-icon-button
                  class="!h-10 !w-10"
                  color="primary"
                  aria-label="Ver código QR"
                  (click)="openDialogoQR(p.magic_link_url)"
                >
                  <mat-icon class="material-symbols-outlined">qr_code_scanner</mat-icon>
                </button>
              }
            </div>
          </article>
        }
      </div>
    }
  </div>
</section>
