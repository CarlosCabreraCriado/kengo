<section class="flex flex-col w-full h-full overflow-y-auto pb-24 lg:pb-6">
  <!-- Header sticky -->
  <header
    class="sticky top-0 z-40 mx-auto mb-6 px-4 pt-4 pb-2 w-full"
    [class]="isDesktop() ? '' : 'bg-gradient-to-b from-white/95 via-white/90 to-transparent backdrop-blur-md'"
  >
    <div class="mx-auto max-w-7xl">
      @if (isDesktop()) {
        <!-- Header simplificado para desktop: búsqueda + nuevo plan + filtros centrados -->
        <div class="flex items-center justify-center gap-3">
          <!-- Barra de búsqueda -->
          <div class="relative w-full max-w-md">
            <mat-icon
              class="material-symbols-outlined !text-primary absolute top-1/2 left-3 z-10 -translate-y-1/2"
            >search</mat-icon>
            <input
              #buscadorDesktop
              type="text"
              class="h-12 w-full rounded-xl border border-zinc-200/80 bg-white/70 pr-10 pl-10 text-zinc-700 shadow-sm backdrop-blur-sm transition-all placeholder:text-zinc-400 focus:border-[#e75c3e]/50 focus:ring-2 focus:ring-[#e75c3e]/20 focus:outline-none"
              placeholder="Buscar por título o paciente..."
              [value]="busqueda"
              (input)="onBusquedaChange(buscadorDesktop.value)"
            />
            @if (busqueda) {
              <button
                type="button"
                class="absolute top-1/2 right-2 -translate-y-1/2 rounded-full p-1 text-zinc-400 transition-colors hover:bg-zinc-100 hover:text-zinc-600"
                aria-label="Borrar búsqueda"
                (click)="buscadorDesktop.value = ''; onBusquedaChange('')"
              >
                <mat-icon class="material-symbols-outlined !text-xl">close</mat-icon>
              </button>
            }
          </div>

          <!-- Botón nuevo plan -->
          <button
            mat-flat-button
            color="primary"
            class="!h-12 shrink-0"
            (click)="crearNuevoPlan()"
          >
            <mat-icon class="material-symbols-outlined">add</mat-icon>
            Nuevo plan
          </button>

          <!-- Botón filtro de estado -->
          <button
            mat-icon-button
            [matMenuTriggerFor]="menuEstado"
            class="!h-12 !w-12 shrink-0 rounded-xl border border-zinc-200/80 !bg-white/70 shadow-sm backdrop-blur-sm"
            [class.!border-primary]="filtroEstado !== 'todos'"
            aria-label="Filtrar por estado"
          >
            <mat-icon class="material-symbols-outlined text-zinc-600">filter_alt</mat-icon>
          </button>

          <!-- Botón recargar -->
          <button
            mat-icon-button
            class="!h-12 !w-12 shrink-0 rounded-xl border border-zinc-200/80 !bg-white/70 shadow-sm backdrop-blur-sm"
            aria-label="Recargar datos"
            (click)="reload()"
          >
            <mat-icon class="material-symbols-outlined text-zinc-600">refresh</mat-icon>
          </button>

          <mat-menu #menuEstado="matMenu" xPosition="before" class="mt-2">
            <button mat-menu-item (click)="onFiltroEstadoChange('todos')">
              <mat-icon class="material-symbols-outlined">list</mat-icon>
              <span>Todos</span>
            </button>
            <button mat-menu-item (click)="onFiltroEstadoChange('activo')">
              <mat-icon class="material-symbols-outlined text-green-600">play_arrow</mat-icon>
              <span>Activos</span>
            </button>
            <button mat-menu-item (click)="onFiltroEstadoChange('completado')">
              <mat-icon class="material-symbols-outlined text-blue-600">check_circle</mat-icon>
              <span>Completados</span>
            </button>
            <button mat-menu-item (click)="onFiltroEstadoChange('borrador')">
              <mat-icon class="material-symbols-outlined text-zinc-500">edit_note</mat-icon>
              <span>Borradores</span>
            </button>
            <button mat-menu-item (click)="onFiltroEstadoChange('cancelado')">
              <mat-icon class="material-symbols-outlined text-red-600">cancel</mat-icon>
              <span>Cancelados</span>
            </button>
          </mat-menu>
        </div>
      } @else {
        <!-- Header completo para móvil -->
        <!-- Título y acciones -->
        <div class="mb-4 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <button
              mat-icon-button
              class="!h-10 !w-10 shrink-0"
              aria-label="Volver al inicio"
              routerLink="/inicio"
            >
              <mat-icon class="material-symbols-outlined text-zinc-600">arrow_back</mat-icon>
            </button>
            <div>
              <h1 class="text-xl font-bold text-zinc-800 sm:text-2xl">
                Mis Planes
              </h1>
              @if (total() > 0) {
                <p class="text-sm text-zinc-500">
                  {{ total() }} {{ total() === 1 ? 'plan' : 'planes' }}
                </p>
              }
            </div>
          </div>

          <!-- Botón nuevo plan -->
          <button
            mat-flat-button
            color="primary"
            class="hidden sm:flex"
            (click)="crearNuevoPlan()"
          >
            <mat-icon class="material-symbols-outlined">add</mat-icon>
            Nuevo plan
          </button>
        </div>

        <!-- Barra de búsqueda -->
        <div class="relative flex items-center gap-2">
          <div class="relative flex-1">
            <mat-icon
              class="material-symbols-outlined !text-primary absolute top-1/2 left-3 z-10 -translate-y-1/2"
            >search</mat-icon>
            <input
              #buscador
              type="text"
              class="h-12 w-full rounded-xl border border-zinc-200/80 bg-white/70 pr-10 pl-10 text-zinc-700 shadow-sm backdrop-blur-sm transition-all placeholder:text-zinc-400 focus:border-[#e75c3e]/50 focus:ring-2 focus:ring-[#e75c3e]/20 focus:outline-none"
              placeholder="Buscar por título o paciente..."
              [value]="busqueda"
              (input)="onBusquedaChange(buscador.value)"
            />
            @if (busqueda) {
              <button
                type="button"
                class="absolute top-1/2 right-2 -translate-y-1/2 rounded-full p-1 text-zinc-400 transition-colors hover:bg-zinc-100 hover:text-zinc-600"
                aria-label="Borrar búsqueda"
                (click)="buscador.value = ''; onBusquedaChange('')"
              >
                <mat-icon class="material-symbols-outlined !text-xl">close</mat-icon>
              </button>
            }
          </div>

          <!-- Botón filtro de estado -->
          <button
            mat-icon-button
            [matMenuTriggerFor]="menuEstadoMobile"
            class="!h-12 !w-12 shrink-0 rounded-xl border border-zinc-200/80 !bg-white/70 shadow-sm backdrop-blur-sm"
            [class.!border-primary]="filtroEstado !== 'todos'"
            aria-label="Filtrar por estado"
          >
            <mat-icon class="material-symbols-outlined text-zinc-600">filter_alt</mat-icon>
          </button>

          <!-- Botón recargar -->
          <button
            mat-icon-button
            class="!h-12 !w-12 shrink-0 rounded-xl border border-zinc-200/80 !bg-white/70 shadow-sm backdrop-blur-sm"
            aria-label="Recargar datos"
            (click)="reload()"
          >
            <mat-icon class="material-symbols-outlined text-zinc-600">refresh</mat-icon>
          </button>

          <mat-menu #menuEstadoMobile="matMenu" xPosition="before" class="mt-2">
            <button mat-menu-item (click)="onFiltroEstadoChange('todos')">
              <mat-icon class="material-symbols-outlined">list</mat-icon>
              <span>Todos</span>
            </button>
            <button mat-menu-item (click)="onFiltroEstadoChange('activo')">
              <mat-icon class="material-symbols-outlined text-green-600">play_arrow</mat-icon>
              <span>Activos</span>
            </button>
            <button mat-menu-item (click)="onFiltroEstadoChange('completado')">
              <mat-icon class="material-symbols-outlined text-blue-600">check_circle</mat-icon>
              <span>Completados</span>
            </button>
            <button mat-menu-item (click)="onFiltroEstadoChange('borrador')">
              <mat-icon class="material-symbols-outlined text-zinc-500">edit_note</mat-icon>
              <span>Borradores</span>
            </button>
            <button mat-menu-item (click)="onFiltroEstadoChange('cancelado')">
              <mat-icon class="material-symbols-outlined text-red-600">cancel</mat-icon>
              <span>Cancelados</span>
            </button>
          </mat-menu>
        </div>
      }
    </div>
  </header>

  <!-- Contenido principal -->
  <div class="mx-auto max-w-7xl px-4">
    @if (isLoading()) {
      <div class="rounded-2xl bg-white/60 p-4 backdrop-blur-sm">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      </div>
    } @else if (planes().length === 0) {
      <div class="tarjeta-kengo rounded-2xl p-8 text-center">
        <mat-icon class="material-symbols-outlined mb-3 text-5xl text-zinc-300">assignment</mat-icon>
        <p class="text-lg text-zinc-500">No se encontraron planes</p>
        <button
          mat-flat-button
          color="primary"
          class="mt-4"
          (click)="crearNuevoPlan()"
        >
          <mat-icon class="material-symbols-outlined">add</mat-icon>
          Crear primer plan
        </button>
      </div>
    } @else {
      <!-- Grid de planes -->
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
        @for (plan of planes(); track plan.id_plan) {
          <article
            class="tarjeta-kengo group relative overflow-hidden rounded-2xl p-4 transition-all duration-200 hover:shadow-lg"
          >
            <!-- Contenido principal -->
            <div class="flex items-start gap-4">
              <!-- Avatar paciente -->
              <div class="shrink-0">
                @if (getPacienteAvatar(plan)) {
                  <img
                    [src]="avatarUrl(getPacienteAvatar(plan))"
                    [alt]="getPacienteNombre(plan)"
                    class="h-14 w-14 rounded-full object-cover ring-2 shadow-sm ring-white"
                  />
                } @else {
                  <div
                    class="flex h-14 w-14 items-center justify-center rounded-full bg-gradient-to-br from-zinc-400 to-zinc-500 shadow-sm"
                  >
                    <mat-icon class="material-symbols-outlined text-2xl !text-white">person</mat-icon>
                  </div>
                }
              </div>

              <!-- Info del plan -->
              <div class="min-w-0 flex-1">
                <div class="flex items-start justify-between gap-2">
                  <h3 class="truncate text-base font-semibold text-zinc-800">
                    {{ plan.titulo }}
                  </h3>
                  <span
                    class="shrink-0 rounded-full px-2 py-0.5 text-xs font-medium"
                    [ngClass]="estadoColors[plan.estado]"
                  >
                    {{ estadoLabels[plan.estado] }}
                  </span>
                </div>

                <p class="mt-0.5 flex items-center gap-1.5 text-sm text-zinc-500">
                  <mat-icon class="material-symbols-outlined !text-base">person</mat-icon>
                  {{ getPacienteNombre(plan) }}
                </p>

                @if (plan.fecha_inicio || plan.fecha_fin) {
                  <p class="mt-0.5 flex items-center gap-1.5 text-sm text-zinc-500">
                    <mat-icon class="material-symbols-outlined !text-base">calendar_today</mat-icon>
                    {{ formatDate(plan.fecha_inicio) }}
                    @if (plan.fecha_fin) {
                      - {{ formatDate(plan.fecha_fin) }}
                    }
                  </p>
                }
              </div>
            </div>

            <!-- Acciones -->
            <div class="mt-4 flex items-center justify-end gap-1 border-t border-zinc-100 pt-3">
              <button
                mat-icon-button
                class="!h-10 !w-10"
                color="primary"
                aria-label="Ver resumen"
                (click)="verResumen(plan)"
              >
                <mat-icon class="material-symbols-outlined">visibility</mat-icon>
              </button>

              <button
                mat-icon-button
                class="!h-10 !w-10"
                color="primary"
                aria-label="Editar plan"
                (click)="editarPlan(plan)"
              >
                <mat-icon class="material-symbols-outlined">edit</mat-icon>
              </button>

              <button
                mat-icon-button
                class="!h-10 !w-10"
                [matMenuTriggerFor]="menuEstadoPlan"
                aria-label="Cambiar estado"
              >
                <mat-icon class="material-symbols-outlined text-zinc-600">more_vert</mat-icon>
              </button>

              <mat-menu #menuEstadoPlan="matMenu">
                @if (plan.estado !== 'activo') {
                  <button mat-menu-item (click)="cambiarEstado(plan, 'activo')">
                    <mat-icon class="material-symbols-outlined text-green-600">play_arrow</mat-icon>
                    <span>Marcar activo</span>
                  </button>
                }
                @if (plan.estado !== 'completado') {
                  <button mat-menu-item (click)="cambiarEstado(plan, 'completado')">
                    <mat-icon class="material-symbols-outlined text-blue-600">check_circle</mat-icon>
                    <span>Marcar completado</span>
                  </button>
                }
                @if (plan.estado !== 'cancelado') {
                  <button mat-menu-item (click)="cambiarEstado(plan, 'cancelado')">
                    <mat-icon class="material-symbols-outlined text-red-600">cancel</mat-icon>
                    <span>Cancelar plan</span>
                  </button>
                }
              </mat-menu>
            </div>
          </article>
        }
      </div>
    }
  </div>
</section>
